# 架构设计

## 三层组件架构

| 层次 | 核心组件 | 主要职责 |
|------|----------|----------|
| **L1: 报告入口层** | `CreditRPPreviewComp`, `DDRPPreviewComp` | 数据与配置的整合者，作为对外唯一入口 |
| **L2: 通用布局层** | `RPPreviewComp`, `PreviewReportLeft`, `PreviewReportContent` | 界面骨架与协调者，搭建布局和交互 |
| **L3: 基础渲染层** | `ConfigTable`, `SectionHeading`, `HorizontalTable` | 配置执行者，根据配置渲染具体内容 |

## 各层职责

### L1: 报告入口层
- 数据获取：并发获取公司基础信息、财务数据等
- 状态管理：创建和初始化主 Context 状态
- 配置整合：整合套餐信息和报告配置
- 组件组合：将下层组件组合成完整界面

### L2: 通用布局层
- 布局管理：搭建三段式布局（左侧导航 + 右侧内容）
- 事件协调：处理组件间的事件传递和状态同步
- 数据分发：通过 Context 向子组件提供共享数据
- 交互控制：管理缩放、滚动等全局交互

### L3: 基础渲染层
- 配置解析：将 JSON 配置转换为组件属性
- 动态渲染：根据配置选择合适的渲染组件
- 数据获取：管理具体的数据请求和缓存
- 错误处理：处理加载失败和数据异常

## Context 状态管理

### 双层 Context 架构

**主 Context (RPPreviewCtx)**
- 管理全局业务状态
- 包含公司数据、报告配置、套餐信息
- 提供工具函数和加载状态跟踪

**内容 Context (PreviewReportContentCtx)**
- 管理渲染相关状态
- 包含扁平化配置、节点数据存储、隐藏状态
- 提供数据更新、获取、清理方法

### 数据流转

1. 应用层调用入口组件
2. 入口组件从 API 获取业务数据
3. 数据注入到主 Context
4. 布局组件获取配置和状态
5. 渲染组件请求具体数据
6. Context 返回处理后的数据
7. 渲染组件返回最终界面

### 缓存策略
- **公司数据**: L1层获取，全局共享
- **表格数据**: L3层按需获取，节点级缓存
- **翻译数据**: 异步翻译，结果缓存

## 表格渲染架构

### 渲染流程
1. 配置解析器处理表格配置
2. 根据类型选择对应表格组件
3. 生成列配置和数据转换
4. 根据渲染类型分发渲染器
5. 渲染器处理具体数据格式

### 渲染器分类
- **基础渲染器**: 文本、日期、金额等通用类型
- **自定义渲染器**: 股东名称、股权变动等业务类型
- **特殊渲染器**: 日期范围、图片等复杂类型

### 表格类型
- **水平表格**: 适用于横向数据展示
- **垂直表格**: 适用于键值对数据
- **交叉表格**: 适用于复杂行列交叉数据

## 组件间通信

### 关键通信场景
1. **节点选择联动**: 左侧导航点击 → 右侧内容滚动定位
2. **缩放控制**: 缩放条调整 → 内容区域缩放应用
3. **节点可见性**: 树节点显示/隐藏 → 内容区域动态更新
4. **搜索过滤**: 搜索输入 → 导航树实时过滤

### 事件处理机制
- 用户交互触发相应的事件处理函数
- 事件处理函数更新 Context 状态
- 状态更新触发组件重新渲染
- 最终更新 DOM 完成交互反馈

## 设计模式

### 容器组件与展示组件分离
- **容器组件**: 负责数据获取、状态管理、业务逻辑
- **展示组件**: 负责 UI 渲染，接收 props 并展示界面

### 配置驱动渲染
- 通过 JSON 配置控制 UI 结构和内容
- 支持动态配置和运行时修改
- 高度可扩展和可定制

### Context 数据共享
- 使用 React Context 在组件树中共享数据
- 避免 props drilling，简化组件通信
- 集中管理全局状态

### 插件化渲染器
- 支持多种渲染器类型
- 易于扩展新的渲染逻辑
- 统一的渲染器接口

### 错误边界和降级处理
- 组件级错误捕获
- 优雅的降级处理
- 完整的错误日志记录

## 相关文档

- [技术实现](./technical-implementation.md) - 核心技术实现细节
- [组件参考](./components-reference.md) - 组件API参考
- [使用指南](./usage.md) - 快速上手指南
- [示例文档](./examples.md) - 使用示例