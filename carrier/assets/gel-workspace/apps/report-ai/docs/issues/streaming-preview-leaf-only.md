# useStreamingPreview 应仅处理叶子章节

## 问题概览

| 字段         | 内容                                                         |
| ------------ | ------------------------------------------------------------ |
| 问题         | useStreamingPreview 处理所有章节，但只有叶子章节需要流式输出 |
| 状态         | 🚧 进行中                                                    |
| 优先级       | 🟡 P1                                                        |
| 责任人       | -                                                            |
| 发现时间     | 2025-10-22                                                   |
| 预期解决时间 | 2025-10-25                                                   |

## 背景与预期

报告章节采用树形结构，AI 生成内容时只会为叶子章节生成实际内容，父章节仅作为结构容器。

## 问题陈述

### 现象

1. **父章节被错误处理**：`useStreamingPreview` 会获取所有状态为 `receiving`/`pending`/`finish` 的章节并尝试更新内容，包括父章节
2. **单章节开始生成时未清空原内容**：当重新生成单个章节时，旧内容未被清空，导致流式内容追加到旧内容后
3. **流式开始时错误写入 canonical 内容**：流式预览开始阶段，将临时内容错误地写入 canonical 状态，污染正式数据

### 根因

1. **叶子节点判断缺失**：`useStreamingPreview.ts:48-52` 的过滤逻辑只检查状态，未判断章节是否为叶子节点（来源：代码审查）
2. **章节内容未初始化**：单章节生成开始时，未执行清空操作（来源：待定位具体代码位置）
3. **状态写入时机错误**：流式开始时将预览内容错误写入 canonical，而非仅更新 preview 字段（来源：待定位具体代码位置）

### 影响

- **功能异常**：单章节重新生成时出现内容重复，用户体验差
- **数据污染**：canonical 内容被临时流式数据覆盖，可能导致保存错误数据
- **性能浪费**：对父章节执行无效的 DOM 操作（约 25% 性能损失）
- **去重器污染**：父章节空内容被缓存，占用内存
- **日志噪音**：debug 模式输出父章节更新日志

## 关键参考

| 文档/代码路径                                            | 作用                  | 备注               |
| -------------------------------------------------------- | --------------------- | ------------------ |
| `hooks/rehydration/useStreamingPreview.ts:48-52`         | 章节过滤逻辑          | 缺少叶子节点判断   |
| `packages/gel-api/src/chat/types/report/detail.ts:14-31` | RPDetailChapter 定义  | 支持 children 属性 |
| `domain/chapter/query.ts:46-57`                          | getAllChapterIds 实现 | 递归遍历所有章节   |

## 解决方案

### 方案要点

1. **修复父章节过滤**：添加 `isLeafChapter` 工具函数判断叶子节点，修改 `useStreamingPreview` 过滤逻辑（预计 0.5 天）
2. **修复内容初始化**：在单章节生成开始时添加内容清空逻辑，确保流式内容不追加到旧内容（预计 0.5 天）
3. **修复状态写入分离**：明确区分 preview 和 canonical 状态，流式阶段仅更新 preview，生成完成后才写入 canonical（预计 1 天）
4. **可选优化**：在 selector 层面直接过滤父章节（预计 1 天）

### 备选方案

在 Redux 层面不存储父章节的 status/content - 放弃理由：影响范围大，风险较高

### 待办事项

- [ ] 定位并审查单章节生成开始时的处理逻辑
- [ ] 定位并审查流式状态写入的代码位置
- [ ] 实现 `isLeafChapter` 工具函数
- [ ] 修改 `useStreamingPreview` 过滤逻辑，排除父章节
- [ ] 添加章节生成开始时的内容清空逻辑
- [ ] 修复流式预览状态写入，确保 preview/canonical 分离
- [ ] 添加单元测试覆盖叶子/父章节场景
- [ ] 添加单元测试覆盖内容清空和状态分离场景
- [ ] 验证流式预览功能正常
- [ ] 验证单章节重新生成功能正常
- [ ] 检查性能改善

## 验证与风险

### 验证步骤

1. **父章节过滤验证**：创建包含多层级章节的报告（如 1 -> 1.1 -> 1.1.1），触发全文生成，观察流式预览是否只更新叶子章节
2. **父章节过滤日志验证**：检查 debug 日志，确认 `activeChapterIds` 不包含父章节
3. **单章节内容清空验证**：选择已有内容的章节，触发重新生成，确认旧内容被清空后才开始流式输出
4. **状态分离验证**：在流式生成过程中检查 Redux 状态，确认 preview 字段更新而 canonical 保持不变
5. **完成后状态验证**：流式生成完成后，确认 canonical 被正确更新为最终内容

### 剩余风险

- 运行时动态添加/删除子章节需重新判断叶子状态
- 空 `children` 数组应视为叶子节点，需明确处理
- 流式中断或异常时，preview/canonical 状态同步可能出现不一致
- 并发生成多个章节时，状态更新顺序需确保正确

## 更新日志

| 日期       | 事件 | 描述                                                   |
| ---------- | ---- | ------------------------------------------------------ |
| 2025-10-22 | 创建 | 初始创建，识别叶子章节过滤缺失问题                     |
| 2025-10-23 | 更新 | 新增问题：单章节生成时未清空内容、流式错误写入 canonical |

## 附录

性能影响估算（假设 20 个章节，5 个父章节）：

- 修复前：每次流式更新 20 次 DOM 操作
- 修复后：每次流式更新 15 次 DOM 操作
- 性能提升：约 25%
