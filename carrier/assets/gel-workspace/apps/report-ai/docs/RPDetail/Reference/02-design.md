# å¼•ç”¨èµ„æ–™æ¨¡å— - å‰ç«¯è®¾è®¡æ–‡æ¡£

> å‚è€ƒè§„èŒƒï¼š`docs/rule/design-doc.md`

## ğŸ“‚ ä»£ç å…³è”

| åŠŸèƒ½æ¨¡å—         | ä»£ç ä½ç½®                                   | è¯´æ˜                             |
| ---------------- | ------------------------------------------ | -------------------------------- |
| **å¼•ç”¨èµ„æ–™ç»„ä»¶** | `../../src/components/Reference/`          | èµ„æ–™åˆ—è¡¨ã€é¢„è§ˆã€æ–‡ä»¶é¡¹ç­‰é€šç”¨ç»„ä»¶ |
| **é¡µé¢é›†æˆ**     | `../../src/pages/RPDetail/Reference/`      | æŠ¥å‘Šè¯¦æƒ…é¡µä¸­çš„å¼•ç”¨èµ„æ–™é¢æ¿       |
| **PDF æŸ¥çœ‹å™¨**   | `../../src/components/File/PDFViewer/`     | PDF æ–‡æ¡£é¢„è§ˆç»„ä»¶                 |
| **æ•°æ®ç®¡ç†**     | `../../src/domain/reportEditor/reference/` | å¼•ç”¨èµ„æ–™æ•°æ®å¤„ç†ä¸æ’åº           |
| **Redux Store**  | `../../src/store/reportEditor/`            | æŠ¥å‘Šç¼–è¾‘å™¨çŠ¶æ€ç®¡ç†               |

> ä»£ç å˜æ›´æ—¶è¯·åŒæ­¥æ›´æ–°æœ¬æ–‡æ¡£

## ğŸ§­ è®¾è®¡æ¦‚è§ˆ

### åŠŸèƒ½èŒƒå›´ä¸è¾¹ç•Œ

å¼•ç”¨èµ„æ–™æ¨¡å—è´Ÿè´£å±•ç¤ºå’Œç®¡ç†æŠ¥å‘Šä¸­æ‰€æœ‰å¼•ç”¨çš„èµ„æ–™ï¼ˆæ•°æ®è¡¨æ ¼ã€å»ºè®®èµ„æ–™ã€æ–‡ä»¶ï¼‰ï¼Œæä¾›ç»Ÿä¸€çš„åˆ—è¡¨è§†å›¾å’Œé¢„è§ˆåŠŸèƒ½ï¼Œæ”¯æŒæ–‡ä»¶ä¸Šä¼ å’Œåˆ é™¤ã€‚

**è¾¹ç•Œ**ï¼š

- âœ… èµ„æ–™å±•ç¤ºã€é¢„è§ˆã€ä¸Šä¼ ã€åˆ é™¤
- âŒ èµ„æ–™å†…å®¹ç¼–è¾‘ï¼ˆåªè¯»é¢„è§ˆï¼‰
- âŒ èµ„æ–™æƒé™ç®¡ç†ï¼ˆç”±åç«¯æ§åˆ¶ï¼‰

### å…³é”®ç”¨ä¾‹

1. æŸ¥çœ‹æŠ¥å‘Šä¸­æ‰€æœ‰å¼•ç”¨èµ„æ–™åˆ—è¡¨
2. é¢„è§ˆè¡¨æ ¼æ•°æ®ï¼ˆæ»šåŠ¨æŸ¥çœ‹ï¼‰
3. é¢„è§ˆ PDF æ–‡ä»¶ï¼ˆç¿»é¡µã€ç¼©æ”¾ï¼‰
4. ä¸Šä¼ æ–°æ–‡ä»¶åˆ°æŠ¥å‘Š
5. åˆ é™¤ä¸éœ€è¦çš„æ–‡ä»¶

> è¯¦ç»†éœ€æ±‚ä¸éªŒæ”¶æ ‡å‡†è§ `01-requirement.md`

## ğŸ—º ä¿¡æ¯æ¶æ„

```mermaid
graph TD
    A[æŠ¥å‘Šè¯¦æƒ…é¡µ] --> B[å³ä¾§ï¼šå¼•ç”¨èµ„æ–™é¢æ¿]
    B --> C[åˆ—è¡¨è§†å›¾]
    B --> D[é¢„è§ˆè§†å›¾]
    C --> E[èµ„æ–™åˆ—è¡¨é¡¹]
    C --> F[ä¸Šä¼ æŒ‰é’®]
    D --> G[è¡¨æ ¼é¢„è§ˆ]
    D --> H[æ–‡ä»¶é¢„è§ˆ]
    D --> I[å»ºè®®èµ„æ–™è¯¦æƒ…]
```

**å¯¼èˆªè§„åˆ™**ï¼š

- æ— ç‹¬ç«‹è·¯ç”±ï¼ŒåµŒå…¥åœ¨æŠ¥å‘Šè¯¦æƒ…é¡µå³ä¾§é¢æ¿
- åˆ—è¡¨è§†å›¾ â†” é¢„è§ˆè§†å›¾é€šè¿‡ç‚¹å‡»èµ„æ–™é¡¹æˆ–è¿”å›æŒ‰é’®åˆ‡æ¢

## ğŸ§± é¡µé¢è“å›¾

### åˆ—è¡¨è§†å›¾

**åŒºåŸŸèŒè´£**ï¼š

| åŒºåŸŸ             | èŒè´£               | æ˜¾ç¤ºæ•°æ®                   | å…è®¸æ“ä½œ       | æ¡ä»¶           |
| ---------------- | ------------------ | -------------------------- | -------------- | -------------- |
| é¡¶éƒ¨æ ‡é¢˜æ        | æ˜¾ç¤ºæ ‡é¢˜å’Œæ“ä½œå…¥å£ | "å…¨éƒ¨å‚è€ƒèµ„æ–™"             | ç‚¹å‡»ä¸Šä¼        | å§‹ç»ˆæ˜¾ç¤º       |
| èµ„æ–™åˆ—è¡¨         | å±•ç¤ºæ‰€æœ‰èµ„æ–™       | åºå·ã€å›¾æ ‡ã€åç§°ã€å¼•ç”¨æ¬¡æ•° | ç‚¹å‡»é¢„è§ˆã€åˆ é™¤ | æœ‰èµ„æ–™æ—¶æ˜¾ç¤º   |
| åŠ è½½/ç©º/é”™è¯¯çŠ¶æ€ | çŠ¶æ€æç¤º           | åŠ è½½åŠ¨ç”»/ç©ºæç¤º/é”™è¯¯ä¿¡æ¯   | é‡è¯•ï¼ˆé”™è¯¯æ—¶ï¼‰ | å¯¹åº”çŠ¶æ€æ—¶æ˜¾ç¤º |

### é¢„è§ˆè§†å›¾

**åŒºåŸŸèŒè´£**ï¼š

| åŒºåŸŸ     | èŒè´£         | æ˜¾ç¤ºæ•°æ®           | å…è®¸æ“ä½œ         | æ¡ä»¶             |
| -------- | ------------ | ------------------ | ---------------- | ---------------- |
| è¿”å›æŒ‰é’® | è¿”å›åˆ—è¡¨     | "è¿”å›"             | ç‚¹å‡»è¿”å›         | é¢„è§ˆæ—¶æ˜¾ç¤º       |
| é¢„è§ˆåŒº   | æ˜¾ç¤ºèµ„æ–™å†…å®¹ | è¡¨æ ¼/æ–‡ä»¶/èµ„æ–™è¯¦æƒ… | æ»šåŠ¨ã€ç¿»é¡µã€ç¼©æ”¾ | é¢„è§ˆæ—¶æ˜¾ç¤º       |
| æ“ä½œåŒº   | æ§åˆ¶é¢„è§ˆ     | é¡µç ã€ç¼©æ”¾æ¯”ä¾‹     | ç¿»é¡µã€ç¼©æ”¾ã€ä¸‹è½½ | æ ¹æ®èµ„æ–™ç±»å‹æ˜¾ç¤º |

> è¯¦ç»†å¸ƒå±€ä¸çŠ¶æ€åé¦ˆè§ `01-requirement.md`

## ğŸ”„ äº¤äº’æµç¨‹

### é¢„è§ˆèµ„æ–™æµç¨‹

```mermaid
flowchart TD
    A[ç‚¹å‡»èµ„æ–™é¡¹] --> B{èµ„æ–™ç±»å‹?}
    B -->|è¡¨æ ¼| C[æ˜¾ç¤ºè¡¨æ ¼é¢„è§ˆ]
    B -->|æ–‡ä»¶| D{æ–‡ä»¶ç±»å‹?}
    B -->|å»ºè®®èµ„æ–™| E[æ˜¾ç¤ºèµ„æ–™è¯¦æƒ…]
    D -->|PDF| F[æ˜¾ç¤º PDF æŸ¥çœ‹å™¨]
    D -->|å›¾ç‰‡| G[æ˜¾ç¤ºå›¾ç‰‡æŸ¥çœ‹å™¨]
    D -->|Office| H[è½¬æ¢ä¸º PDF åæ˜¾ç¤º]
    C --> I[ç‚¹å‡»è¿”å›]
    F --> I
    G --> I
    H --> I
    E --> I
    I --> J[è¿”å›åˆ—è¡¨è§†å›¾]
```

### èµ„æ–™é¢æ¿çŠ¶æ€æœº

```mermaid
stateDiagram-v2
    [*] --> Loading: è¿›å…¥é¡µé¢
    Loading --> List: åŠ è½½æˆåŠŸä¸”æœ‰æ•°æ®
    Loading --> Empty: åŠ è½½æˆåŠŸä½†æ— æ•°æ®
    Loading --> Error: åŠ è½½å¤±è´¥
    List --> Preview: ç‚¹å‡»èµ„æ–™é¡¹
    Preview --> List: ç‚¹å‡»è¿”å›
    List --> Uploading: ç‚¹å‡»ä¸Šä¼ 
    Uploading --> List: ä¸Šä¼ å®Œæˆ
    Error --> Loading: ç‚¹å‡»é‡è¯•
```

## ğŸ§® æ•°æ®ç®¡ç†

### æ•°æ®æ¥æº

| æ•°æ®         | æ¥æº                            | ä¾èµ–             | åˆ·æ–°æ—¶æœº                |
| ------------ | ------------------------------- | ---------------- | ----------------------- |
| å¼•ç”¨èµ„æ–™åˆ—è¡¨ | Redux (selectSortedReferences)  | ç« èŠ‚æ•°æ®         | ç« èŠ‚æ•°æ®æ›´æ–°æ—¶          |
| å¼•ç”¨èµ„æ–™ Map | Redux (selectReferenceMap)      | sortedReferences | sortedReferences æ›´æ–°æ—¶ |
| å…¨å±€å¼•ç”¨ç´¢å¼• | Redux (selectReferenceIndexMap) | sortedReferences | sortedReferences æ›´æ–°æ—¶ |

### æ’åºè§„åˆ™

1. æŒ‰ç« èŠ‚é¡ºåºæ’åºï¼ˆç¬¬ä¸€ä¸ªç« èŠ‚çš„æ‰€æœ‰å¼•ç”¨åœ¨æœ€å‰é¢ï¼‰
2. ç« èŠ‚å†…æŒ‰ç±»å‹æ’åºï¼šè¡¨æ ¼ï¼ˆDPUï¼‰> å»ºè®®èµ„æ–™ï¼ˆRAGï¼‰> æ–‡ä»¶ï¼ˆFileï¼‰
3. åŒç±»å‹å†…ä¿æŒé»˜è®¤é¡ºåºï¼ˆæ–‡ä»¶æŒ‰ä¸Šä¼ æ—¶é—´é™åºï¼‰
4. å…¨å±€åºå·ç”± Redux selector è‡ªåŠ¨è®¡ç®—

### ç¼“å­˜ç­–ç•¥

- Redux selector ä½¿ç”¨ memoizationï¼Œé¿å…é‡å¤è®¡ç®—
- ç« èŠ‚æ•°æ®å˜åŒ–æ—¶ï¼Œç¼“å­˜è‡ªåŠ¨å¤±æ•ˆ

## ğŸ“Œ ç½®é¡¶æ–‡ä»¶è®¾è®¡

**ç›®æ ‡**ï¼šå±•ç¤ºæœªè¢«ç« èŠ‚å¼•ç”¨çš„æŠ¥å‘Šçº§æ–‡ä»¶ï¼Œä¾¿äºå‘ç°å’Œæ¸…ç†ã€‚

**æ•°æ®æ¥æº**ï¼š

- åŸºç¡€æ•°æ®ï¼š`selectFileUnifiedMap`ï¼ˆå·²èšåˆçš„ç»Ÿä¸€æ–‡ä»¶æ˜ å°„ï¼‰
- æ´¾ç”Ÿé€‰æ‹©å™¨ï¼š`selectTopReportFiles`
- è®¡ç®—è§„åˆ™ï¼š`src/domain/reportReference/topFiles.ts`
- åˆ¤æ–­ä¾æ®ï¼š`refChapter` ä¸ºç©ºæˆ–é•¿åº¦ä¸º 0 çš„æ–‡ä»¶å³ä¸ºæœªè¢«ç« èŠ‚å¼•ç”¨çš„ç½®é¡¶æ–‡ä»¶

**ç»„ä»¶å®ç°**ï¼š

- åˆ—è¡¨åŒºå—ï¼š`src/components/Reference/TopFilesSection/`
- åˆ—è¡¨é¡¹ï¼šå¤ç”¨ `ReferenceItemFile`

## ğŸ§© ç»„ä»¶åˆ†è§£

### ç»„ä»¶å±‚çº§

```mermaid
graph TD
    Page[æŠ¥å‘Šè¯¦æƒ…é¡µ] --> Panel[å¼•ç”¨èµ„æ–™é¢æ¿]
    Panel --> List[åˆ—è¡¨è§†å›¾]
    Panel --> Preview[é¢„è§ˆè§†å›¾]
    List --> Items[èµ„æ–™é¡¹ç»„ä»¶]
    Items --> FileItem[æ–‡ä»¶é¡¹]
    Items --> TableItem[è¡¨æ ¼é¡¹]
    Items --> SuggestItem[å»ºè®®èµ„æ–™é¡¹]
    Preview --> Content[é¢„è§ˆå†…å®¹]
    Content --> PDFViewer[PDF æŸ¥çœ‹å™¨]
    Content --> TablePreview[è¡¨æ ¼é¢„è§ˆ]
```

### æ ¸å¿ƒç»„ä»¶

| ç»„ä»¶                           | èŒè´£                   | ä»£ç ä½ç½®                                               |
| ------------------------------ | ---------------------- | ------------------------------------------------------ |
| **ReferenceView**              | å®¹å™¨ç»„ä»¶ï¼Œç®¡ç†è§†å›¾åˆ‡æ¢ | `src/components/Reference/ReferenceView/`              |
| **RPReferenceListWithChapter** | å±•ç¤ºèµ„æ–™åˆ—è¡¨           | `src/components/Reference/RPReferenceListWithChapter/` |
| **ReferenceItemFile**          | æ–‡ä»¶èµ„æ–™é¡¹             | `src/components/Reference/ReferenceItemFile/`          |
| **ReferenceItemTable**         | è¡¨æ ¼èµ„æ–™é¡¹             | `src/components/Reference/ReferenceItemTable/`         |
| **ReferenceItemSuggest**       | å»ºè®®èµ„æ–™é¡¹             | `src/components/Reference/ReferenceItemSuggest/`       |
| **ReferencePreviewContent**    | é¢„è§ˆå†…å®¹               | `src/components/Reference/ReferencePreviewContent/`    |
| **FilePreviewRenderer**        | æ–‡ä»¶é¢„è§ˆæ¸²æŸ“å™¨         | `src/components/Reference/FilePreviewRenderer/`        |
| **DPUPreviewRenderer**         | è¡¨æ ¼é¢„è§ˆæ¸²æŸ“å™¨         | `src/components/Reference/DPUPreviewRenderer/`         |
| **PDFViewer**                  | PDF æŸ¥çœ‹å™¨             | `src/components/File/PDFViewer/`                       |
| **TopFilesSection**            | ç½®é¡¶æ–‡ä»¶åŒºå—           | `src/components/Reference/TopFilesSection/`            |

### PDFViewer ç»„ä»¶

**ä»£ç ä½ç½®**: `src/components/File/PDFViewer/`

**åŠŸèƒ½ç‰¹æ€§**:

- æ”¯æŒ URLã€Blobã€è‡ªå®šä¹‰åŠ è½½å‡½æ•°
- æ‡’åŠ è½½ä¼˜åŒ–
- ç¼©æ”¾æ§åˆ¶ï¼ˆ25%-200%ï¼‰
- æ—‹è½¬åŠŸèƒ½ï¼ˆ90Â° å¢é‡ï¼‰
- åˆ†é¡µå¯¼èˆª
- æ–‡æœ¬é€‰åŒºé«˜äº®
- æ™ºèƒ½é™çº§

**è¯¦ç»†æ–‡æ¡£**: `src/components/File/PDFViewer/README.md`

### é”™è¯¯å¤„ç†è¾¹ç•Œ

| é”™è¯¯ç±»å‹     | æ•è·ä½ç½®                   | å¤„ç†æ–¹å¼           | ä»£ç ä½ç½®                                               |
| ------------ | -------------------------- | ------------------ | ------------------------------------------------------ |
| æ•°æ®åŠ è½½é”™è¯¯ | RPReferenceListWithChapter | æ˜¾ç¤ºé”™è¯¯æç¤º       | `src/components/Reference/RPReferenceListWithChapter/` |
| é¢„è§ˆåŠ è½½é”™è¯¯ | ReferencePreviewContent    | æ˜¾ç¤ºé”™è¯¯æç¤ºå’Œé‡è¯• | `src/components/Reference/ReferencePreviewContent/`    |
| PDF åŠ è½½é”™è¯¯ | PDFViewer                  | åˆ‡æ¢åˆ°é™çº§æ–¹æ¡ˆ     | `src/components/File/PDFViewer/`                       |
| ä¸Šä¼ é”™è¯¯     | UploadFileBtn              | Toast æç¤º         | `src/components/UploadFileBtn/`                        |

## âœ… æ£€æŸ¥æ¸…å•

- [x] é¡µé¢è“å›¾ä¸åŒºåŸŸèŒè´£æ˜ç¡®
- [x] ä¸»è¦ä»»åŠ¡æµç¨‹å®Œæ•´
- [x] åŠ è½½ã€ç©ºã€é”™è¯¯çŠ¶æ€æ˜ç¡®
- [x] è·¯ç”±ä¸å¯¼èˆªè§„åˆ™æ¸…æ™°
- [x] æ’åºè§„åˆ™æ˜ç¡®
- [x] ç»„ä»¶æ‹†åˆ†ä¸å¤ç”¨è¾¹ç•Œæ¸…æ™°
- [x] é”™è¯¯å¤„ç†è¾¹ç•Œæ˜ç¡®
- [x] æ•°æ®æ¥æºå’Œåˆ·æ–°ç­–ç•¥æ¸…æ™°
- [x] ä»£ç ä½ç½®å·²æ ‡æ³¨
