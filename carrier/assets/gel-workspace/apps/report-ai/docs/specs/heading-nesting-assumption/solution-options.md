# 解决方案 - 标题嵌套假设问题

> 📖 [返回问题概览](./README.md) | 遵循 [Issue 文档编写规范](../../../../../docs/rule/issue-doc-rule.md)

## 待调研问题

在选择方案前，需要先调研以下问题：

- [ ] **AI 生成内容的结构**：确认 AI 生成的 HTML 是否始终保持标题在最外层
- [ ] **历史数据验证**：检查现有报告数据是否存在嵌套标题的情况
- [ ] **TinyMCE 粘贴行为**：验证从外部粘贴 HTML 时，TinyMCE 是否会保持原始嵌套结构
- [ ] **测试覆盖度**：检查现有测试是否涵盖嵌套场景

## 方案对比

### 方案 A：HTML 结构规范化（推荐）⭐

在解析前对 HTML 进行预处理，将嵌套的标题提升到最外层

**优点**：

- 解决根本问题，确保结构符合预期
- 对现有解析逻辑影响最小
- 可处理各种嵌套场景

**缺点**：

- 需要实现结构转换逻辑
- 可能影响原始 HTML 的其他结构

**实现要点**：

1. 在 `parseHtml` 或 `parseDocumentChapterTree` 入口处添加预处理步骤
2. 遍历所有 h1-h6 标签，将其提升到与 body 直接子节点平级
3. 保持内容节点的相对顺序
4. 添加警告日志记录结构调整

**预计工作量**：2-3 天

### 方案 B：增强 getContentNodesAfterHeading 逻辑

修改内容收集逻辑，支持跨容器查找下一个标题

**优点**：

- 无需修改 HTML 结构
- 向后兼容性好

**缺点**：

- 逻辑复杂度增加
- 可能引入新的边界问题
- 难以处理复杂嵌套场景

**预计工作量**：3-5 天

### 方案 C：严格校验 + 拒绝处理

在解析前验证 HTML 结构，不符合预期则拒绝解析并提示用户

**优点**：

- 逻辑简单，风险可控
- 强制规范输入数据

**缺点**：

- 用户体验差，可能频繁报错
- 无法处理历史数据
- AI 生成内容可能不可控

**预计工作量**：1 天

### 方案 D：明确文档化现有假设

在代码和文档中明确声明平级结构要求，不修改逻辑

**优点**：

- 无代码改动，风险最低
- 澄清设计意图

**缺点**：

- 不解决实际问题
- 潜在风险依然存在

**预计工作量**：0.5 天

## 推荐方案

**采用方案 A（HTML 结构规范化）**

### 理由

1. 从根本上解决问题，避免后续维护隐患
2. 对现有解析逻辑影响最小
3. 可以处理各种嵌套场景
4. 工作量可控（2-3 天）

### 实施步骤

1. **调研验证**（0.5 天）

   - 验证 AI 生成内容结构
   - 检查历史数据
   - 测试 TinyMCE 粘贴行为

2. **实现预处理逻辑**（1-1.5 天）

   - 实现标题提升算法
   - 添加日志记录
   - 处理边界情况

3. **测试验证**（0.5-1 天）
   - 添加单元测试
   - 边界场景测试
   - 回归测试

## 更新记录

| 日期       | 修改人 | 更新内容             |
| ---------- | ------ | -------------------- |
| 2025-10-29 | Kiro   | 从主文档拆分解决方案 |
