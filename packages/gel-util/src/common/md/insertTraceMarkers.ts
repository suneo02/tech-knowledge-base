import { ChatTraceItem } from 'gel-api'
import {
  batchInsert,
  buildSourceMarker,
  type InsertPoint,
  normalizePositions,
  type SourcePosition,
} from './sourceMarkerUtils'

/**
 * åˆ¤æ–­ä¸¤ä¸ªæ–‡æœ¬ç‰‡æ®µåœ¨åŸå§‹æ–‡æœ¬ä¸­æ˜¯å¦ä½äºåŒä¸€æ®µè½
 *
 * **æ ¸å¿ƒç›®çš„**ï¼š
 * åœ¨æº¯æºæ ‡è®°æ’å…¥æ—¶ï¼Œéœ€è¦å°†åŒä¸€æ®µè½å†…ã€åŒä¸€å‚è€ƒèµ„æ–™ç´¢å¼•çš„å¤šä¸ªæº¯æºä½ç½®åˆå¹¶åˆ°ä¸€ä¸ªæ ‡è®°ä¸­ã€‚
 * ä¾‹å¦‚ï¼šæ®µè½ä¸­æœ‰ä¸¤å¤„å¼•ç”¨åŒä¸€èµ„æ–™ï¼Œåº”ç”Ÿæˆ ã€0(10~20ï¼Œ30~40)ã€‘ è€Œéä¸¤ä¸ªç‹¬ç«‹æ ‡è®°ã€‚
 *
 * **ç®—æ³•è¯´æ˜**ï¼š
 * - æ®µè½å®šä¹‰ï¼šä»¥ `\n\n` ä½œä¸ºæ®µè½åˆ†éš”ç¬¦
 * - é€šè¿‡ split åˆ†å‰²åï¼Œé€æ®µè®¡ç®—å­—ç¬¦ä½ç½®åŒºé—´
 * - å®šä½ä¸¤ä¸ªæ–‡æœ¬ç‰‡æ®µåˆ†åˆ«æ‰€åœ¨çš„æ®µè½ç´¢å¼•
 * - æ¯”è¾ƒç´¢å¼•æ˜¯å¦ç›¸åŒ
 *
 * **æ—¶é—´å¤æ‚åº¦**ï¼šO(n)ï¼Œn ä¸ºæ®µè½æ•°é‡ï¼ˆéå†æ®µè½æ—¶å¯ä»¥æå‰é€€å‡ºï¼‰
 *
 * @param {string} text - åŸå§‹å®Œæ•´æ–‡æœ¬
 * @param {string} text1 - ç¬¬ä¸€ä¸ªæ–‡æœ¬ç‰‡æ®µï¼ˆç”¨äºå®šä½ï¼‰
 * @param {string} text2 - ç¬¬äºŒä¸ªæ–‡æœ¬ç‰‡æ®µï¼ˆç”¨äºå®šä½ï¼‰
 * @returns {boolean} ä¸¤ä¸ªæ–‡æœ¬ç‰‡æ®µåœ¨åŒä¸€æ®µè½è¿”å› trueï¼Œå¦åˆ™è¿”å› false
 *
 * @example
 * // åœºæ™¯1ï¼šä¸¤ä¸ªç‰‡æ®µåœ¨åŒä¸€æ®µè½
 * const text = 'ç¬¬ä¸€æ®µå†…å®¹\n\nç¬¬äºŒæ®µåŒ…å«text1å’Œtext2çš„å†…å®¹'
 * isInSameParagraph(text, 'text1', 'text2') // true
 *
 * @example
 * // åœºæ™¯2ï¼šä¸¤ä¸ªç‰‡æ®µåœ¨ä¸åŒæ®µè½
 * const text = 'ç¬¬ä¸€æ®µåŒ…å«text1\n\nç¬¬äºŒæ®µåŒ…å«text2'
 * isInSameParagraph(text, 'text1', 'text2') // false
 *
 * @example
 * // åœºæ™¯3ï¼šç‰‡æ®µä¸å­˜åœ¨
 * isInSameParagraph(text, 'notfound', 'text2') // false
 */
const isInSameParagraph = (text: string, text1: string, text2: string): boolean => {
  // æ­¥éª¤1ï¼šæŸ¥æ‰¾ä¸¤ä¸ªæ–‡æœ¬ç‰‡æ®µåœ¨åŸæ–‡ä¸­çš„ä½ç½®
  const pos1 = text.indexOf(text1)
  const pos2 = text.indexOf(text2)

  // è¾¹ç•Œæƒ…å†µï¼šä»»ä¸€æ–‡æœ¬ç‰‡æ®µä¸å­˜åœ¨ï¼Œæ— æ³•åˆ¤æ–­åŒæ®µè½å…³ç³»
  if (pos1 === -1 || pos2 === -1) return false

  // æ­¥éª¤2ï¼šå°†æ–‡æœ¬æŒ‰æ®µè½åˆ†éš”ç¬¦æ‹†åˆ†æˆæ®µè½æ•°ç»„
  const paragraphs = text.split('\n\n')
  let paragraph1Index = -1 // text1 æ‰€åœ¨æ®µè½çš„ç´¢å¼•
  let paragraph2Index = -1 // text2 æ‰€åœ¨æ®µè½çš„ç´¢å¼•

  // æ­¥éª¤3ï¼šéå†æ¯ä¸ªæ®µè½ï¼Œè®¡ç®—å…¶åœ¨åŸæ–‡ä¸­çš„å­—ç¬¦ä½ç½®åŒºé—´
  let currentPos = 0 // å½“å‰æ®µè½åœ¨åŸæ–‡ä¸­çš„èµ·å§‹ä½ç½®
  for (let i = 0; i < paragraphs.length; i++) {
    const paragraphLength = paragraphs[i].length
    const paragraphEnd = currentPos + paragraphLength // å½“å‰æ®µè½çš„ç»“æŸä½ç½®

    // åˆ¤æ–­ text1 æ˜¯å¦åœ¨å½“å‰æ®µè½çš„å­—ç¬¦åŒºé—´å†…
    if (pos1 >= currentPos && pos1 < paragraphEnd) {
      paragraph1Index = i
    }

    // åˆ¤æ–­ text2 æ˜¯å¦åœ¨å½“å‰æ®µè½çš„å­—ç¬¦åŒºé—´å†…
    if (pos2 >= currentPos && pos2 < paragraphEnd) {
      paragraph2Index = i
    }

    // æ›´æ–°ä¸‹ä¸€ä¸ªæ®µè½çš„èµ·å§‹ä½ç½®
    // +2 æ˜¯å› ä¸ºæ®µè½åˆ†éš”ç¬¦ '\n\n' å ç”¨ 2 ä¸ªå­—ç¬¦
    currentPos = paragraphEnd + 2

    // æ€§èƒ½ä¼˜åŒ–ï¼šå¦‚æœä¸¤ä¸ªç´¢å¼•éƒ½å·²æ‰¾åˆ°ï¼Œæå‰é€€å‡ºå¾ªç¯
    if (paragraph1Index !== -1 && paragraph2Index !== -1) {
      break
    }
  }

  // æ­¥éª¤4ï¼šè¿”å›åˆ¤æ–­ç»“æœ
  // ä¸¤ä¸ªæ¡ä»¶éƒ½å¿…é¡»æ»¡è¶³ï¼š
  // 1. paragraph1Index === paragraph2Indexï¼šåœ¨åŒä¸€æ®µè½
  // 2. paragraph1Index !== -1ï¼šæ®µè½ç´¢å¼•æœ‰æ•ˆï¼ˆéƒ½æ‰¾åˆ°äº†å¯¹åº”æ®µè½ï¼‰
  return paragraph1Index === paragraph2Index && paragraph1Index !== -1
}

/**
 * åœ¨æ–‡æœ¬ä¸­æ’å…¥æº¯æºæ ‡è®°ï¼ˆAI å›ç­”çš„å¼•ç”¨æ¥æºæ ‡æ³¨ï¼‰
 *
 * ## æ ¸å¿ƒåŠŸèƒ½
 * å°† AI å›ç­”ä¸­çš„æº¯æºä¿¡æ¯ï¼ˆtracedï¼‰ä»¥ `ã€ç´¢å¼•(ä½ç½®èŒƒå›´)ã€‘` æ ¼å¼æ’å…¥åˆ°å¯¹åº”æ®µè½æœ«å°¾ï¼Œ
 * ç”¨äºæ ‡è®°å›ç­”å†…å®¹æ¥è‡ªå“ªä¸ªå‚è€ƒèµ„æ–™ï¼ˆDPU è¡¨æ ¼æˆ–å‚è€ƒæ–‡çŒ®ï¼‰çš„å“ªäº›ä½ç½®ã€‚
 *
 * ## è®¾è®¡æ–‡æ¡£
 * @see {@link file://../../../../../packages/gel-ui/docs/biz/ai-chat/md-rendering-design.md MD æ–‡æœ¬æ¸²æŸ“ç³»ç»Ÿè®¾è®¡æ–‡æ¡£}
 *
 * ## ä¸šåŠ¡èƒŒæ™¯
 * - AI ç”Ÿæˆå›ç­”æ—¶ï¼Œä¼šæ ‡è®°å“ªäº›æ–‡å­—æ¥è‡ªå“ªä¸ªå‚è€ƒèµ„æ–™
 * - indexï¼šå‚è€ƒèµ„æ–™ç´¢å¼•ï¼ˆ0~n å¯¹åº” DPU è¡¨æ ¼æˆ–å‚è€ƒæ–‡çŒ®åˆ—è¡¨çš„ä½ç½®ï¼‰
 * - start~endï¼šåœ¨å‚è€ƒèµ„æ–™ä¸­çš„å­—ç¬¦ä½ç½®èŒƒå›´
 * - ç”¨æˆ·ç‚¹å‡»æº¯æºæ ‡è®°å¯è·³è½¬åˆ°åŸå§‹å‚è€ƒèµ„æ–™çš„å¯¹åº”ä½ç½®
 *
 * ## å¤„ç†æµç¨‹ï¼ˆå››ä¸ªé˜¶æ®µï¼‰
 *
 * ### é˜¶æ®µ1ï¼šæ•°æ®åˆ†ç»„ä¸åˆå¹¶
 * 1. æŒ‰å‚è€ƒèµ„æ–™ç´¢å¼•ï¼ˆindexï¼‰åˆ†ç»„æ‰€æœ‰æº¯æºç‚¹
 * 2. åœ¨åŒä¸€ç´¢å¼•ä¸‹ï¼Œåˆ¤æ–­æº¯æºæ˜¯å¦åœ¨åŒä¸€æ®µè½
 * 3. åŒä¸€æ®µè½çš„å¤šä¸ªæº¯æºä½ç½®åˆå¹¶åˆ°ä¸€èµ·ï¼ˆé¿å…é‡å¤æ ‡è®°ï¼‰
 *
 * ### é˜¶æ®µ2ï¼šè®¡ç®—æ’å…¥ä½ç½®
 * 1. å®šä½æº¯æº value åœ¨åŸæ–‡ä¸­çš„ä½ç½®
 * 2. æ‰¾åˆ°è¯¥æ®µè½çš„ç»“æŸä½ç½®ï¼ˆ\n\n æˆ–æ–‡æœ¬æœ«å°¾ï¼‰
 * 3. ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœæ®µè½åŒ…å« Markdown è¡¨æ ¼ï¼Œæ ‡è®°åº”æ’åœ¨è¡¨æ ¼æœ€åä¸€ä¸ª `|` ä¹‹å‰
 *
 * ### é˜¶æ®µ3ï¼šç”Ÿæˆæº¯æºæ ‡è®°
 * 1. å°†åŒä¸€æ®µè½çš„å¤šä¸ªä½ç½®åˆå¹¶ï¼šã€ç´¢å¼•(10~20ï¼Œ30~40)ã€‘
 * 2. ä½ç½®æŒ‰ start å‡åºæ’åˆ—
 * 3. å»é™¤é‡å¤ä½ç½®
 *
 * ### é˜¶æ®µ4ï¼šæ‰¹é‡æ’å…¥æ ‡è®°
 * 1. å°†æ‰€æœ‰æ’å…¥ç‚¹æŒ‰ä½ç½®é™åºæ’åˆ—
 * 2. ä»åå‘å‰æ’å…¥ï¼ˆé¿å…å‰é¢çš„æ’å…¥å½±å“åé¢çš„ä½ç½®ï¼‰
 * 3. è¿”å›æœ€ç»ˆæ–‡æœ¬
 *
 * ## ç®—æ³•å¤æ‚åº¦
 * - æ—¶é—´å¤æ‚åº¦ï¼šO(n*m + k*log(k))
 *   - n: traces æ•°é‡
 *   - m: æ¯ä¸ª trace çš„ traced ç‚¹æ•°é‡
 *   - k: æœ€ç»ˆçš„æ’å…¥ç‚¹æ•°é‡
 * - ç©ºé—´å¤æ‚åº¦ï¼šO(k)
 *
 * ## å…³é”®è®¾è®¡å†³ç­–
 *
 * ### ä¸ºä»€ä¹ˆè¦æŒ‰æ®µè½åˆå¹¶ï¼Ÿ
 * - é¿å…åœ¨åŒä¸€æ®µè½æœ«å°¾å‡ºç°å¤šä¸ªç›¸åŒç´¢å¼•çš„æ ‡è®°
 * - æå‡é˜…è¯»ä½“éªŒï¼Œå‡å°‘è§†è§‰å¹²æ‰°
 *
 * ### ä¸ºä»€ä¹ˆä»åå‘å‰æ’å…¥ï¼Ÿ
 * - ä»å‰å‘åæ’å…¥ä¼šå¯¼è‡´åç»­æ’å…¥ä½ç½®åç§»
 * - ä¾‹å¦‚ï¼šåœ¨ä½ç½®10æ’å…¥5ä¸ªå­—ç¬¦åï¼ŒåŸæ¥ä½ç½®20çš„å†…å®¹å˜æˆä½ç½®25
 * - ä»åå‘å‰æ’å…¥ä¸ä¼šå½±å“å‰é¢çš„ä½ç½®
 *
 * ### ä¸ºä»€ä¹ˆç‰¹æ®Šå¤„ç†è¡¨æ ¼ï¼Ÿ
 * - Markdown è¡¨æ ¼ä»¥ `|` åˆ†éš”å•å…ƒæ ¼
 * - åœ¨è¡¨æ ¼è¡Œæœ«å°¾æ’å…¥æ ‡è®°ä¼šç ´åè¡¨æ ¼ç»“æ„
 * - åº”åœ¨æœ€åä¸€ä¸ª `|` ä¹‹å‰æ’å…¥ï¼Œä¿æŒè¡¨æ ¼å®Œæ•´æ€§
 *
 * @author åˆ˜å…´å <xhliu.liuxh@wind.com.cn>
 * @param {string} text - éœ€è¦å¤„ç†çš„åŸå§‹ AI å›ç­”æ–‡æœ¬
 * @param {ChatTraceItem[]} traces - æº¯æºæ ‡è®°æ•°ç»„ï¼Œæ¯ä¸ªå…ƒç´ åŒ…å«ï¼š
 *   - value: æº¯æºçš„åŸæ–‡ç‰‡æ®µï¼ˆç”¨äºå®šä½æ®µè½ï¼‰
 *   - traced: æº¯æºä½ç½®ä¿¡æ¯æ•°ç»„
 *     - start: åœ¨å‚è€ƒèµ„æ–™ä¸­çš„èµ·å§‹ä½ç½®
 *     - end: åœ¨å‚è€ƒèµ„æ–™ä¸­çš„ç»“æŸä½ç½®
 *     - index: å‚è€ƒèµ„æ–™ç´¢å¼•ï¼ˆ0~nï¼‰
 * @returns {string} å¤„ç†åçš„æ–‡æœ¬ï¼Œåœ¨æ®µè½æœ«å°¾æ·»åŠ äº†æº¯æºæ ‡è®°
 *
 * @example
 * // ========== åœºæ™¯1ï¼šå•ä¸ªæº¯æºæ ‡è®° ==========
 * const text = 'å°ç±³ç§‘æŠ€æœ‰é™è´£ä»»å…¬å¸æˆç«‹äº2010å¹´'
 * const traces = [
 *   {
 *     value: 'å°ç±³ç§‘æŠ€æœ‰é™è´£ä»»å…¬å¸',
 *     traced: [{ start: 0, end: 10, index: 0 }]
 *   }
 * ]
 * const result = insertTraceMarkers(text, traces)
 * // è¿”å›: 'å°ç±³ç§‘æŠ€æœ‰é™è´£ä»»å…¬å¸æˆç«‹äº2010å¹´ã€0(0~10)ã€‘'
 * // è¯´æ˜ï¼šåœ¨æ®µè½æœ«å°¾æ’å…¥äº†æ¥è‡ªå‚è€ƒèµ„æ–™0çš„ä½ç½®0~10çš„æ ‡è®°
 *
 * @example
 * // ========== åœºæ™¯2ï¼šåŒä¸€æ®µè½å¤šä¸ªæº¯æºä½ç½®åˆå¹¶ ==========
 * const text = 'å°ç±³ç§‘æŠ€åœ¨2010å¹´æˆç«‹ï¼Œå°ç±³é›†å›¢æ˜¯å…¶æ¯å…¬å¸'
 * const traces = [
 *   {
 *     value: 'å°ç±³ç§‘æŠ€åœ¨2010å¹´æˆç«‹ï¼Œå°ç±³é›†å›¢æ˜¯å…¶æ¯å…¬å¸',
 *     traced: [
 *       { start: 0, end: 10, index: 0 },   // ç¬¬ä¸€å¤„å¼•ç”¨
 *       { start: 20, end: 30, index: 0 }   // ç¬¬äºŒå¤„å¼•ç”¨
 *     ]
 *   }
 * ]
 * const result = insertTraceMarkers(text, traces)
 * // è¿”å›: 'å°ç±³ç§‘æŠ€åœ¨2010å¹´æˆç«‹ï¼Œå°ç±³é›†å›¢æ˜¯å…¶æ¯å…¬å¸ã€0(0~10ï¼Œ20~30)ã€‘'
 * // è¯´æ˜ï¼šä¸¤ä¸ªæº¯æºä½ç½®åˆå¹¶åˆ°ä¸€ä¸ªæ ‡è®°ä¸­ï¼Œç”¨ä¸­æ–‡é€—å·åˆ†éš”
 *
 * @example
 * // ========== åœºæ™¯3ï¼šè·¨æ®µè½æº¯æºæ ‡è®°åˆ†åˆ«æ’å…¥ ==========
 * const text = 'ç¬¬ä¸€æ®µå†…å®¹A\n\nç¬¬äºŒæ®µå†…å®¹B'
 * const traces = [
 *   { value: 'ç¬¬ä¸€æ®µå†…å®¹A', traced: [{ start: 0, end: 5, index: 0 }] },
 *   { value: 'ç¬¬äºŒæ®µå†…å®¹B', traced: [{ start: 10, end: 15, index: 0 }] }
 * ]
 * const result = insertTraceMarkers(text, traces)
 * // è¿”å›: 'ç¬¬ä¸€æ®µå†…å®¹Aã€0(0~5)ã€‘\n\nç¬¬äºŒæ®µå†…å®¹Bã€0(10~15)ã€‘'
 * // è¯´æ˜ï¼šä¸åŒæ®µè½çš„æº¯æºæ ‡è®°åˆ†åˆ«æ’å…¥å„è‡ªæ®µè½æœ«å°¾
 *
 * @example
 * // ========== åœºæ™¯4ï¼šè¡¨æ ¼åœºæ™¯çš„ç‰¹æ®Šå¤„ç† ==========
 * const text = '| å…¬å¸åç§° | è¥æ”¶ |\n| å°ç±³ | 100äº¿ |'
 * const traces = [
 *   {
 *     value: '| å…¬å¸åç§° | è¥æ”¶ |\n| å°ç±³ | 100äº¿ |',
 *     traced: [{ start: 0, end: 10, index: 0 }]
 *   }
 * ]
 * const result = insertTraceMarkers(text, traces)
 * // è¿”å›: '| å…¬å¸åç§° | è¥æ”¶ |\n| å°ç±³ | 100äº¿ã€0(0~10)ã€‘ |'
 * // è¯´æ˜ï¼šæ ‡è®°æ’åœ¨æœ€åä¸€ä¸ª | ä¹‹å‰ï¼Œä¿æŒè¡¨æ ¼ç»“æ„å®Œæ•´
 *
 * @example
 * // ========== åœºæ™¯5ï¼šä¸åŒå‚è€ƒèµ„æ–™ç´¢å¼• ==========
 * const text = 'æ ¹æ®å…¬å‘Šï¼Œå°ç±³2024å¹´è¥æ”¶å¢é•¿20%\n\næ ¹æ®ç ”æŠ¥ï¼Œé¢„è®¡2025å¹´ç»§ç»­å¢é•¿'
 * const traces = [
 *   { value: 'æ ¹æ®å…¬å‘Šï¼Œå°ç±³2024å¹´è¥æ”¶å¢é•¿20%', traced: [{ start: 0, end: 10, index: 0 }] },
 *   { value: 'æ ¹æ®ç ”æŠ¥ï¼Œé¢„è®¡2025å¹´ç»§ç»­å¢é•¿', traced: [{ start: 5, end: 15, index: 1 }] }
 * ]
 * const result = insertTraceMarkers(text, traces)
 * // è¿”å›: 'æ ¹æ®å…¬å‘Šï¼Œå°ç±³2024å¹´è¥æ”¶å¢é•¿20%ã€0(0~10)ã€‘\n\næ ¹æ®ç ”æŠ¥ï¼Œé¢„è®¡2025å¹´ç»§ç»­å¢é•¿ã€1(5~15)ã€‘'
 * // è¯´æ˜ï¼šindex=0 æ¥è‡ªå‚è€ƒèµ„æ–™0ï¼ˆå¯èƒ½æ˜¯å…¬å‘Šï¼‰ï¼Œindex=1 æ¥è‡ªå‚è€ƒèµ„æ–™1ï¼ˆå¯èƒ½æ˜¯ç ”æŠ¥ï¼‰
 */
export const insertTraceMarkers = (text: string, traces: ChatTraceItem[]): string => {
  // ========== å‰ç½®æ ¡éªŒï¼šè¾¹ç•Œæ¡ä»¶å¤„ç† ==========
  // å¦‚æœæ–‡æœ¬ä¸ºç©ºæˆ–æ²¡æœ‰æº¯æºæ•°æ®ï¼Œç›´æ¥è¿”å›åŸæ–‡ï¼ˆæ— éœ€å¤„ç†ï¼‰
  if (!text || !traces?.length) return text

  // ========== é˜¶æ®µ1ï¼šæ•°æ®é¢„å¤„ç†ä¸åˆ†ç»„ ==========
  /**
   * tracesByIndex æ•°æ®ç»“æ„è¯´æ˜ï¼š
   * {
   *   0: [  // å‚è€ƒèµ„æ–™ç´¢å¼• 0
   *     {
   *       value: 'æ®µè½Açš„æ–‡æœ¬',
   *       positions: [{ start: 0, end: 10 }, { start: 20, end: 30 }]
   *     },
   *     {
   *       value: 'æ®µè½Bçš„æ–‡æœ¬',
   *       positions: [{ start: 5, end: 15 }]
   *     }
   *   ],
   *   1: [  // å‚è€ƒèµ„æ–™ç´¢å¼• 1
   *     { value: 'æ®µè½Cçš„æ–‡æœ¬', positions: [...] }
   *   ]
   * }
   *
   * è®¾è®¡è¦ç‚¹ï¼š
   * - ç¬¬ä¸€å±‚ key æ˜¯å‚è€ƒèµ„æ–™ç´¢å¼•ï¼ˆindexï¼‰
   * - ç¬¬äºŒå±‚æ•°ç»„å­˜å‚¨è¯¥ç´¢å¼•ä¸‹ä¸åŒæ®µè½çš„æº¯æºä¿¡æ¯
   * - åŒä¸€æ®µè½çš„å¤šä¸ªä½ç½®ä¼šåˆå¹¶åˆ°åŒä¸€ä¸ª positions æ•°ç»„ä¸­
   */
  const tracesByIndex: Record<
    number,
    {
      positions: SourcePosition[] // æº¯æºä½ç½®æ•°ç»„
      value: string // æº¯æºæ‰€åœ¨çš„åŸæ–‡ç‰‡æ®µï¼ˆç”¨äºå®šä½æ®µè½ï¼‰
    }[]
  > = {}

  // æ­¥éª¤1.1ï¼šéå†æ‰€æœ‰æº¯æºæ ‡è®°ï¼Œè¿›è¡Œåˆ†ç»„
  traces.forEach((trace) => {
    // è·³è¿‡æ— æ•ˆæ•°æ®ï¼šå¿…é¡»åŒæ—¶æœ‰ traced æ•°ç»„å’Œ value
    if (trace.traced && trace.traced.length > 0 && trace.value) {
      const { value } = trace

      // æ­¥éª¤1.2ï¼šéå†è¯¥æº¯æºæ ‡è®°çš„æ‰€æœ‰æº¯æºç‚¹
      trace.traced.forEach((point) => {
        const index = point.index // å‚è€ƒèµ„æ–™ç´¢å¼•

        // æ­¥éª¤1.3ï¼šåˆå§‹åŒ–ç´¢å¼•ç»„ï¼ˆå¦‚æœè¯¥ç´¢å¼•ç¬¬ä¸€æ¬¡å‡ºç°ï¼‰
        if (!tracesByIndex[index]) {
          tracesByIndex[index] = [
            {
              positions: [],
              value,
            },
          ]
        }

        // æ­¥éª¤1.4ï¼šæŸ¥æ‰¾åŒä¸€ç´¢å¼•ã€åŒä¸€æ®µè½çš„å·²æœ‰è®°å½•
        // ä¸ºä»€ä¹ˆè¦åˆ¤æ–­åŒä¸€æ®µè½ï¼Ÿ
        // - åŒä¸€æ®µè½çš„å¤šä¸ªæº¯æºä½ç½®åº”åˆå¹¶åˆ°ä¸€ä¸ªæ ‡è®°ä¸­
        // - ä¾‹å¦‚ï¼šæ®µè½ä¸­ä¸¤å¤„å¼•ç”¨åŒä¸€èµ„æ–™ â†’ ã€0(10~20ï¼Œ30~40)ã€‘è€Œéä¸¤ä¸ªç‹¬ç«‹æ ‡è®°
        const existingTrace = tracesByIndex[index]?.find((item) => {
          return isInSameParagraph(text, item.value, value)
        })

        // æ­¥éª¤1.5ï¼šæ ¹æ®æ˜¯å¦æ‰¾åˆ°å·²æœ‰è®°å½•ï¼Œå†³å®šæ“ä½œ
        if (!existingTrace) {
          // æƒ…å†µAï¼šè¿™æ˜¯è¯¥ç´¢å¼•åœ¨è¯¥æ®µè½çš„é¦–æ¬¡å‡ºç°ï¼Œåˆ›å»ºæ–°è®°å½•
          tracesByIndex[index].push({
            positions: [{ start: point.start, end: point.end }],
            value,
          })
        } else {
          // æƒ…å†µBï¼šè¯¥ç´¢å¼•åœ¨è¯¥æ®µè½å·²å­˜åœ¨è®°å½•ï¼Œå°†ä½ç½®è¿½åŠ åˆ°å·²æœ‰è®°å½•
          existingTrace.positions.push({
            start: point.start,
            end: point.end,
          })
        }
      })
    }
  })

  // æ­¥éª¤1.6ï¼šéªŒè¯æ˜¯å¦æœ‰æœ‰æ•ˆçš„æº¯æºç‚¹
  // å¦‚æœåˆ†ç»„åçš„æ•°æ®ä¸ºç©ºï¼Œè¯´æ˜æ‰€æœ‰ traces éƒ½æ˜¯æ— æ•ˆæ•°æ®
  if (Object.keys(tracesByIndex).length === 0) {
    return text
  }

  // è°ƒè¯•æ—¥å¿—ï¼šæŸ¥çœ‹åˆ†ç»„ç»“æœï¼ˆç”Ÿäº§ç¯å¢ƒåº”ç§»é™¤ï¼‰
  console.log('ğŸš€ ~ insertTraceMarkers ~ tracesByIndex:', tracesByIndex)

  // ========== é˜¶æ®µ2 & 3ï¼šè®¡ç®—æ’å…¥ä½ç½®å¹¶ç”Ÿæˆæ ‡è®° ==========
  /**
   * insertPoints æ•°æ®ç»“æ„ï¼š
   * [
   *   { position: 100, content: 'ã€0(10~20ï¼Œ30~40)ã€‘' },
   *   { position: 50, content: 'ã€1(5~15)ã€‘' }
   * ]
   *
   * åç»­ä¼šæŒ‰ position é™åºæ’åˆ—ï¼Œä»åå‘å‰æ’å…¥
   */
  const insertPoints: InsertPoint[] = []

  // æ­¥éª¤2.1ï¼šéå†æ‰€æœ‰å‚è€ƒèµ„æ–™ç´¢å¼•
  for (const index of Object.keys(tracesByIndex).map(Number)) {
    // æ­¥éª¤2.2ï¼šéå†è¯¥ç´¢å¼•ä¸‹çš„æ‰€æœ‰æ®µè½æº¯æº
    for (const trace of tracesByIndex[index]) {
      const { positions, value } = trace

      // ========== æ­¥éª¤3.1ï¼šä½ç½®æ•°ç»„å¤„ç†ï¼ˆæ’åº + å»é‡ï¼‰ ==========
      // ä½¿ç”¨ç»Ÿä¸€çš„å·¥å…·å‡½æ•°è¿›è¡Œè§„èŒƒåŒ–å¤„ç†
      const normalizedPositions = normalizePositions(positions)

      // ========== æ­¥éª¤2.3ï¼šå®šä½æ®µè½æœ«å°¾ï¼ˆæ’å…¥ä½ç½®ï¼‰ ==========
      // æŸ¥æ‰¾ value åœ¨åŸæ–‡ä¸­çš„ä½ç½®
      const valuePos = text.indexOf(value)

      // æ®µè½åˆ†éš”ç¬¦å¸¸é‡
      const paragraphEndRegex = `\n\n`

      // å¦‚æœæ‰¾ä¸åˆ° valueï¼Œè·³è¿‡ï¼ˆç†è®ºä¸Šä¸åº”è¯¥å‘ç”Ÿï¼‰
      if (valuePos !== -1) {
        // æ­¥éª¤2.4ï¼šè®¡ç®—æ®µè½ç»“æŸä½ç½®
        const valueEndPos = valuePos + value.length

        // ä» valueEndPos å¼€å§‹æŸ¥æ‰¾ä¸‹ä¸€ä¸ªæ®µè½åˆ†éš”ç¬¦
        let paragraphEndPos = text.indexOf(paragraphEndRegex, valueEndPos)

        // è¾¹ç•Œæƒ…å†µ1ï¼švalue æœ¬èº«ä»¥æ®µè½åˆ†éš”ç¬¦ç»“å°¾
        // ä¾‹å¦‚ï¼švalue = "æ®µè½å†…å®¹\n\n"
        // æ­¤æ—¶æ ‡è®°åº”æ’åœ¨ value æœ«å°¾ä¹‹å‰ï¼ˆè€Œéä¹‹åï¼‰
        if (value.endsWith(paragraphEndRegex)) {
          paragraphEndPos = valueEndPos - paragraphEndRegex.length
        }

        // è¾¹ç•Œæƒ…å†µ2ï¼šæ‰¾ä¸åˆ°æ®µè½åˆ†éš”ç¬¦ï¼ˆè¯´æ˜æ˜¯æœ€åä¸€æ®µï¼‰
        // æˆ–è€…åˆ†éš”ç¬¦ä½ç½®è¶…å‡ºæ–‡æœ¬èŒƒå›´ï¼ˆæ•°æ®å¼‚å¸¸ï¼‰
        if (paragraphEndPos === -1 || paragraphEndPos > text.length) {
          paragraphEndPos = text.length // ä½¿ç”¨æ–‡æœ¬æœ«å°¾ä½œä¸ºæ®µè½ç»“æŸä½ç½®
        }

        // ========== æ­¥éª¤2.5ï¼šç‰¹æ®Šå¤„ç† - Markdown è¡¨æ ¼åœºæ™¯ ==========
        // é—®é¢˜æè¿°ï¼š
        // Markdown è¡¨æ ¼ä»¥ | åˆ†éš”å•å…ƒæ ¼ï¼Œä¾‹å¦‚ï¼š
        // | åˆ—1 | åˆ—2 |
        // | å€¼1 | å€¼2 |
        //
        // å¦‚æœç›´æ¥åœ¨è¡Œæœ«æ’å…¥æ ‡è®°ï¼š
        // | å€¼1 | å€¼2 |ã€0(10~20)ã€‘  â† ç ´åäº†è¡¨æ ¼ç»“æ„
        //
        // æ­£ç¡®åšæ³•ï¼šåœ¨æœ€åä¸€ä¸ª | ä¹‹å‰æ’å…¥
        // | å€¼1 | å€¼2ã€0(10~20)ã€‘ |  â† ä¿æŒè¡¨æ ¼å®Œæ•´

        // æ£€æŸ¥æ®µè½æ˜¯å¦åŒ…å«è¡¨æ ¼è¡Œï¼ˆè‡³å°‘åŒ…å«ä¸€ä¸ª | å¼€å¤´å’Œç»“å°¾çš„è¡Œï¼‰
        const tableRowRegex = /\|.*\|/g
        const textBetween = text.substring(valuePos, paragraphEndPos)
        const tableRows = textBetween.match(tableRowRegex)

        if (tableRows && tableRows.length >= 1) {
          // æ‰¾åˆ°æœ€åä¸€ä¸ª | çš„ä½ç½®
          const lastPipeIndex = textBetween.lastIndexOf('|')
          console.log('ğŸš€ ~ insertTraceMarkers ~ lastPipeIndex:', lastPipeIndex, text.substring(0, paragraphEndPos))

          // æ£€æŸ¥æœ€åä¸€ä¸ª | ä¹‹åæ˜¯å¦åªæœ‰ç©ºç™½å­—ç¬¦
          // å¦‚æœæ˜¯ï¼Œè¯´æ˜è¿™æ˜¯è¡¨æ ¼è¡Œçš„ç»“æŸ |
          const lastPipeContent = text.substring(valuePos + lastPipeIndex + 1, paragraphEndPos).trim()

          if (lastPipeIndex !== -1 && lastPipeContent === '') {
            // è®¡ç®—æ–°çš„æ’å…¥ä½ç½®ï¼šåœ¨æœ€åä¸€ä¸ª | ä¹‹å‰
            // -1 æ˜¯ä¸ºäº†åœ¨ | å­—ç¬¦ä¹‹å‰æ’å…¥ï¼ˆè€Œéç´§æŒ¨ç€ |ï¼‰
            const insertPos = valuePos + lastPipeIndex - 1
            paragraphEndPos = insertPos
          }
        }

        // æ­¥éª¤2.6ï¼šè®°å½•æ’å…¥ç‚¹
        // ä½¿ç”¨ç»Ÿä¸€çš„å·¥å…·å‡½æ•°ç”Ÿæˆæº¯æºæ ‡è®°
        insertPoints.push({
          position: paragraphEndPos,
          content: buildSourceMarker(index, normalizedPositions),
        })
      }
    }
  }

  // ========== é˜¶æ®µ4ï¼šæ‰¹é‡æ’å…¥æº¯æºæ ‡è®° ==========

  // è°ƒè¯•æ—¥å¿—ï¼šæŸ¥çœ‹æ’å…¥ç‚¹ï¼ˆç”Ÿäº§ç¯å¢ƒåº”ç§»é™¤ï¼‰
  console.log('ğŸš€ ~ insertTraceMarkers ~ insertPoints:', insertPoints)

  // ä½¿ç”¨ç»Ÿä¸€çš„æ‰¹é‡æ’å…¥å·¥å…·å‡½æ•°
  // è‡ªåŠ¨å¤„ç†æ’åºå’Œä»åå‘å‰æ’å…¥çš„é€»è¾‘
  return batchInsert(text, insertPoints)
}
