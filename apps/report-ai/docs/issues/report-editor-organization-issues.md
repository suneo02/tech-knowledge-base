# reportEditor 模块组织问题

## 问题概览

| 字段         | 内容                                            |
| ------------ | ----------------------------------------------- |
| 问题         | reportEditor 模块目录与职责划分存在多个组织问题 |
| 状态         | 🚧 进行中                                       |
| 优先级       | 🟡 P1                                           |
| 责任人       | -                                               |
| 发现时间     | 2025-02-14                                      |
| 预期解决时间 | 待定                                            |

## 背景与预期

reportEditor 负责报告编辑器的渲染、拆分、TinyMCE 写入、引用辅助等核心业务流程，预期应将纯数据变换、第三方编辑器操作和跨域数据整合分层隔离。

## 问题陈述

### 现象

shared 基础层被 TinyMCE 依赖侵蚀、渲染与引用功能跨域堆叠、根级导出失控、split 模块承担多重职责。

### 根因

基础层职责膨胀、纯函数依赖编辑器上下文、引用数据职责未独立、缺乏 API 门面分层、解析流程缺少阶段性边界。

### 影响

- 渲染、拆分、注水三个核心链路都需加载 TinyMCE 依赖
- 难以在 SSR / Worker 中复用纯函数
- 渲染模块的任何调整都会触发引用映射联锁修改
- 其他领域模块直接引用内部函数，形成硬耦合

## 关键参考

| 文档/代码路径                                      | 作用             | 备注             |
| -------------------------------------------------- | ---------------- | ---------------- |
| `domain/reportEditor/shared/index.ts`              | 统一导出基础层   | TinyMCE 依赖混入 |
| `domain/reportEditor/rendering/chapterRenderer.ts` | 章节 HTML 渲染   | 混合引用拼装逻辑 |
| `domain/reportEditor/reference/topFiles.ts`        | 顶部引用文件筛选 | 跨域依赖         |
| `domain/reportEditor/index.ts`                     | 模块根级导出     | 无分层结构       |
| `domain/reportEditor/split/chapterSegments.ts`     | 章节拆分核心逻辑 | 承担多重职责     |

## 解决方案

### 方案要点

1. 在 reportEditor 内新增 `infrastructure/tinymce`，将 TinyMCE 依赖移入专属目录（预计 3 天）
2. 把引用序号与顶置文件逻辑统一迁往 `domain/reference`（预计 2 天）
3. 重新规划根级导出，区分"外部正式 API"与"内部协作 API"（预计 2 天）
4. 拆分 split 模块为"DOM 遍历""节点构建""树生成"子模块（预计 3 天）

### 备选方案

将常量与纯函数迁移到共享 `report-html` 工具层 - 放弃理由：影响范围过大

### 待办事项

- [ ] 新增 infrastructure/tinymce 目录
- [ ] 迁移引用逻辑到 domain/reference
- [ ] 重新规划根级导出结构
- [ ] 拆分 split 模块
- [ ] 更新 README 与设计文档

## 验证与风险

### 验证步骤

1. 验证渲染、拆分、注水功能正常
2. 验证引用面板功能正常
3. 验证外部模块引用不受影响

### 剩余风险

- 目录调整会触发广泛的回归测试
- 需要逐步迁移，避免破坏现有功能

## 更新日志

| 日期       | 事件 | 描述                       |
| ---------- | ---- | -------------------------- |
| 2025-02-14 | 创建 | 初始创建，识别模块组织问题 |

## 附录

待明确设计问题：

- 基础层与 TinyMCE 边界拆分方式（选项：infrastructure/tinymce 或 report-html 工具层）
- 渲染与引用逻辑的归属（选项：domain/reference 或 composition 层）
