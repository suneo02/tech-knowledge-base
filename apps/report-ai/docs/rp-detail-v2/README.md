# 报告平台渲染与存储预研

面向 BE/FE 的摘要，聚焦问题、方案选择与待决策点，避免冗余。

> 术语：BE = 后端，FE = 前端。

## 背景
- BE 目前仅返回章节 HTML，缺少可复用的自定义 CSS，FE 拼整页会丢外层或用户样式。
- 需兼顾章节粒度编辑/保存与整页交付，且保留章节 ID/引用标记以支撑大纲、定位、溯源。
- 章节树数据异常时，FE 拼接易出错，缺少样式兜底。

## 目标与范围
- 数据合同同时满足：编辑/保存、完整样式复用，且不回退三栏布局、报告大纲、自动保存。
- 兼容两种模式：章节模式（主路径）+ 整页模式（兜底/预览）。
- 范围：RPDetail 的 HTML/CSS/标记传输、渲染、保存模型。非范围：具体组件样式、底层实现、灰度细节。

## 合同方向（草案）
- 样式放在全文层面：整页模式仅返回一个 `css`（文本 CSS），不在章节级分发样式。
- 章节数据保留业务元信息（参考现有 `RPDetailChapter`：`files?`、`refData?`、`refSuggest?`、`traceContent?` 等）。整页模式下章节的结构/顺序/标题从整页 `html` 解析获得。
- 整页结构示例：`{ html: string; css?: string; metaMap?: Record<chapterId, Meta> }`，其中 `metaMap` 仅承载章节业务元信息，不承载标题/顺序等结构信息。

## 整页模式接口定义（建议新增）

> 说明：章节模式接口沿用现有实现（当前就是分章节链路），本文只补齐“整页兜底/预览”接口的可落地定义。

### `GET /api/report/render`（建议，兜底/预览专用）

- **用途**：BE 返回“可直接渲染的整页 HTML + 统一 CSS + 章节业务元信息映射”，FE 无需再拼接 HTML/CSS。
- **请求参数**
  - `reportId: string`（必填）
- **响应体（`result`）**

```ts
export type RPDetailRenderChapterMeta = Pick<
  RPDetailChapter,
  'files' | 'refData' | 'refSuggest' | 'traceContent'
>;

export type RPDetailRenderResult = {
  html: string;
  css?: string; // 一份“最终可用”的全文 CSS（FE 按需注入/隔离）
  metaMap?: Record<string, RPDetailRenderChapterMeta>; // key 为 `${chapterId}`
};
```

**样式字段说明**
- `css`：服务端返回的“最终 CSS 文本”，用于解决“外层/用户样式丢失”的问题；HTML/CSS 中出现的资源地址建议直接使用绝对 URL（避免再引入 `assetBaseUrl/stylesheets` 等额外字段）。

**HTML 标记约束**
- 服务端拼接后的 `html` 中，每个章节必须有一个标题节点：`<h1..h6 data-chapter-id="123">章节标题</h1..h6>`。
- 上述标题节点必须位于 `body` 的直接子元素内（章节块容器），即 `body` 下按章节分块，避免出现跨章节的 DOM 交错。
- `data-chapter-id` 必须与 `metaMap` 的 key 一致（字符串化的 chapterId）。
- 引用标记仍由 FE 基于 `refData/refSuggest/traceContent` 插入（BE 无需感知）

**失败与降级**
- 业务失败：HTTP `200` + `ErrorCode/message`（沿用现有 `ApiResponseForWFC` 约定）
- 系统异常：HTTP `500+`
- FE 策略：`/api/report/render` 失败或数据不满足标记约束时，降级回章节模式渲染（并埋点记录原因）

## 模式对比
| 维度 | 章节模式（主） | 整页模式（兜底/预览） |
| --- | --- | --- |
| 传输 | `chapters[]`：业务元信息 + 标记；样式统一在全文 CSS/外链中 | 单个 `html`（含章节标记）+ 可选 `metaMap`（仅业务元信息，不含标题/顺序）+ 全文样式 |
| 标记 | 返回章节 ID（content 可为空）；引用标记由 FE 插入 | BE 拼好 `<h* data-chapter-id>` 标题标记；引用标记可由 FE 插入 |
| 编辑/保存 | FE 富文本编辑器按章节 setContent；按章节保存（内容/元信息） | 编辑/保存按整页（全文 HTML+样式一并提交）；FE 避免拆分为章节 |
| 样式 | FE 在编辑器中注入全文 CSS；章节不单独带样式 | 隔离渲染容器（如 iframe / Shadow DOM）只读加载整页 |
| 兜底 | 树异常可请求整页版 | FE 无需拼接，样式不丢失 |

## 数据流概要
- 章节模式：BE 返回章节业务数据与标记 → FE 维护本地状态并在编辑器中渲染 → 报告大纲从 DOM 解析 → 按章节保存（可带业务元信息）→ BE 可拼整页存储/导出。
- 整页模式：BE 返回 `{ html, css?, metaMap? }`（含 `<h* data-chapter-id>`）→ FE 解析大纲/定位，渲染可只读或可编辑；如需编辑/保存，按整页提交（全文 HTML+样式），避免 FE 拆分回章节。

## 样式与安全
- 样式策略：整页接口统一返回 `css`（文本 CSS），命名空间建议 `rp-*`，FE 不再手工拼样式。
- 安全：BE 清洗脚本/事件与资源域；FE 保持隔离渲染（如 iframe / Shadow DOM），必要时二次白名单校验。

## 落地建议（阶段）
1) 合同定稿：锁定章节字段、标记格式、整页返回形态；BE 补充 CSS 传递与拼接能力。  
2) 章节接入：FE 编辑器注入全文样式，保持现有三栏/报告大纲/保存；保存可带业务元信息，BE 清洗落盘。  
3) 整页兜底/预览：FE 支持整页解析与只读渲染，章节树异常时自动切换兜底并埋点。  
4) 保存策略决策：评估是否支持“整页回传”；若支持，明确拆分/清洗归属与幂等性；敲定 metaMap 最小字段。

## 验收关注
- 样式可复用且无全局污染；三栏/报告大纲/自动保存不回退。
- 树异常时整页兜底可用，仍保留大纲/定位/引用。
- 指标：渲染模式分布、样式加载成功/降级率、章节保存成功率、整页兜底触发率、首屏/长文耗时（抽样）。

## 待决策
- 整页回传是否落地？若落地，拆分/清洗归属与流程。  
- metaMap 最小字段集（仅业务元信息，不含标题/顺序）。  
- 样式/资产域名白名单与失败兜底由谁负责、如何告警。  
