# 流式生成触发Content Change和自动保存问题修复

## 任务概览

| 项目 | 内容 |
| --- | --- |
| 任务来源 | 流式生成结束时触发content change事件，导致频繁自动保存 |
| 负责人 | AIGC前端组 |
| 上线目标 | 修复流式生成结束时的自动保存问题，避免性能浪费和服务器压力 |
| 当前版本 | v1.0 |
| 关联文档 | [原Issue](../issues/archived/streaming-end-content-change.md) |
| 状态 | ✅ 已完成 |

## 背景与上下文

流式生成章节内容时，内容会实时更新到编辑器。生成结束后执行 `chapter-rehydrate` 注水任务，应该不触发 content change 事件和自动保存。

然而，当前实现中 `updateChapterContent` 调用 `requestDomSync()` 触发 DOM 同步，DOM 同步修改节点后触发编辑器 `change` 事件，`onContentChange` 回调更新 `documentDraft.lastSyncAt`，触发自动保存逻辑，导致流式生成结束时频繁自动保存。

## 需求提炼

### 必达能力
1. 修复流式生成结束时的自动保存问题
2. 确保注水操作不触发content change事件
3. 保持用户编辑仍能正常触发保存
4. 避免性能浪费和服务器压力
5. 维护现有功能不受影响

### 约束条件
1. 不影响现有功能
2. 保持用户体验一致
3. 确保修复过程中系统稳定性
4. 与现有状态管理机制兼容
5. 不引入新的性能问题

## 方案设计

### 问题根因
1. **DOM同步触发change事件**：`updateChapterContent` 调用 `requestDomSync()` 触发 DOM 同步
2. **DOM修改触发编辑器事件**：DOM 同步修改节点后触发编辑器 `change` 事件
3. **自动保存逻辑触发**：`onContentChange` 回调更新 `documentDraft.lastSyncAt`，触发自动保存逻辑
4. **无法区分用户编辑和程序注水**：系统无法区分是用户编辑还是程序注水导致的内容变化

### 解决方案设计
**核心思路**：在 EditorFacade 中新增 `undoManager.ignore` 封装，将注水操作置于静默事务，确保注水操作不触发change事件。

1. **新增静默执行方法**：
   - 在 EditorFacade 中新增 `undoManager.ignore` 封装
   - 将注水操作置于静默事务中执行

2. **修改注水更新方法**：
   - `setFullContent` / `updateChapterContent` / `updateStreamingSection` 统一进入静默事务执行写入
   - 通过 `requestDomSync({ silent: true })` 触发静默 DOM 同步

3. **支持静默DOM同步**：
   - `useEditorDomSync` 支持 `silent` 模式
   - 静默补齐章节 ID、序号，避免触发 `change` 事件和自动保存

4. **保持用户编辑正常**：
   - 确保用户编辑仍通过 `onContentChange` 触发保存
   - 不影响正常的用户交互和保存功能

## 实施拆解

| 子任务 | 模块 | 方法 | 负责人 | 预计交付时间 |
| ---- | ---- | ---- | --- | --- |
| 1. 新增静默执行方法 | domain/reportEditor/editor | EditorFacade.ignore | 已完成 | 2025-10-27 |
| 2. 修改注水更新方法 | hooks | setFullContent等 | 已完成 | 2025-10-27 |
| 3. 支持静默DOM同步 | hooks | useEditorDomSync | 已完成 | 2025-10-27 |
| 4. 测试流式生成 | test | 流式生成测试 | 已完成 | 2025-10-27 |
| 5. 测试用户编辑 | test | 用户编辑测试 | 已完成 | 2025-10-27 |

## 验收记录

### 功能验收用例
1. **流式生成验证**：触发全文生成，观察保存状态不应频繁变化
2. **用户编辑验证**：流式生成期间手动编辑，验证仍能正常保存
3. **网络请求验证**：检查网络请求，确认无多余保存请求
4. **多种场景验证**：测试不同流式生成场景，确认都能正确处理
5. **边界情况验证**：测试各种边界情况，确保都能正常工作

### 非功能风险
- 标记管理不当可能导致保存功能失效
- 需要确保所有注水路径都正确设置标记
- 静默执行可能影响某些依赖change事件的功能

## 实现说明

### 与设计差异
- 完全按照设计方案实现，无差异

### 关键PR
- 暂无，待补充

### 可复用经验
1. 静默执行是解决程序操作触发用户事件的有效方法
2. 统一的接口设计可以简化多个方法的修改
3. 全面的测试用例是确保修复效果的关键
4. 保持用户操作正常的同时修复程序问题是设计的关键考虑

## 更新记录

| 日期 | 修改人 | 更新内容 |
| --- | --- | --- |
| 2025-10-22 | AIGC前端组 | 初始创建，识别流式生成触发保存问题 |
| 2025-10-27 | AIGC前端组 | 注水阶段进入 undo ignore + 静默 DOM 同步 |
| 2025-10-27 | AIGC前端组 | 验证完成，标记 issue resolved |
| 2025-01-09 | - | 从Issue文档转换为Spec格式，创建初始版本 |

---
**状态**：✅ 已完成  
**创建时间**：2025-10-27  
**优先级**：🟡 中  
**影响范围**：流式生成、自动保存、DOM同步功能  
**预估工期**：2 人日  
**实际工期**：2 人日