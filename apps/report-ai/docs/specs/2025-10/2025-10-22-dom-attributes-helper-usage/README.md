# DOM属性直接调用Constants问题修复

## 任务概览

| 项目 | 内容 |
| --- | --- |
| 任务来源 | 代码中直接使用constants而非统一的domAttributes helper，导致维护成本高、类型安全弱 |
| 负责人 | - |
| 上线目标 | 统一DOM属性操作接口，提高代码一致性和类型安全性 |
| 当前版本 | v1.0 |
| 关联文档 | [原Issue](../issues/archived/dom-attributes-helper-usage.md) |
| 状态 | 🚧 进行中 |

## 背景与上下文

项目已建立`domAttributes.ts`提供统一的DOM属性操作接口，目的是封装底层constants细节，提供类型安全和一致性。然而，多个模块直接引用`constants.ts`中的常量进行DOM操作，绕过了统一接口。

`domAttributes.ts`是后期引入的抽象层，早期代码直接使用constants，且接口未覆盖所有场景，导致代码不一致、维护成本高、类型安全弱。

## 需求提炼

### 必达能力
1. 扩展`domAttributes.ts`接口，补充缺失方法
2. 迁移高频使用场景到统一接口
3. 添加ESLint规则禁止直接导入`constants.ts`
4. 确保所有DOM操作通过统一接口进行

### 约束条件
1. 不影响现有功能
2. 保持代码性能
3. 确保类型安全
4. 与现有代码结构兼容

## 方案设计

### 问题根因
1. **接口不完整**：`domAttributes.ts`接口未覆盖所有使用场景
2. **历史遗留**：早期代码直接使用constants，未迁移到新接口
3. **缺乏约束**：没有ESLint规则禁止直接引用constants

### 解决方案设计
**核心思路**：扩展统一接口，迁移现有代码，添加规则约束，确保所有DOM操作通过统一接口进行。

1. **扩展`domAttributes.ts`接口**：
   - 补充缺失的DOM操作方法
   - 确保接口覆盖所有使用场景
   - 提供类型安全的操作方法

2. **迁移高频使用场景**：
   - 优先迁移`chapterId/ops.ts`（12处）
   - 然后迁移`chapter/render.ts`（6处）
   - 最后迁移`chapterOrdinal/ops.ts`（4处）
   - 逐步迁移其他文件（约18处）

3. **添加ESLint规则**：
   - 禁止直接导入`constants.ts`
   - 强制使用`domAttributes.ts`接口
   - 确保新代码遵循统一规范

## 实施拆解

| 子任务 | 模块 | 方法 | 负责人 | 预计交付时间 |
| ---- | ---- | ---- | --- | --- |
| 1. 扩展domAttributes.ts接口 | domAttributes.ts | 补充缺失方法 | - | 2025-10-27 |
| 2. 迁移chapterId/ops.ts | chapterId/ops.ts | 替换直接属性操作 | - | 2025-10-28 |
| 3. 迁移chapter/render.ts | chapter/render.ts | 替换直接属性操作 | - | 2025-10-28 |
| 4. 迁移chapterOrdinal/ops.ts | chapterOrdinal/ops.ts | 替换直接属性操作 | - | 2025-10-29 |
| 5. 迁移其他文件 | 多个文件 | 替换直接属性操作 | - | 2025-10-29 |
| 6. 添加ESLint规则 | ESLint配置 | 禁止直接导入constants | - | 2025-10-29 |
| 7. 更新开发文档 | 文档 | 更新使用指南 | - | 2025-10-29 |

## 验收记录

### 功能验收用例
1. **接口完整性验证**：确认domAttributes.ts接口覆盖所有使用场景
2. **迁移功能验证**：确认迁移后功能正常，无回归
3. **类型安全验证**：确认所有DOM操作类型安全
4. **ESLint规则验证**：确认规则能正确拦截直接引用
5. **性能验证**：确认迁移后性能无明显下降

### 非功能风险
- 可能存在未被搜索到的间接引用
- helper增加抽象层，需关注高频操作性能
- 迁移过程中可能引入新的bug

## 实现说明

### 与设计差异
- 暂无实现，无差异

### 关键PR
- 暂无，待补充

### 可复用经验
1. 统一接口可以提高代码一致性和可维护性
2. ESLint规则可以确保新代码遵循规范
3. 分阶段迁移可以降低风险
4. 完整的接口设计是成功迁移的关键

## 更新记录

| 日期 | 修改人 | 更新内容 |
| --- | --- | --- |
| 2025-10-22 | - | 初始创建，识别问题并制定重构方案 |
| 2025-01-09 | - | 从Issue文档转换为Spec格式，创建初始版本 |

---
**状态**：🚧 进行中  
**创建时间**：2025-10-22  
**优先级**：🟡 中  
**影响范围**：DOM操作相关代码  
**预估工期**：6 人日  
**实际工期**：-