# 验证与风险 - 文本 AI 重写

> 📖 回链：[任务概览](./README.md) | 阶段：验证与风险

## 测试策略

- **单元测试**
  - 选区 API：验证合法性检查、快照存取、恢复失败分支。
  - 改写调度：状态流转、重复请求拦截、`abort`/`reject` 分支清理。
  - 会话管理：`resetSession` 会清空消息、预览与锁。
  - 预览桥接：数据透传、确认/拒绝回调。
- **集成测试**
  - 场景一：选区 → 改写 → 流式消息 → 用户确认 → 内容替换 → 脏标记 → 清理完成。
  - 场景二：改写失败或用户拒绝 → 快照回滚 → 状态重置 → 预览卸载。
  - 场景三：流式中途中断 → 预览卸载 → TinyMCE 内容保持原状。
- **E2E（Playwright）**
  - 用户点击入口触发改写并走完确认流程。
  - 快捷键触发改写并验证拒绝流程。
  - 验证连续两次改写不会残留上一轮消息或预览。

## 验收重点

- 改写完成后仅触发一次 DOM 替换，且 `hasDirty` 立即更新。
- 拒绝流程会恢复原选区，预览组件被清理，不留悬浮残留。
- 预览不可用时触发降级提示，但主流程可继续完成。
- `useStreamingPreview` 未向 TinyMCE 注入改写流式消息。

## 风险验证

1. **选区超时**：模拟 60 秒以上延迟，确认会话被终止并给出提示。
2. **消息异常**：注入损坏消息，确保 Hook 捕获并执行回退。
3. **状态竞争**：并发触发两次改写，应拒绝第二次并提示全局忙碌。
4. **流式误注水**：人为启动 `useStreamingPreview` 注水，确认守卫拦截并记录日志。

## 降级与回滚

- 预览组件异常：记录日志，使用 Toast + 文本面板替代，允许用户手动复制内容。
- 服务故障：保持选区与快照，展示“稍后重试”按钮，必要时关闭入口。
- 回滚流程：撤销改写入口、恢复旧版本 Hook、同步公告。
- 残留清理：回滚前执行 `resetSession`，确保消息与预览容器被卸载。

## 相关文档

- [实施拆解](./spec-implementation-v1.md) @see 子任务拆解
- [测试规范](../../../../../docs/rule/testing-rule.md) @see 测试标准

## 更新记录

| 日期       | 修改人 | 更新内容                                   |
| ---------- | ------ | ------------------------------------------ |
| 2025-11-04 | Codex  | 收敛测试范围至核心流程，新增清理与隔离校验 |
| 2025-10-29 | Kiro   | 精简至 150 行                              |
