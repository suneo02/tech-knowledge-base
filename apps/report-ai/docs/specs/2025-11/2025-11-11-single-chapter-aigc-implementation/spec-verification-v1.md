# 单章节 AIGC 验证计划

> 📖 回链：[任务概览](./README.md) | 阶段：验证策划

## 验证策略

- **分层测试**：Hook 单测覆盖状态流转，组件 UT 验证交互，Vitest 集成用例验证流程闭环，E2E 检查真实环境表现。
- **重点路径**：触发、流式更新、完成收尾、失败重试、取消回滚五条主干必须全部覆盖。
- **数据校验**：对比全文生成指标，确认延迟/耗时达成既定目标（首条 <2s、总耗时 <30s、注水 <1s）。

## 测试矩阵

| 编号 | 场景                     | 步骤概要                                                                 | 期望结果                                                                 | 类型   |
| ---- | ------------------------ | ------------------------------------------------------------------------ | ------------------------------------------------------------------------ | ------ |
| C1   | 正向生成流程             | 触发单章节生成 → 接收流式消息 → 注水完成                                | 进度线性增长，完成后状态清理，章节可编辑                                 | 集成   |
| C2   | 失败后重试               | 模拟 AI 返回错误 → 显示失败按钮 → 点击重试                              | 状态重置，重新触发生成，失败提示消失                                     | 单测 + 集成 |
| C3   | 用户取消                 | 触发生成 → 中途点击取消                                                 | 请求终止，章节恢复原内容，状态回到 idle                                  | 集成   |
| C4   | 网络抖动 & 延迟          | 注入 2s 延迟 + 间歇性超时                                               | 首条消息仍 <2s，超时触发重试，日志记录超时事件                           | E2E    |
| C5   | 并发冲突（全文生成进行中） | 全文生成执行 → 触发单章节生成                                           | 拦截请求，提示“全文生成进行中”，不进入单章节流程                        | 单测   |
| C6   | 指标采集                 | 跑通主流程，校验监控探针输出                                            | 触发四类事件的埋点，监控平台可看到延迟/耗时/失败率数据                   | 集成   |
| C7   | 文档同步                 | 查看文档与 Storybook                                                     | `single-chapter-aigc-flow.md`、Storybook 场景与实现一致                   | 文档巡检 |

## 工具与环境

- **自动化**：Vitest + Testing Library；E2E 使用 Playwright（Mock AI 接口）。
- **Mock 服务**：`/api/aigc/single-chapter` 提供 200/500/超时三类响应模拟。
- **监控联调**：通过 Dev 环境的 AIGC 看板观察延迟和错误率。

## 验收标准

- 以上测试矩阵全部执行并通过，缺陷级别不高于 `Major`。
- 所有指标监控可在观测面板实时看到数据，采集字段完整。
- 文档、Release Note、Spec 状态更新同步。

## 风险与回滚检查

- 重点关注取消与重试导致的状态残留；需要在 QA 阶段重点复测。
- 若 Feature Flag 打开后出现异常，可立即回滚到全文生成入口；保留开关脚本。

## 更新记录

| 日期       | 修改人 | 更新内容                       |
| ---------- | ------ | ------------------------------ |
| 2025-10-30 | Kiro   | 首版验证计划，补充测试矩阵清单 |
