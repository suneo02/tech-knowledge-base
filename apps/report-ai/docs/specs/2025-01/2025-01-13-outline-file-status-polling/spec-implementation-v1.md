# å¤§çº²æ–‡ä»¶è§£æçŠ¶æ€è½®è¯¢ - å®æ–½è®¡åˆ’ v1

> å›é“¾ï¼š[ä»»åŠ¡æ¦‚è§ˆ](./README.md)  
> çŠ¶æ€ï¼šğŸš§ å¾…å®æ–½

## ä»»åŠ¡æ‹†è§£

| å­ä»»åŠ¡ | æè¿°                    | è´Ÿè´£äºº | é¢„è®¡äº¤ä»˜   | çŠ¶æ€ |
| ------ | ----------------------- | ------ | ---------- | ---- |
| T1     | åˆ›å»ºæ–‡ä»¶æå–å·¥å…·å‡½æ•°    | Kiro   | 2025-01-13 | âœ…   |
| T2     | åˆ›å»ºå¤§çº²æ–‡ä»¶è½®è¯¢ Hook   | Kiro   | 2025-01-13 | âœ…   |
| T3     | åˆ›å»ºè½®è¯¢æ§åˆ¶å™¨ç»„ä»¶      | Kiro   | 2025-01-13 | âœ…   |
| T4     | æ‰©å±• RPOutline Context  | Kiro   | 2025-01-13 | âœ…   |
| T5     | é›†æˆåˆ° ChatOutline é¡µé¢ | Kiro   | 2025-01-13 | âœ…   |
| T6     | æ·»åŠ æ–‡ä»¶çŠ¶æ€ UI æ˜¾ç¤º    | Kiro   | 2025-01-13 | âœ…   |
| T7     | æµ‹è¯•ä¸éªŒæ”¶              | Kiro   | å¾…æµ‹è¯•     | ğŸš§   |

## æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„                                                             | è¯´æ˜                                 | ä»»åŠ¡ |
| -------------------------------------------------------------------- | ------------------------------------ | ---- |
| `src/domain/file/outlineFileExtractor.ts`                            | æ–‡ä»¶æå–é¢†åŸŸé€»è¾‘ï¼ˆå¤ç”¨ç°æœ‰çŠ¶æ€åˆ¤æ–­ï¼‰ | T1   |
| `src/hooks/RPOutline/useOutlineFilePolling.ts`                       | å¤§çº²æ–‡ä»¶è½®è¯¢ Hook                    | T2   |
| `src/components/ChatRPOutline/OutlineFilePollingController.tsx`      | è½®è¯¢æ§åˆ¶å™¨ç»„ä»¶                       | T3   |
| `src/components/File/OutlineFileList/index.tsx`                      | å¤§çº²æ–‡ä»¶åˆ—è¡¨ç»„ä»¶ï¼ˆæ›¿ä»£ FileDisplayï¼‰ | T6   |
| `src/components/File/UploadedFileItem/index.tsx`                     | å·²ä¸Šä¼ æ–‡ä»¶é¡¹ç»„ä»¶ï¼ˆæ›¿ä»£ FileItemï¼‰    | T6   |
| `src/components/ChatRPOutline/OutlineFilePollingController.test.tsx` | æ§åˆ¶å™¨ç»„ä»¶æµ‹è¯•                       | T7   |

### ä¿®æ”¹æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„                                         | æ”¹åŠ¨è¯´æ˜                                 | ä»»åŠ¡ |
| ------------------------------------------------ | ---------------------------------------- | ---- |
| `src/context/RPOutline.tsx`                      | æ·»åŠ  `updateFileStatus` æ–¹æ³•             | T4   |
| `src/pages/ChatOutline/index.tsx`                | é›†æˆ `OutlineFilePollingController`      | T5   |
| `src/components/ChatRPOutline/roles/user.tsx`    | æ”¯æŒ refFiles æ˜¾ç¤º                       | T6   |
| `src/types/chat/RPOutline.ts`                    | ä½¿ç”¨ RPFileUnified æ›¿ä»£ RPFileUploaded   | T4   |
| `src/components/File/FileDisplay/index.tsx`      | æ”¯æŒ RPFileUnified å’Œ refFiles           | T6   |
| `src/components/File/FileItem/index.tsx`         | æ”¯æŒ RPFileUnifiedï¼Œä½¿ç”¨ FileStatusBadge | T6   |
| `src/components/File/OutlineFileList/index.tsx`  | å¤§çº²æ–‡ä»¶åˆ—è¡¨ç»„ä»¶ï¼ˆæ›¿ä»£ FileDisplayï¼‰     | T6   |
| `src/components/File/UploadedFileItem/index.tsx` | å·²ä¸Šä¼ æ–‡ä»¶é¡¹ç»„ä»¶ï¼ˆæ›¿ä»£ FileItemï¼‰        | T6   |

### ä¾èµ–æ–‡ä»¶ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰

| æ–‡ä»¶è·¯å¾„                              | è¯´æ˜            |
| ------------------------------------- | --------------- |
| `src/hooks/useFileStatusPolling.ts`   | å¤ç”¨çš„è½®è¯¢ Hook |
| `src/types/file/index.ts`             | æ–‡ä»¶ç±»å‹å®šä¹‰    |
| `packages/gel-api/src/chat/types/...` | API ç±»å‹å®šä¹‰    |

## å®æ–½é¡ºåº

### é˜¶æ®µä¸€ï¼šåŸºç¡€è®¾æ–½ï¼ˆT1-T2ï¼‰

1. åˆ›å»ºæ–‡ä»¶æå–å·¥å…·

   - è¾“å…¥ï¼šæ¶ˆæ¯åˆ—è¡¨
   - è¾“å‡ºï¼šå¾…è§£ææ–‡ä»¶ ID åˆ—è¡¨
   - è¿‡æ»¤æ¡ä»¶ï¼šstatus !== FINISHED && status !== FAILED

2. åˆ›å»ºå¤§çº²æ–‡ä»¶è½®è¯¢ Hook
   - é›†æˆ `useFileStatusPolling`
   - è¿æ¥ RPOutline Context
   - å¤„ç†çŠ¶æ€æ›´æ–°

### é˜¶æ®µäºŒï¼šé›†æˆï¼ˆT3-T5ï¼‰

3. åˆ›å»ºè½®è¯¢æ§åˆ¶å™¨ç»„ä»¶

   - æ—  UI çº¯é€»è¾‘ç»„ä»¶
   - ä½¿ç”¨ `useOutlineFilePolling`
   - æŒ‚è½½åœ¨ ChatOutline é¡µé¢

4. æ‰©å±• Context

   - æ·»åŠ  `updateFileStatus` æ–¹æ³•
   - æ”¯æŒæ‰¹é‡æ›´æ–°
   - ä¿æŒæ¶ˆæ¯ä¸å¯å˜æ€§

5. é›†æˆåˆ°é¡µé¢
   - åœ¨ ChatOutline ä¸­æ·»åŠ æ§åˆ¶å™¨
   - ç¡®ä¿åœ¨ Provider å†…éƒ¨

### é˜¶æ®µä¸‰ï¼šUI ä¸æµ‹è¯•ï¼ˆT6-T7ï¼‰

6. æ·»åŠ æ–‡ä»¶çŠ¶æ€ UI

   - åœ¨ç”¨æˆ·æ¶ˆæ¯ä¸­æ˜¾ç¤ºæ–‡ä»¶çŠ¶æ€
   - æ”¯æŒ files å’Œ refFiles
   - æ˜¾ç¤ºè§£æè¿›åº¦

7. æµ‹è¯•ä¸éªŒæ”¶
   - å•å…ƒæµ‹è¯•ï¼šå·¥å…·å‡½æ•°ã€Hook
   - é›†æˆæµ‹è¯•ï¼šå®Œæ•´æµç¨‹
   - æ‰‹åŠ¨æµ‹è¯•ï¼šå¤šæ–‡ä»¶åœºæ™¯

## æŠ€æœ¯ä¾èµ–

- ahooks `useRequest`
- React Context API
- ç°æœ‰ `useFileStatusPolling` Hook
- `gel-api` ç±»å‹å®šä¹‰

## é£é™©ä¸åº”å¯¹

| é£é™©                      | å½±å“ | åº”å¯¹æªæ–½                       |
| ------------------------- | ---- | ------------------------------ |
| Context æ›´æ–°å¯¼è‡´æ€§èƒ½é—®é¢˜  | ä¸­   | ä½¿ç”¨ useMemo ä¼˜åŒ–ï¼Œæ‰¹é‡æ›´æ–°    |
| å¤šä¸ªæ–‡ä»¶åŒæ—¶è½®è¯¢ API å‹åŠ› | ä½   | å·²æœ‰é˜²æŠ–å’Œæ‰¹é‡æŸ¥è¯¢æœºåˆ¶         |
| é¡µé¢åˆ‡æ¢æ—¶è½®è¯¢çŠ¶æ€ä¸¢å¤±    | ä½   | ä½¿ç”¨ pollingWhenHidden é…ç½®    |
| æ–‡ä»¶çŠ¶æ€æ›´æ–°ä¸åŠæ—¶        | ä¸­   | è°ƒæ•´è½®è¯¢é—´éš”ï¼Œæ·»åŠ æ‰‹åŠ¨åˆ·æ–°æŒ‰é’® |

## éªŒæ”¶æ ‡å‡†

- âœ… ä¸Šä¼ æ–‡ä»¶åè‡ªåŠ¨å¼€å§‹è½®è¯¢
- âœ… æ–‡ä»¶çŠ¶æ€å®æ—¶æ›´æ–°åˆ° UI
- âœ… è§£æå®Œæˆååœæ­¢è½®è¯¢è¯¥æ–‡ä»¶
- âœ… æ”¯æŒåŒæ—¶è½®è¯¢å¤šä¸ªæ–‡ä»¶
- âœ… é¡µé¢åˆ·æ–°åæ¢å¤è½®è¯¢
- âœ… è§£æå¤±è´¥æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
- âœ… æ€§èƒ½æµ‹è¯•ï¼š10 ä¸ªæ–‡ä»¶åŒæ—¶è½®è¯¢æ— å¡é¡¿

## ç›¸å…³æ–‡æ¡£

- [éœ€æ±‚åˆ†æ](./spec-requirement-v1.md)
- [æŠ€æœ¯è®¾è®¡](./spec-design-v1.md)

## å®æ–½æ€»ç»“

æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å·²å®Œæˆå®ç°ï¼ˆå·²ä¼˜åŒ– v3ï¼‰ï¼š

1. âœ… æ–‡ä»¶æå–å·¥å…· - ç§»è‡³ domain/fileï¼Œå¤ç”¨ `isReportFileStatusMutable` åˆ¤æ–­é€»è¾‘
2. âœ… è½®è¯¢ Hook - é›†æˆç°æœ‰ useFileStatusPolling
3. âœ… æ§åˆ¶å™¨ç»„ä»¶ - æ—  UI çº¯é€»è¾‘ç»„ä»¶
4. âœ… Context é›†æˆ - é€šè¿‡ updateFileStatus æ–¹æ³•æ›´æ–°çŠ¶æ€
5. âœ… é¡µé¢é›†æˆ - æ·»åŠ åˆ° ChatOutline é¡µé¢
6. âœ… UI æ˜¾ç¤º - ä½¿ç”¨ FileStatusBadge ç»„ä»¶æ˜¾ç¤ºæ–‡ä»¶çŠ¶æ€
7. âœ… ç±»å‹ä¼˜åŒ– - å®šä¹‰ `RPOutlineFile` ç±»å‹ï¼ˆRPFile | RPFileUploadedï¼‰
8. âœ… ç»„ä»¶é‡å‘½å - `OutlineFileList` å’Œ `UploadedFileItem` æ›´è¯­ä¹‰åŒ–
9. âœ… ä»£ç å¤ç”¨ - æ–‡ä»¶ç±»å‹æ£€æµ‹é€»è¾‘ç§»è‡³ domain/fileï¼Œæ¶ˆé™¤é‡å¤ä»£ç 

## æ›´æ–°è®°å½•

| æ—¥æœŸ       | ä¿®æ”¹äºº | æ›´æ–°å†…å®¹        |
| ---------- | ------ | --------------- |
| 2025-01-13 | Kiro   | åˆ›å»ºå®æ–½è®¡åˆ’ v1 |
| 2025-01-13 | Kiro   | å®Œæˆæ‰€æœ‰å®æ–½    |
