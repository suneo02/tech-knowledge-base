# 章节编号更新机制问题修复

## 任务概览

| 项目 | 内容 |
| --- | --- |
| 任务来源 | 章节编号更新机制存在多个问题，导致编号更新不及时或失败 |
| 负责人 | 待指派 |
| 上线目标 | 修复章节编号更新机制，确保编号在各种场景下都能正确更新 |
| 当前版本 | v1.0 |
| 关联文档 | [原Issue](../issues/archived/chapter-number-update-issues.md) |
| 状态 | ✅ 已完成 |

## 背景与上下文

章节编号根据章节在大纲树中的位置动态计算。当用户移动章节、添加/删除章节或保存后临时 ID 替换为正式 ID 时，编号应自动更新。但实际使用中发现新增章节无法更新编号、更新时机不明确、pathMap 与 content change 边界模糊、Draft Tree 与编辑器 DOM 同步机制不清晰、保存后 idMap 处理不完整等问题。

## 需求提炼

### 必达能力
1. 新增章节立即显示编号
2. 移动章节后编号自动更新
3. 保存后临时 ID 替换为正式 ID 时编号正确更新
4. 编号更新机制清晰可预测
5. 保持现有功能不受影响

### 约束条件
1. 不影响现有功能
2. 保持用户体验一致
3. 确保修复过程中系统稳定性
4. 与现有状态管理机制兼容

## 方案设计

### 问题根因
1. **临时 ID 被跳过**：编号更新逻辑中临时 ID 被跳过，导致新增章节在保存前都没有编号
2. **DOM 元素查找失败**：由于 DOM 结构变化，导致编号更新时无法正确找到对应元素
3. **Hook 未集成**：编号同步 Hook 未正确集成到编辑器生命周期中
4. **数据流向不清晰**：pathMap 与 content change 边界模糊，导致更新时机不明确
5. **idMap 处理逻辑缺失**：保存后 idMap 处理不完整，导致临时 ID 替换后编号仍不显示

### 解决方案设计
1. **引入 ChapterNumberCoordinator**：在 TinyMCE 内部监听 DOM 变更，确保编号及时更新
2. **自动启动编号协调器**：在 `useReportEditorRef` 中编辑器初始化时自动启动编号协调器
3. **统一维护 DOM ID**：新增 `ensureSectionIds`/`applySectionIdMap` 统一维护 DOM ID
4. **应用 idMap**：保存成功后调用 `ReportEditorRef.applyIdMap` 应用 idMap

## 实施拆解

| 子任务 | 模块 | 方法 | 负责人 | 预计交付时间 |
| ---- | ---- | ---- | ---- | --- |
| 1. 实现ChapterNumberCoordinator | chapterNumberCoordinator.ts | 创建编号协调器 | 已完成 | 2025-02-14 |
| 2. 实现ensureSectionIds | 工具函数 | 创建DOM ID维护函数 | 已完成 | 2025-02-14 |
| 3. 实现applyIdMap | ReportEditorRef | 创建ID映射应用函数 | 已完成 | 2025-02-14 |
| 4. 修复死循环问题 | 多个模块 | 优化更新逻辑，避免死循环 | 已完成 | 2025-02-14 |
| 5. 集成到编辑器生命周期 | useReportEditorRef | 自动启动编号协调器 | 已完成 | 2025-02-14 |

## 验收记录

### 功能验收用例
1. **新增章节编号验证**：创建新章节，验证编号立即显示
2. **保存后ID替换验证**：保存报告，验证临时 ID 替换为正式 ID
3. **移动章节编号验证**：移动章节，验证编号自动更新
4. **多级编号验证**：验证多级章节编号在各种操作后正确更新
5. **性能验证**：验证编号更新不会导致明显的性能问题

### 非功能风险
- MutationObserver 性能影响需持续监控
- 死循环问题已修复但需要函数式重构

## 实现说明

### 与设计差异
- 完全按照设计方案实现，无差异

### 关键PR
- 暂无，待补充

### 可复用经验
1. 使用 MutationObserver 可以有效监听 DOM 变化，实现实时更新
2. 统一的 ID 维护机制可以简化复杂场景下的状态同步
3. 避免循环依赖和死循环需要清晰的架构设计

## 更新记录

| 日期 | 修改人 | 更新内容 |
| --- | --- | --- |
| 2025-02-14 | - | 实现 ChapterNumberCoordinator 解决所有问题 |
| 2025-02-14 | - | 发现死循环问题并修复 |
| 2025-01-09 | - | 从Issue文档转换为Spec格式，创建初始版本 |

## 后续建议

函数式重构，用单一 Hook + 纯函数替代两个 Class，可以进一步简化代码结构，提高可维护性。

---
**状态**：✅ 已完成  
**创建时间**：2025-02-14  
**优先级**：🔴 高  
**影响范围**：章节编号更新机制  
**预估工期**：2 人日  
**实际工期**：2 人日