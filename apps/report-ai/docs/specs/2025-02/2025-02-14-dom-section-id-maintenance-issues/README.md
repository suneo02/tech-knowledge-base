# DOM元素ID维护问题修复

## 任务概览

| 项目 | 内容 |
| --- | --- |
| 任务来源 | 章节DOM元素data-section-id属性维护机制存在多个问题，影响章节定位和编号更新 |
| 负责人 | - |
| 上线目标 | 修复DOM元素ID维护问题，确保章节定位和编号更新正常工作 |
| 当前版本 | v1.0 |
| 关联文档 | [原Issue](../issues/archived/dom-section-id-maintenance-issues.md) |
| 状态 | ✅ 已完成 |

## 背景与上下文

章节在编辑器中以`<section data-section-id="xxx">`形式存在，`data-section-id`属性用于关联业务章节ID，是编号更新、章节定位、内容同步等功能的核心依据。

然而，DOM元素ID维护机制存在多个问题：新增章节的临时ID未写入DOM、保存后正式ID未同步到DOM、同步时机不明确、临时ID生命周期管理缺失、查找函数无容错机制。

## 需求提炼

### 必达能力
1. 新增章节时临时ID立即写入DOM
2. 保存成功后临时ID替换为正式ID
3. 明确的同步时机和机制
4. 完善的临时ID生命周期管理
5. 查找函数具备容错机制

### 约束条件
1. 不影响现有功能
2. 保持用户体验一致
3. 确保修复过程中系统稳定性
4. 与现有状态管理机制兼容

## 方案设计

### 问题根因
1. **临时ID未注入DOM**：临时ID生成后未写入DOM元素
2. **解析器只读不写**：解析器只读取DOM不修改DOM
3. **idMap处理逻辑缺失**：缺少处理idMap的逻辑
4. **数据流设计不明确**：缺少明确的数据流设计
5. **查找逻辑过于严格**：查找函数缺乏容错机制

### 解决方案设计
**核心思路**：实现自动补齐、ID替换、时机同步和专注维护的完整解决方案。

1. **ensureSectionIds自动补齐**：
   - 自动补齐标题节点的data-section-id
   - 确保新增章节立即可以定位

2. **applyIdMap替换临时ID**：
   - 保存成功后调用ReportEditorRef.applyIdMap
   - 替换临时ID为正式ID

3. **MutationObserver驱动的同步时机**：
   - ChapterNumberCoordinator负责同步时机
   - 基于DOM变化自动触发同步

4. **SectionIdMaintainer专注维护DOM ID**：
   - 专注于维护DOM ID
   - 提供可靠的ID维护机制

## 实施拆解

| 子任务 | 模块 | 方法 | 负责人 | 预计交付时间 |
| ---- | ---- | ---- | --- | --- |
| 1. 实现ensureSectionIds | 章节解析 | 自动补齐标题节点的data-section-id | 已完成 | 2025-02-14 |
| 2. 实现applyIdMap | ID同步工具 | 保存成功后替换临时ID | 已完成 | 2025-02-14 |
| 3. 实现ChapterNumberCoordinator | 章节编号 | MutationObserver驱动同步 | 已完成 | 2025-02-14 |
| 4. 实现SectionIdMaintainer | DOM维护 | 专注维护DOM ID | 已完成 | 2025-02-14 |
| 5. 修复死循环问题 | 多个模块 | 优化同步逻辑避免死循环 | 已完成 | 2025-02-14 |
| 6. 测试验证 | 测试 | 验证所有功能正常 | 已完成 | 2025-02-14 |

## 验收记录

### 功能验收用例
1. **创建新章节验证**：创建新章节，验证data-section-id立即写入
2. **保存报告验证**：保存报告，验证临时ID替换为正式ID
3. **章节定位验证**：使用findSectionElement查找章节，验证能正确定位
4. **编号更新验证**：验证章节编号更新功能正常
5. **死循环修复验证**：验证死循环问题已修复

### 非功能风险
- 临时ID唯一性需要更可靠的生成算法
- 需要函数式重构降低复杂度
- MutationObserver可能影响性能

## 实现说明

### 与设计差异
- 完全按照设计方案实现，无差异

### 关键PR
- 暂无，待补充

### 可复用经验
1. 自动补齐机制可以确保数据一致性
2. MutationObserver是监听DOM变化的有效方式
3. 专注单一职责的类更容易维护
4. 临时ID生命周期管理需要明确的设计

## 更新记录

| 日期 | 修改人 | 更新内容 |
| --- | --- | --- |
| 2025-02-14 | - | 实现SectionIdMaintainer解决所有问题 |
| 2025-02-14 | - | 发现死循环问题并修复 |
| 2025-01-09 | - | 从Issue文档转换为Spec格式，创建初始版本 |

---
**状态**：✅ 已完成  
**创建时间**：2025-02-14  
**优先级**：🔴 高  
**影响范围**：章节定位和编号更新功能  
**预估工期**：2 人日  
**实际工期**：2 人日