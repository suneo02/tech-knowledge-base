# AI 报告页面 - 技术设计总览

## 1. 项目概述

### 1.1 技术架构概览

AI 报告页面采用三栏布局设计，集成 AI 对话、报告编辑和大纲展示功能，基于 React + TypeScript 技术栈构建。

### 1.2 整体布局架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        顶部导航栏                                │
├─────────────┬─────────────────────────────┬─────────────────────┤
│             │                             │                     │
│   左侧区域   │         中间区域             │      右侧区域        │
│             │                             │                     │
│  AI 对话面板 │      报告内容编辑器           │    大纲展示面板      │
│             │                             │                     │
│   - 会话历史  │    - TinyMCE 编辑器        │   - 章节结构树       │
│   - 消息列表  │    - 实时保存             │   - 生成状态指示      │
│   - 输入框   │    - AI 辅助功能          │   - 章节导航         │
│             │                             │                     │
├─────────────┴─────────────────────────────┴─────────────────────┤
│                        底部状态栏                                │
└─────────────────────────────────────────────────────────────────┘
```

## 2. 技术架构设计

### 2.1 组件架构设计

| 组件层级     | 组件名称     | 主要职责             | 子组件             | 状态管理                                           |
| ------------ | ------------ | -------------------- | ------------------ | -------------------------------------------------- |
| **页面层**   | ReportAIPage | 页面布局和路由       | 三个主要面板       | 全局状态                                           |
| **布局层**   | MainLayout   | 响应式布局管理       | 左中右三栏         | 布局状态                                           |
| **功能层**   | ChatPanel    | AI 对话功能          | 消息列表、输入框   | 会话状态                                           |
| **功能层**   | EditorPanel  | 报告编辑功能         | 编辑器、工具栏     | 编辑状态                                           |
| **功能层**   | OutlinePanel | 大纲展示功能         | 树形结构、状态指示 | 大纲状态                                           |
| **组件层**   | 各功能组件   | 具体业务逻辑         | 原子组件           | 局部状态                                           |
| **扩展功能** | OutlineChat  | 大纲生成、编辑、确认 | -                  | [查看详情](./AI对话%20-%20大纲生成技术设计文档.md) |

### 2.2 数据流架构

```mermaid
graph TB
    A[URL 解析] --> B[路由参数提取]
    B --> C[报告 ID 获取]
    C --> D{并行数据加载}

    D --> E[会话 ID 获取]
    D --> F[章节信息获取]

    E --> G[会话内容还原]
    F --> H[章节结构解析]

    G --> I[左侧面板渲染]
    H --> J[右侧面板渲染]
    H --> K[编辑器初始化]

    K --> L[章节生成队列]
    L --> M[逐章节处理]
    M --> N[意图分析]
    N --> O[流式内容生成]
    O --> P[引用资料获取]
    P --> Q[内容最终整合]

    Q --> R[编辑器更新]
    R --> S[大纲状态同步]
```

### 2.3 状态管理架构

| 状态模块     | 状态内容               | 数据来源 | 更新时机      | 影响组件 |
| ------------ | ---------------------- | -------- | ------------- | -------- |
| **报告状态** | 报告基本信息、生成状态 | API 获取 | 页面初始化    | 全局组件 |
| **会话状态** | 消息列表、输入状态     | 会话 API | 消息收发      | 左侧面板 |
| **章节状态** | 章节列表、生成进度     | 章节 API | 生成过程      | 右侧面板 |
| **编辑状态** | 编辑内容、保存状态     | 编辑器   | 内容变化      | 中间面板 |
| **布局状态** | 面板宽度、响应式状态   | 用户交互 | 布局调整      | 布局组件 |
| **预览状态** | 预览模式、布局模式     | 预览交互 | 预览开始/结束 | 全局布局 |

## 3. 核心功能技术设计

### 3.1 页面初始化设计

```mermaid
sequenceDiagram
    participant U as 用户
    participant P as 页面
    participant API as 后端API
    participant Cache as 缓存

    U->>P: 访问页面 URL
    P->>P: 解析报告 ID
    P->>API: 获取会话 ID
    API->>P: 返回会话 ID

    par 并行加载
        P->>API: 获取会话内容
        API->>P: 返回消息列表
        P->>Cache: 缓存会话数据
    and
        P->>API: 获取章节信息
        API->>P: 返回章节结构
        P->>Cache: 缓存章节数据
    end

    P->>P: 渲染三个面板
    P->>U: 页面加载完成

    P->>P: 启动章节内容生成
    loop 遍历每个章节
        P->>API: 发起章节内容生成请求
        API->>P: 返回意图分析结果
        API->>P: 流式返回 AI 生成内容
        P->>P: 实时更新编辑器内容
        P->>P: 更新大纲生成状态
        API->>P: 返回引用资料
        P->>P: 整合最终章节内容
    end

    P->>P: 所有章节生成完成
```

### 3.2 AI 内容生成技术流程

| 生成阶段     | 处理内容       | 技术方案      | 数据流向    | 状态更新   |
| ------------ | -------------- | ------------- | ----------- | ---------- |
| **意图分析** | 章节上下文分析 | 同步 API 调用 | 前端 → 后端 | 分析中状态 |
| **内容生成** | 流式内容输出   | SSE 长连接    | 后端 → 前端 | 生成中状态 |
| **引用获取** | 相关资料查找   | 异步 API 调用 | 前端 → 后端 | 处理中状态 |
| **内容整合** | 最终内容组装   | 前端数据合并  | 本地处理    | 完成状态   |

### 3.3 流式数据处理设计

```mermaid
graph LR
    A[SSE 连接建立] --> B[数据流监听]
    B --> C{数据类型判断}

    C -->|内容数据| D[内容追加]
    C -->|状态数据| E[状态更新]
    C -->|完成信号| F[连接关闭]

    D --> G[编辑器更新]
    E --> H[大纲状态同步]
    F --> I[生成完成处理]

    G --> J[用户界面刷新]
    H --> J
    I --> J
```

### 3.4 实时同步机制设计

| 同步场景          | 触发条件      | 同步方式        | 数据传输      | 冲突处理 |
| ----------------- | ------------- | --------------- | ------------- | -------- |
| **编辑器 → 大纲** | 内容结构变化  | 解析标题层级    | 内存传递      | 重新解析 |
| **大纲 → 编辑器** | 点击章节导航  | 滚动定位        | 位置计算      | 平滑滚动 |
| **生成状态同步**  | AI 生成进度   | 状态广播        | 事件机制      | 状态覆盖 |
| **保存状态同步**  | 编辑内容保存  | 防抖保存        | HTTP 请求     | 重试机制 |
| **布局状态同步**  | 预览开始/结束 | Context状态管理 | React Context | 状态覆盖 |

### 3.5 动态布局设计

```mermaid
sequenceDiagram
    participant U as 用户
    participant R as ReferenceItem
    participant V as ReferenceView
    participant L as LayoutStateProvider
    participant P as ReportDetail页面

    U->>R: 点击文件/表格
    R->>V: 触发 onPreviewStart
    V->>L: 调用 expandForPreview()
    L->>P: 更新布局状态为 preview-expanded
    P->>P: 左侧面板收起(420px→0px)
    P->>P: 右侧面板扩大(420px→600px)
    P->>P: 应用0.3s过渡动画

    U->>V: 点击返回列表按钮
    V->>L: 调用 restoreNormalLayout()
    L->>P: 更新布局状态为 normal
    P->>P: 恢复正常布局
    P->>P: 应用0.3s过渡动画
```

| 布局状态             | 左侧面板宽度 | 右侧面板宽度 | 中间区域 | 过渡时间 |
| -------------------- | ------------ | ------------ | -------- | -------- |
| **normal**           | 420px        | 420px        | flex: 1  | -        |
| **preview-expanded** | 0px (隐藏)   | 600px        | flex: 1  | 0.3s     |

## 5. 接口设计规范

### 5.1 数据接口定义

| 接口类型             | 接口路径                                       | 数据格式         | 响应结构                      |
| -------------------- | ---------------------------------------------- | ---------------- | ----------------------------- |
| **获取会话ID**       | `/api/reports/{reportId}/session`              | 路径参数         | `{ sessionId: string }`       |
| **获取报告章节信息** | `/api/reports/{reportId}/sections`             | 路径参数         | `{ sections: SectionInfo[] }` |
| **获取单个章节信息** | `/api/reports/{reportId}/sections/{sectionId}` | 路径参数         | `{ section: SectionContent }` |
| **更新单个章节信息** | `/api/reports/{reportId}/sections/{sectionId}` | JSON（章节内容） | `{ section: SectionContent }` |
