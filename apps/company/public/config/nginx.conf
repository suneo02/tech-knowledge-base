
user	root;
worker_processes	auto;
error_log	/var/log/nginx/error.log;
pid				/run/nginx.pid;
include		/usr/share/nginx/modules/*.conf;

events {
	worker_connections	1024;
}


http {

	proxy_pass_request_headers	on;
	ignore_invalid_headers			off;
	
	log_format	main	'$remote_addr - $remote_user [$time_local] "$request" '
										'$status $body_bytes_sent "$http_referer" '
										'"$http_user_agent" "$http_x_forwarded_for"';

	access_log	/var/log/nginx/access.log	main;

	sendfile				on;
	tcp_nopush		 	on;
	tcp_nodelay		 	on;
	keepalive_timeout			65;
	types_hash_max_size 	4096;

	include			 /etc/nginx/mime.types;
	default_type	application/octet-stream;

	include			 /etc/nginx/conf.d/*.conf;

	client_max_body_size 50m;

	gzip	on;
	gzip_min_length 1k;
	gzip_buffers 4 16k;
	#gzip_http_version 1.0;
	gzip_comp_level 2;
	gzip_types text/plain application/x-javascript text/css application/xml text/javascript application/x-httpd-php image/jpeg image/gif image/png application/json application/javascript;
	gzip_vary off;
	gzip_disable "MSIE [1-6]\.";
	
	# 从这里开始替换
	upstream superlist {
		ip_hash;
		server localhost:80;
		keepalive 32;
	}
	
	upstream superlistApi {
		ip_hash;
		server 10.18.1.89:33311;
		server 10.18.1.220:33311;
		keepalive 32;
	}

	upstream windApi {
		ip_hash;
		server 10.10.5.161:80;
		keepalive 32;
	}
	
	server {
		listen			 80;
		listen			 [::]:80;
		server_name	localhost;

		#charset koi8-r;

		#access_log	logs/host.access.log	main;
				
		location /Wind.Bs.SuperList.Web/out_h5/ {
			root	 /wind/html/;
			try_files $uri /Wind.Bs.SuperList.Web/out_h5/index.html;
		}
		
		location /Wind.Bs.SuperList.Web/ {
			root	 /wind/html/;
			try_files $uri /Wind.Bs.SuperList.Web/index.html;
		}
		
		location /Wind.Bs.SuperList.Home/ {
			root	 /wind/html/;
			try_files $uri /Wind.Bs.SuperList.Home/index.html;
		}

    location /apple-app-site-association {
			default_type application/json;
			root	 /wind/html/Wind.Bs.SuperList.Web/;
		}

		location ~*^/Wind.WFC.Enterprise.Web/ {
			rewrite ^/Wind.WFC.Enterprise.Web/(.*) /superlist/api/Wind.WFC.Enterprise.Web/$1 break;
		}
		
		location ~*^/superlist/api(.*) {
			if ($request_method = OPTIONS ) { return 200; }
			add_header Access-Control-Allow-Origin "*";
			add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
			add_header Access-Control-Allow-Credentials true;
			add_header Access-Control-Allow-Headers "Accept,DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type, token, languageSet, client-type";
			add_header Access-Control-Max-Age 1728000;
			rewrite ^/superlist/(.*) /$1 break;
			proxy_pass http://superlistApi;
			
			proxy_set_header Host $http_host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header REMOTE-HOST $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		}

		location ~*^/superlist/logo(.*) {
			if ($request_method = OPTIONS ) { return 200; }
			add_header Access-Control-Allow-Origin "*";
			add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
			add_header Access-Control-Allow-Credentials true;
			add_header Access-Control-Allow-Headers "Accept,DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,wind.sessionid";
			add_header Access-Control-Max-Age 1728000;
			rewrite ^/superlist/logo/(.*) /ns/imagebase/$1 break;
			proxy_pass http://windApi;
			proxy_set_header Host "10.10.5.161";
		}

		location ~*^/superlist/biddingText(.*) {
			if ($request_method = OPTIONS ) { return 200; }
			add_header Access-Control-Allow-Origin "*";
			add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
			add_header Access-Control-Allow-Credentials true;
			add_header Access-Control-Allow-Headers "Accept,DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,wind.sessionid";
			add_header Access-Control-Max-Age 1728000;
			rewrite ^/superlist/biddingText/(.*) /ns/imagebase/$1 break;
			proxy_pass http://windApi;
			proxy_set_header Host "10.10.5.161";
		}

		location ~*^/superlist/ {
			rewrite ^/superlist/(.*) /Wind.Bs.SuperList.Web/$1 break;
		}

		location ~*^/wmap/api(.*) {
			if ($request_method = OPTIONS ) { return 200; }
			add_header Access-Control-Allow-Origin "*";
			add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
			add_header Access-Control-Allow-Credentials true;
			add_header Access-Control-Allow-Headers "Accept,DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,wind.sessionid";
			add_header Access-Control-Max-Age 1728000;
			proxy_pass http://windApi;
			proxy_set_header Host "10.10.5.161";
		}
		
		location ~*^/wmap(.*) {
			if ($request_method = OPTIONS ) { return 200; }
			add_header Access-Control-Allow-Origin "*";
			add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
			add_header Access-Control-Allow-Credentials true;
			add_header Access-Control-Allow-Headers "Accept,DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type";
			add_header Access-Control-Max-Age 1728000;
			proxy_pass http://windApi;
			proxy_set_header Host "10.10.5.161";
		}
		
		location ~*^/efasbew(.*) {
			if ($request_method = OPTIONS ) { return 200; }
			add_header Access-Control-Allow-Origin "*";
			add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
			add_header Access-Control-Allow-Credentials true;
			add_header Access-Control-Allow-Headers "Accept,DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Content-Length";
			add_header Access-Control-Max-Age 1728000;
			proxy_pass http://windApi;
			proxy_set_header Host "10.10.5.161";
		}
		
		location / {
			rewrite ^/(.*) /Wind.Bs.SuperList.Web/$1 break;
		}

		error_page	500 502 503 504	/50x.html;
		location = /50x.html {
			root	 html;
		}
	}
	
	# http访问域名重定向到https
	server {
		listen			 80;
		listen			 [::]:80;
		server_name	superlist.windinfo.com.cn;
		rewrite		 ^/(.*)$ https://superlist.windinfo.com.cn:443/$1 permanent;
	}
	
	server {
		listen			443 ssl http2;
		listen		 [::]:433 ssl http2;
		
		# 配置ssl证书
		server_name	*.windinfo.com.cn;
		
		ssl_certificate			"/etc/nginx/8071343__windinfo.com.cn.pem";
		ssl_certificate_key	"/etc/nginx/8071343__windinfo.com.cn.key";

				# ssl_session_cache		shared:SSL:1m;
				# ssl_session_timeout	5m;
		
		ssl_verify_depth 3;

		ssl_ciphers	HIGH:!aNULL:sha1;
		ssl_prefer_server_ciphers	on;
		ssl_protocols TLSv1.2;
		
		location /apple-app-site-association {
			default_type application/json;
			root	 /wind/html/Wind.Bs.SuperList.Web/;
		}

		location ~*^/Wind.WFC.Enterprise.Web/ {
			rewrite ^/Wind.WFC.Enterprise.Web/(.*) /superlist/api/Wind.WFC.Enterprise.Web/$1 break;
		}
		
		location ~*^/superlist/api(.*) {
			if ($request_method = OPTIONS ) { return 200; }
			add_header Access-Control-Allow-Origin "*";
			add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
			add_header Access-Control-Allow-Credentials true;
			add_header Access-Control-Allow-Headers "Accept,DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type, token, languageSet, client-type";
			add_header Access-Control-Max-Age 1728000;
			rewrite ^/superlist/(.*) /$1 break;
			proxy_pass http://superlistApi;
			
			proxy_set_header Host $http_host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header REMOTE-HOST $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		}

		location ~*^/superlist/logo(.*) {
			if ($request_method = OPTIONS ) { return 200; }
			add_header Access-Control-Allow-Origin "*";
			add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
			add_header Access-Control-Allow-Credentials true;
			add_header Access-Control-Allow-Headers "Accept,DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,wind.sessionid";
			add_header Access-Control-Max-Age 1728000;
			rewrite ^/superlist/logo/(.*) /ns/imagebase/$1 break;
			proxy_pass http://windApi;
			proxy_set_header Host "10.10.5.161";
			# proxy_cookie_path /ns/imagebase /superlist/logo;
			proxy_set_header Cookie $http_cookie;
		}

		location ~*^/superlist/biddingText(.*) {
			if ($request_method = OPTIONS ) { return 200; }
			add_header Access-Control-Allow-Origin "*";
			add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
			add_header Access-Control-Allow-Credentials true;
			add_header Access-Control-Allow-Headers "Accept,DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,wind.sessionid";
			add_header Access-Control-Max-Age 1728000;
			rewrite ^/superlist/biddingText/(.*) /ns/imagebase/$1 break;
			proxy_pass http://windApi;
			proxy_set_header Host "10.10.5.161";
			proxy_cookie_path /ns/imagebase /superlist/biddingText;
			proxy_set_header Cookie $http_cookie;
		}

		location ~*^/superlist/ {
			rewrite ^/superlist/(.*) /Wind.Bs.SuperList.Web/$1 break;
			proxy_pass http://superlist;
		}

		location ~*^/wmap/api(.*) {
			if ($request_method = OPTIONS ) { return 200; }
			add_header Access-Control-Allow-Origin "*";
			add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
			add_header Access-Control-Allow-Credentials true;
			add_header Access-Control-Allow-Headers "Accept,DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,wind.sessionid";
			add_header Access-Control-Max-Age 1728000;
			proxy_pass http://windApi;
			proxy_set_header Host "10.10.5.161";
		}
		
		location ~*^/wmap(.*) {
			if ($request_method = OPTIONS ) { return 200; }
			add_header Access-Control-Allow-Origin "*";
			add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
			add_header Access-Control-Allow-Credentials true;
			add_header Access-Control-Allow-Headers "Accept,DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type";
			add_header Access-Control-Max-Age 1728000;
			proxy_pass http://windApi;
			proxy_set_header Host "10.10.5.161";
		}
		
		location ~*^/efasbew(.*) {
			if ($request_method = OPTIONS ) { return 200; }
			add_header Access-Control-Allow-Origin "*";
			add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
			add_header Access-Control-Allow-Credentials true;
			add_header Access-Control-Allow-Headers "Accept,DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Content-Length";
			add_header Access-Control-Max-Age 1728000;
			proxy_pass http://windApi;
			proxy_set_header Host "10.10.5.161";
		}
		
		location / {
			rewrite ^/(.*) /Wind.Bs.SuperList.Web/$1 break;
			proxy_pass http://superlist;
		}

		error_page	500 502 503 504	/50x.html;
		location = /50x.html {
				root	 html;
		}
	}

}
