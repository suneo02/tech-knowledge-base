---
title: 英文环境流式请求 Hook 兼容问题 - 实现说明
version: v1
status: ✅ 已发布
---

[← 返回任务概览](/company/specs/xrequest-lang-param-stream-bug/README.md)

# 英文环境流式请求 Hook 兼容问题 - 实现说明 v1

## 1. 背景与问题

- 英文环境下（`isEn()` 为 `true`）AI Chat 流式接口请求抛出 `TypeError: e.includes is not a function`，请求未能送达。
- 错误发生在全局 fetch 监控 Hook（`@wind/wind-monitor-client`）对请求参数调用 `includes` 时，只有使用流式接口的模块暴露该异常。

## 2. 根因分析

- 我们在流式请求封装里为英文环境追加 `lang=en`，并将 `URL` 对象直接传入自定义 `fetch`。
- 监控 Hook 期望收到字符串 URL，并对入参执行 `includes`。当收到 `URL` 对象时触发类型错误，导致流式请求在发送前即失败。
- 其他模块未报错是因为它们仍传入字符串 URL，未触发 Hook 的类型假设。

## 3. 方案与实现

| 目标                 | 方案要点                                                                                             | 代码引用                                         |
| -------------------- | ---------------------------------------------------------------------------------------------------- | ------------------------------------------------ |
| 保持语言参数能力     | 继续在英文环境注入 `lang=en`，原始输入不可解析时降级为透传                                           | `/packages/gel-ui/src/service/xRequest.ts:35`    |
| 兼容监控 Hook 入参   | 在调用 `fetch` 前统一将 `RequestInfo \| URL` 归一为字符串（`URL`/`Request`/字符串均可）              | `/packages/gel-ui/src/service/xRequest.ts:9`     |
| 降级路径保持安全     | 即便增强逻辑失败，基础分支也做相同的字符串归一化，避免再次触发类型错误                               | `/packages/gel-ui/src/service/xRequest.ts:73`    |

实现结果：流式请求在英文环境可正常发出，监控 Hook 能继续采集请求与错误日志。

## 4. 验收要点

- 英文环境下触发一次流式请求，确认不再出现 `e.includes is not a function`，请求成功建立流并收到增量消息。
- 中文环境回归：参数追加逻辑不应改变已有行为，监控埋点仍可记录。
- 若引入新的 fetch 包装层，需沿用字符串归一化逻辑以兼容监控 Hook。

## 5. 更新记录

| 日期       | 修改人 | 更新内容                     |
| ---------- | ------ | ---------------------------- |
| 2025-11-25 | -      | 记录兼容方案与验收要点 v1    |
