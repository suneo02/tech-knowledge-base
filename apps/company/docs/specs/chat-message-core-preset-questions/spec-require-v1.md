# ChatMessageCore 预设问句需求文档 v1

> [返回 README](./README.md) | 阶段：需求提炼

## 元信息

| 字段     | 内容       |
| -------- | ---------- |
| 版本     | v1         |
| 最近更新 | 2025-10-29 |
| 评审状态 | 待评审     |
| 需求来源 | 待补充     |

## 背景与目标

### 业务背景

- ChatMessageCore 是企业详情页 AI 聊天面板的核心消息容器
- 用户首次进入或无历史对话时，缺少明确的引导，导致首问门槛高
- 预设问句可降低用户思考成本，提升对话启动率和留资转化效率

### 目标

- 在合适时机展示 3 条预设问句，引导用户快速开启对话
- 保持对现有消息流的最小侵入，不影响正常聊天体验
- 提供可扩展的问句管理能力，支持后续运营配置

## 用户场景

### 场景 1：首次进入，无历史消息

**触发条件**：`parsedMessages.length === 0`

**用户期望**：

- 在欢迎消息下方看到 3 条预设问句
- 点击任一问句即可发送，无需手动输入
- 发送后问句区域自动隐藏

**优先级**：P0（核心场景）

### 场景 2：有历史消息，但用户未发言

**触发条件**：

- 存在历史消息（系统消息或 AI 回复）
- 用户在当前页面未发送过消息（`isSentMsg = false`）

**用户期望**：

- 在最后一条历史消息后展示预设问句
- 带有视觉分割线，区分历史内容
- 点击后行为同场景 1

**优先级**：P0（核心场景）

### 场景 3：用户已发送过消息

**触发条件**：

- 用户在当前页面已发送过消息（`isSentMsg = true`）

**用户期望**：

- 不展示预设问句，避免干扰对话流程
- 保持消息列表的连贯性

**优先级**：P0（核心场景）

### 场景 4：网络异常或数据为空

**触发条件**：

- 接口请求失败
- 返回数据为空

**用户期望**：

- 不阻塞聊天主流程
- 可选：展示降级提示或重试入口

**优先级**：P1（降级场景）

## 功能约束

### 数据来源

- 通过 `getQuestion` 接口获取，参数 `questionsType=1, pageSize=3`
- 直接展示返回的 3 条问句（后端负责随机或排序逻辑）
- @see `packages/gel-api/src/chat/path.ts`

### 交互约束

- 点击问句后调用 `sendMessage`，与手动输入流程统一
- 发送成功后隐藏预设问句区域
- 不支持编辑或删除预设问句
- 虚拟滚动为空时（无虚拟项）仍需渲染预设问句，确保欢迎场景可见性

### 性能约束

- 接口请求耗时 < 200ms
- 点击响应到消息发送 < 200ms
- 不影响消息列表滚动性能（≥ 60fps）

### 兼容性约束

- 需兼容虚拟滚动列表
- 支持深浅色主题
- 响应式布局适配不同屏幕尺寸

## 非功能需求

### 可扩展性

- 预留运营配置能力（按企业类型筛选问句）
- 支持问句数量可配置（当前固定 3 条）

### 可观测性

- 埋点记录问句曝光、点击、发送成功率
- 监控接口失败率与响应时间

### 可维护性

- 代码与文档保持同步
- 提供完整的单元测试与集成测试

## 状态说明

### isSentMsg 状态

- **定义**：标识用户在当前页面是否发送过消息
- **初始值**：`false`
- **更新时机**：用户点击预设问句或手动输入发送消息后，设置为 `true`
- **重置时机**：页面刷新或重新进入企业详情页时重置为 `false`
- **作用**：控制预设问句的展示与隐藏，确保用户发送过消息后不再展示

## 验收标准

- [ ] 场景 1-3 的展示逻辑正确，无误触发
- [ ] `isSentMsg` 状态管理正确，发送后立即更新
- [ ] 点击问句后消息发送成功，问句区域隐藏
- [ ] 网络异常时不抛出未捕获异常
- [ ] 性能指标达标（接口 < 200ms，点击响应 < 200ms）
- [ ] 埋点数据正常上报

## 更新记录

| 日期       | 修改人  | 摘要                                        |
| ---------- | ------- | ------------------------------------------- |
| 2025-10-29 | Kiro AI | 使用 pageSize=3 获取问句，移除前端随机逻辑  |
| 2025-10-29 | Kiro AI | 修正场景 2/3：使用 isSentMsg 替代 isChating |
| 2025-10-29 | Kiro AI | 从 spec-core-v1 拆分需求                    |
| 2025-10-29 | Codex AI | 强化虚拟滚动兜底展示要求                    |
