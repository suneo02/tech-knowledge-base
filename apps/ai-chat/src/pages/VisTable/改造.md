# VisTable é¡µé¢æ”¹é€ å»ºè®®

## ğŸ¯ æ”¹é€ ç›®æ ‡

ä¼˜åŒ– VisTable é¡µé¢çš„æ¶æ„è®¾è®¡ï¼Œè§£å†³ä»£ç å†—ä½™ã€èŒè´£ä¸æ¸…ã€å‘½åæ··ä¹±ç­‰é—®é¢˜ï¼Œæå‡ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œå¯è¯»æ€§ã€‚

## ğŸ” ç°çŠ¶é—®é¢˜åˆ†æ

### 1. åˆ·æ–°æœºåˆ¶æ··ä¹±ä¸”å†—ä½™

#### é—®é¢˜æè¿°

å½“å‰å­˜åœ¨å¤šä¸ªåŠŸèƒ½ç›¸ä¼¼çš„åˆ·æ–°æ–¹æ³•ï¼ŒèŒè´£é‡å ä¸”é€»è¾‘å†—ä½™ï¼š

**å†—ä½™çš„åˆ·æ–°æ–¹æ³•ï¼š**

```typescript
// ä¸»é¡µé¢ index.tsx ä¸­çš„ä¸‰ä¸ªç›¸ä¼¼åˆ·æ–°æ–¹æ³•
1. handlePageRefresh()      // ä¸»é¡µé¢åˆ·æ–°æ–¹æ³•
2. useImperativeHandle.refresh()  // æš´éœ²ç»™çˆ¶ç»„ä»¶çš„åˆ·æ–°æ–¹æ³•
3. handleDataImported()     // æ•°æ®å¯¼å…¥åçš„åˆ·æ–°å¤„ç†

// å®¹å™¨ç»„ä»¶ VisTableContainer.tsx ä¸­çš„æ··ä¹±ä¼ é€’
4. onInternalRefresh()      // å†…éƒ¨åˆ·æ–°æ–¹æ³•
5. handlePageRefresh()      // é¡µé¢åˆ·æ–°æ–¹æ³•ä¼ é€’
6. pageRefreshRef.current() // å¼•ç”¨çš„åˆ·æ–°æ–¹æ³•
```

#### å…·ä½“é—®é¢˜

- **é€»è¾‘é‡å¤**ï¼šè¿™äº›æ–¹æ³•éƒ½åœ¨åšåŒæ ·çš„äº‹æƒ…ï¼ˆåˆ‡æ¢Sheetã€ä¿å­˜çŠ¶æ€ã€åˆ·æ–°å®¹å™¨ï¼‰
- **èŒè´£ä¸æ¸…**ï¼šåˆ†ä¸æ¸…å“ªä¸ªæ–¹æ³•è´Ÿè´£ä»€ä¹ˆåœºæ™¯çš„åˆ·æ–°
- **ç»´æŠ¤å›°éš¾**ï¼šä¿®æ”¹åˆ·æ–°é€»è¾‘éœ€è¦åŒæ—¶ä¿®æ”¹å¤šå¤„ä»£ç 

### 2. ä¸´æ—¶keyå¼ºåˆ¶é‡æ¸²æŸ“é€»è¾‘é‡å¤

#### é—®é¢˜æè¿°

åœ¨å¤šä¸ªåœ°æ–¹éƒ½æœ‰ç›¸åŒçš„ä¸´æ—¶keyè®¾ç½®å’Œæ¢å¤é€»è¾‘ï¼š

```typescript
// åœ¨ handleDataImportedã€useImperativeHandle.refresh ç­‰æ–¹æ³•ä¸­é‡å¤å‡ºç°
setList((prevList) => {
  return prevList.map((item) => {
    if (item.key === sheetIdStr) {
      return {
        ...item,
        key: `${item.key}-${Date.now()}`, // ä¸´æ—¶key
        children: <VisTableContainer ... />
      }
    }
    return item
  })
})

// 100msåæ¢å¤
setTimeout(() => {
  setList((prevList) => {
    return prevList.map((item) => {
      if (item.key.startsWith(`${sheetIdStr}-`)) {
        return { ...item, key: sheetIdStr }
      }
      return item
    })
  })
}, 100)
```

#### å…·ä½“é—®é¢˜

- **ä»£ç é‡å¤**ï¼šç›¸åŒçš„é€»è¾‘åœ¨å¤šä¸ªæ–¹æ³•ä¸­é‡å¤
- **é­”æ³•æ•°å­—**ï¼š`100ms` å»¶è¿Ÿæ²¡æœ‰è¯´æ˜åŸå› 
- **ä¸ä¼˜é›…**ï¼šä½¿ç”¨ä¸´æ—¶keyå¼ºåˆ¶é‡æ¸²æŸ“çš„æ–¹å¼ä¸å¤Ÿä¼˜é›…

### 3. æ–¹æ³•å‘½åä¸æ˜ç¡®

#### é—®é¢˜æ¸…å•

| å½“å‰å‘½å                | é—®é¢˜æè¿°                                                | å»ºè®®å‘½å                     |
| ----------------------- | ------------------------------------------------------- | ---------------------------- |
| `registerContainerRef`  | ä¸æ¸…æ¥šæ˜¯æ³¨å†Œä»€ä¹ˆå®¹å™¨çš„å¼•ç”¨                              | `setSheetContainerRef`       |
| `handleDataImported`    | åªè¡¨è¾¾äº†"å¤„ç†æ•°æ®å¯¼å…¥"ï¼Œå®é™…åšäº†åˆ‡æ¢Sheetã€åˆ·æ–°ç­‰å¤šä»¶äº‹ | `switchToSheetAfterImport`   |
| `handleIndicatorFinish` | ä¸çŸ¥é“"æŒ‡æ ‡å®Œæˆ"åè¦åšä»€ä¹ˆ                              | `refreshAfterIndicatorQuery` |
| `onInternalRefresh`     | "å†…éƒ¨åˆ·æ–°"æ¦‚å¿µæ¨¡ç³Š                                      | `refreshTableData`           |
| `handlePageRefresh`     | åœ¨å®¹å™¨ç»„ä»¶ä¸­ï¼Œ"é¡µé¢åˆ·æ–°"æ¦‚å¿µä¸å‡†ç¡®                      | `forwardRefreshToPage`       |
| `pageRefreshRef`        | å¼•ç”¨åç§°ä¸å¤Ÿå…·ä½“                                        | `mainPageRefreshRef`         |
| `containerRefs`         | å®¹å™¨å¼•ç”¨çš„Mapï¼Œä½†ä¸çŸ¥é“å­˜å‚¨ä»€ä¹ˆ                         | `sheetContainerRefs`         |

### 4. æ–¹æ³•èŒè´£è¿‡é‡

#### `getTableInfo` æ–¹æ³•é—®é¢˜

```typescript
const getTableInfo = async (currentTableId: string, currentConversationId: string) => {
  // åšäº†å¤ªå¤šäº‹æƒ…ï¼š
  // 1. å‘é€APIè¯·æ±‚
  // 2. é”™è¯¯å¤„ç†
  // 3. æ•°æ®éªŒè¯
  // 4. çŠ¶æ€æ›´æ–°ï¼ˆloadingã€errorã€listã€activeKeyç­‰ï¼‰
  // 5. localStorageæ“ä½œ
  // 6. Contextæ›´æ–°
  // 7. æ¸²æŸ“ç»„ä»¶åˆ›å»º
}
```

**é—®é¢˜ï¼š**

- å•ä¸€æ–¹æ³•æ‰¿æ‹…äº†å¤ªå¤šèŒè´£
- éš¾ä»¥æµ‹è¯•å’Œç»´æŠ¤
- é€»è¾‘è€¦åˆä¸¥é‡

#### `handleDataImported` æ–¹æ³•é—®é¢˜

```typescript
const handleDataImported = (sheetId: number | string) => {
  // åšäº†å¤ªå¤šäº‹æƒ…ï¼š
  // 1. æ£€æŸ¥Sheetæ˜¯å¦å­˜åœ¨
  // 2. åˆ‡æ¢åˆ°ç›®æ ‡Sheet
  // 3. ä¿å­˜çŠ¶æ€åˆ°localStorage
  // 4. è°ƒç”¨å®¹å™¨åˆ·æ–°
  // 5. å¼ºåˆ¶é‡æ¸²æŸ“å¤„ç†
  // 6. é”™è¯¯å¤„ç†å’Œé™çº§
}
```

### 5. ç»„ä»¶é—´é€šä¿¡å¤æ‚

#### åˆ·æ–°æ–¹æ³•ä¼ é€’é“¾æ¡

```
ä¸»é¡µé¢ â†’ å®¹å™¨ç»„ä»¶ â†’ VisTableç»„ä»¶ â†’ Toolbarç»„ä»¶
   â†“         â†“           â†“           â†“
handlePageRefresh â†’ onPageRefresh â†’ onPageRefresh â†’ onPageRefresh
```

**é—®é¢˜ï¼š**

- ä¼ é€’å±‚çº§è¿‡å¤šï¼Œå®¹æ˜“å‡ºé”™
- ä¸­é—´ç»„ä»¶åªæ˜¯é€ä¼ ï¼Œæ²¡æœ‰å®é™…é€»è¾‘
- éš¾ä»¥è¿½è¸ªæ•°æ®æµ

### 6. çŠ¶æ€ç®¡ç†åˆ†æ•£

#### é—®é¢˜æè¿°

ç›¸å…³çŠ¶æ€åˆ†æ•£åœ¨å¤šä¸ªåœ°æ–¹ï¼š

- `list` - Sheetåˆ—è¡¨çŠ¶æ€
- `activeKey` - å½“å‰æ´»è·ƒSheet
- `containerRefs` - å®¹å™¨å¼•ç”¨Map
- `existingSheetNames` - å·²å­˜åœ¨Sheetåç§°
- `editingSheetId` - ç¼–è¾‘ä¸­çš„Sheet ID

**é—®é¢˜ï¼š**

- çŠ¶æ€æ›´æ–°ä¸åŒæ­¥
- é€»è¾‘åˆ†æ•£éš¾ä»¥ç»´æŠ¤
- æ²¡æœ‰ç»Ÿä¸€çš„çŠ¶æ€ç®¡ç†

## ğŸ”§ è¯¦ç»†æ”¹é€ æ–¹æ¡ˆ

### 1. ç»Ÿä¸€åˆ·æ–°æœºåˆ¶æ”¹é€ 

#### åˆ é™¤çš„æ–¹æ³•

```typescript
// åˆ é™¤è¿™äº›å†—ä½™æ–¹æ³•
âŒ handlePageRefresh()  // ä¸»é¡µé¢ä¸­çš„è¿™ä¸ªæ–¹æ³•
âŒ onInternalRefresh() // å®¹å™¨ç»„ä»¶ä¸­çš„è¿™ä¸ªæ–¹æ³•
âŒ å®¹å™¨ç»„ä»¶ä¸­çš„ handlePageRefresh() // åªæ˜¯ç®€å•è½¬å‘
```

#### æ–°å¢ç»Ÿä¸€åˆ·æ–°ç®¡ç†å™¨

```typescript
// æ–°å»ºï¼šhooks/useRefreshManager.ts
interface RefreshOptions {
  sheets?: number[]
  switchToFirstSheet?: boolean
  forceRerender?: boolean
}

interface RefreshManager {
  refresh: (options?: RefreshOptions) => Promise<void>
  refreshSheet: (sheetId: number) => Promise<void>
  refreshAll: () => Promise<void>
}

export const useRefreshManager = (tableId: string, conversationId: string): RefreshManager => {
  // ç»Ÿä¸€çš„åˆ·æ–°é€»è¾‘å®ç°
}
```

#### é‡æ„åçš„åˆ·æ–°è°ƒç”¨

```typescript
// ä¸»é¡µé¢ä¸­
const refreshManager = useRefreshManager(tableId, conversationId)

// æš´éœ²ç»™çˆ¶ç»„ä»¶çš„æ–¹æ³•
useImperativeHandle(ref, () => ({
  refresh: (params) =>
    refreshManager.refresh({
      sheets: params?.sheets,
      switchToFirstSheet: true,
    }),
}))

// æ•°æ®å¯¼å…¥åçš„å¤„ç†
const handleDataImported = (sheetId: number) => {
  refreshManager.refreshSheet(sheetId)
}
```

### 2. å¼ºåˆ¶é‡æ¸²æŸ“é€»è¾‘å°è£…

#### åˆ é™¤é‡å¤ä»£ç 

```typescript
// åˆ é™¤æ‰€æœ‰åœ°æ–¹çš„è¿™æ®µé‡å¤ä»£ç 
âŒ setList((prevList) => {
  return prevList.map((item) => {
    if (item.key === sheetIdStr) {
      return {
        ...item,
        key: `${item.key}-${Date.now()}`,
        children: <VisTableContainer ... />
      }
    }
    return item
  })
})

âŒ setTimeout(() => {
  setList((prevList) => {
    return prevList.map((item) => {
      if (item.key.startsWith(`${sheetIdStr}-`)) {
        return { ...item, key: sheetIdStr }
      }
      return item
    })
  })
}, 100)
```

#### æ–°å¢å°è£…æ–¹æ³•

```typescript
// æ–°å»ºï¼šutils/forceRerender.ts
export const useForceRerender = () => {
  const [rerenderKey, setRerenderKey] = useState(0)

  const forceRerender = useCallback(() => {
    setRerenderKey((prev) => prev + 1)
  }, [])

  return { rerenderKey, forceRerender }
}

// æˆ–è€…æ›´ä¼˜é›…çš„æ–¹æ¡ˆï¼šä½¿ç”¨ React.Key ç®¡ç†
export const useSheetRerender = (sheetId: number) => {
  const [key, setKey] = useState(`sheet-${sheetId}`)

  const triggerRerender = useCallback(() => {
    setKey(`sheet-${sheetId}-${Date.now()}`)
  }, [sheetId])

  return { key, triggerRerender }
}
```

### 3. æ–¹æ³•é‡å‘½åæ”¹é€ 

#### å…·ä½“é‡å‘½åæ“ä½œ

```typescript
// æ–‡ä»¶ï¼šsrc/pages/VisTable/index.tsx
âŒ registerContainerRef â†’ âœ… setSheetContainerRef
âŒ handleDataImported â†’ âœ… switchToSheetAfterImport
âŒ containerRefs â†’ âœ… sheetContainerRefs
âŒ handlePageRefresh â†’ âœ… refreshTableData

// æ–‡ä»¶ï¼šsrc/pages/VisTable/components/VisTableContainer.tsx
âŒ onInternalRefresh â†’ âœ… refreshTableData
âŒ handlePageRefresh â†’ âœ… forwardRefreshToPage
âŒ pageRefreshRef â†’ âœ… mainPageRefreshRef

// æ–‡ä»¶ï¼šsrc/pages/VisTable/components/toolbar/index.tsx
âŒ handleIndicatorFinish â†’ âœ… refreshAfterIndicatorQuery
```

### 4. æ‹†åˆ†èŒè´£è¿‡é‡çš„æ–¹æ³•

#### æ‹†åˆ† `getTableInfo` æ–¹æ³•

```typescript
// åˆ é™¤åŸæœ‰çš„ getTableInfo æ–¹æ³•
âŒ getTableInfo() // èŒè´£è¿‡é‡çš„æ–¹æ³•

// æ–°å»ºå¤šä¸ªèŒè´£æ¸…æ™°çš„æ–¹æ³•
âœ… fetchTableInfo() // çº¯ç²¹çš„APIè°ƒç”¨
âœ… validateTableData() // æ•°æ®éªŒè¯
âœ… updateTableState() // çŠ¶æ€æ›´æ–°
âœ… buildSheetTabs() // æ„å»ºSheetæ ‡ç­¾
âœ… initializeActiveSheet() // åˆå§‹åŒ–æ´»è·ƒSheet
```

#### å…·ä½“å®ç°

```typescript
// æ–°å»ºï¼šservices/tableService.ts
export const fetchTableInfo = async (tableId: string, conversationId: string) => {
  // çº¯ç²¹çš„APIè°ƒç”¨ï¼Œè¿”å›æ•°æ®
}

// æ–°å»ºï¼šutils/tableDataValidator.ts
export const validateTableData = (data: any) => {
  // æ•°æ®éªŒè¯é€»è¾‘
}

// æ–°å»ºï¼šhooks/useTableState.ts
export const useTableState = () => {
  // çŠ¶æ€ç®¡ç†é€»è¾‘
}

// æ–°å»ºï¼šutils/sheetTabBuilder.ts
export const buildSheetTabs = (sheetInfos: SheetInfo[], tableId: string) => {
  // æ„å»ºSheetæ ‡ç­¾çš„é€»è¾‘
}
```

### 5. ç®€åŒ–ç»„ä»¶é—´é€šä¿¡

#### åˆ é™¤ä¸­é—´ä¼ é€’å±‚

```typescript
// åˆ é™¤å®¹å™¨ç»„ä»¶ä¸­çš„ç®€å•è½¬å‘é€»è¾‘
âŒ // VisTableContainer.tsx ä¸­çš„è¿™äº›æ–¹æ³•
const handlePageRefresh = (params?: ContainerRefreshParams) => {
  if (onPageRefresh) {
    onPageRefresh(params)
  }
}
```

#### ä½¿ç”¨Contextç›´æ¥é€šä¿¡

```typescript
// æ–°å»ºï¼šcontexts/RefreshContext.tsx
interface RefreshContextType {
  refreshManager: RefreshManager
}

export const RefreshContext = createContext<RefreshContextType>()

// åœ¨ä¸»é¡µé¢æä¾›
<RefreshContext.Provider value={{ refreshManager }}>
  <VisTableContainer />
</RefreshContext.Provider>

// åœ¨Toolbarä¸­ç›´æ¥ä½¿ç”¨
const { refreshManager } = useContext(RefreshContext)
```

### 6. ç»Ÿä¸€çŠ¶æ€ç®¡ç†

#### åˆ é™¤åˆ†æ•£çš„çŠ¶æ€

```typescript
// åˆ é™¤ä¸»é¡µé¢ä¸­çš„è¿™äº›åˆ†æ•£çŠ¶æ€
âŒ const [list, setList] = useState<TabsProps['items']>([])
âŒ const [activeKey, setActiveKey] = useState<string>('')
âŒ const [existingSheetNames, setExistingSheetNames] = useState<string[]>([])
âŒ const [editingSheetId, setEditingSheetId] = useState<string | null>(null)
âŒ const containerRefs = useRef<Record<string, any>>({})
```

#### æ–°å»ºç»Ÿä¸€çŠ¶æ€ç®¡ç†

```typescript
// æ–°å»ºï¼šhooks/useTablePageState.ts
interface TablePageState {
  sheets: SheetInfo[]
  activeSheetId: string
  editingSheetId: string | null
  loading: boolean
  error: string
}

export const useTablePageState = (tableId: string) => {
  const [state, setState] = useState<TablePageState>({
    sheets: [],
    activeSheetId: '',
    editingSheetId: null,
    loading: false,
    error: '',
  })

  const actions = {
    setActiveSheet: (sheetId: string) => {
      setState((prev) => ({ ...prev, activeSheetId: sheetId }))
      saveActiveSheet(tableId, sheetId)
    },
    addSheet: (sheet: SheetInfo) => {
      setState((prev) => ({ ...prev, sheets: [...prev.sheets, sheet] }))
    },
    removeSheet: (sheetId: string) => {
      setState((prev) => ({
        ...prev,
        sheets: prev.sheets.filter((s) => s.id !== sheetId),
      }))
    },
    // ... å…¶ä»–æ“ä½œ
  }

  return { state, actions }
}
```

### 7. å·¥å…·å‡½æ•°æå–

#### æ–°å»ºå·¥å…·å‡½æ•°

```typescript
// æ–°å»ºï¼šutils/sheetOperations.ts
export const generateUniqueSheetName = (existingNames: string[]) => {
  // ç”Ÿæˆå”¯ä¸€Sheetåç§°çš„é€»è¾‘
}

export const validateSheetName = (name: string) => {
  // Sheetåç§°éªŒè¯é€»è¾‘
}

// æ–°å»ºï¼šutils/tabsHelper.ts
export const buildTabItems = (sheets: SheetInfo[], tableId: string) => {
  // æ„å»ºTabs itemsçš„é€»è¾‘
}

export const findSheetById = (sheets: SheetInfo[], id: string) => {
  // æŸ¥æ‰¾Sheetçš„é€»è¾‘
}
```

## ğŸ“‹ æ”¹é€ æ­¥éª¤è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€é‡æ„

1. **é‡å‘½åæ–¹æ³•å’Œå˜é‡**ï¼ˆæœ€å®‰å…¨ï¼Œå½±å“æœ€å°ï¼‰
2. **æå–é‡å¤çš„å·¥å…·å‡½æ•°**
3. **åˆ é™¤æ˜¾è€Œæ˜“è§çš„å†—ä½™æ–¹æ³•**

### ç¬¬äºŒé˜¶æ®µï¼šæ¶æ„ä¼˜åŒ–

1. **å®ç°ç»Ÿä¸€çš„åˆ·æ–°ç®¡ç†å™¨**
2. **æ‹†åˆ†èŒè´£è¿‡é‡çš„æ–¹æ³•**
3. **ç®€åŒ–ç»„ä»¶é—´é€šä¿¡**

### ç¬¬ä¸‰é˜¶æ®µï¼šçŠ¶æ€ç®¡ç†ä¼˜åŒ–

1. **å®ç°ç»Ÿä¸€çš„çŠ¶æ€ç®¡ç†**
2. **ä¼˜åŒ–å¼ºåˆ¶é‡æ¸²æŸ“é€»è¾‘**
3. **å®Œå–„é”™è¯¯å¤„ç†æœºåˆ¶**

## ğŸ¯ é¢„æœŸæ”¹é€ æ•ˆæœ

### ä»£ç è´¨é‡æå‡

- **å‡å°‘ä»£ç é‡å¤**ï¼šé¢„è®¡å‡å°‘ 30% çš„é‡å¤ä»£ç 
- **æé«˜å¯è¯»æ€§**ï¼šæ–¹æ³•åæ›´æ¸…æ™°ï¼ŒèŒè´£æ›´æ˜ç¡®
- **å¢å¼ºå¯ç»´æŠ¤æ€§**ï¼šç»Ÿä¸€çš„æ¶æ„ï¼Œæ›´å®¹æ˜“ä¿®æ”¹å’Œæ‰©å±•

### æ€§èƒ½ä¼˜åŒ–

- **å‡å°‘ä¸å¿…è¦çš„é‡æ¸²æŸ“**ï¼šä¼˜åŒ–å¼ºåˆ¶é‡æ¸²æŸ“é€»è¾‘
- **ç®€åŒ–ç»„ä»¶é€šä¿¡**ï¼šå‡å°‘propsä¼ é€’çš„å¼€é”€
- **ç»Ÿä¸€çŠ¶æ€ç®¡ç†**ï¼šå‡å°‘çŠ¶æ€åŒæ­¥çš„å¤æ‚åº¦

### å¼€å‘ä½“éªŒæ”¹å–„

- **æ›´æ¸…æ™°çš„ä»£ç ç»“æ„**ï¼šå¼€å‘è€…æ›´å®¹æ˜“ç†è§£å’Œä½¿ç”¨
- **æ›´å¥½çš„é”™è¯¯å¤„ç†**ï¼šç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶
- **æ›´å®¹æ˜“æµ‹è¯•**ï¼šèŒè´£å•ä¸€çš„æ–¹æ³•æ›´å®¹æ˜“ç¼–å†™æµ‹è¯•

## ğŸš¨ æ³¨æ„äº‹é¡¹

### å…¼å®¹æ€§ä¿è¯

- ä¿æŒå¯¹å¤–æ¥å£çš„å…¼å®¹æ€§
- æ¸è¿›å¼é‡æ„ï¼Œé¿å…å¤§è§„æ¨¡ç ´åæ€§å˜æ›´
- å……åˆ†çš„æµ‹è¯•è¦†ç›–

### é£é™©æ§åˆ¶

- é‡æ„è¿‡ç¨‹ä¸­ä¿æŒåŠŸèƒ½å®Œæ•´æ€§
- æ¯ä¸ªé˜¶æ®µéƒ½è¦æœ‰å¯å›æ»šçš„æ–¹æ¡ˆ
- é‡è¦å˜æ›´éœ€è¦ä»£ç å®¡æŸ¥

---

_æ”¹é€ å»ºè®®æ–‡æ¡£_
_åˆ›å»ºæ—¶é—´ï¼š2024-01-XX_
_ç‰ˆæœ¬ï¼šv1.0.0_
