<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Agent Hyper Â· è¡¨æ ¼+åœ°å›¾ Â· å¤šé¡µDemo</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
:root{
  --bg:#0b0f17; --panel:#0f1625cc; --line:#203456; --muted:#9bb5e6;
  --fg:#e8f1ff; --neon:#7cf3ff; --vio:#a78bfa; --ok:#34d399; --warn:#fb7185;
}
*{box-sizing:border-box}html,body{height:100%}body{margin:0;font:14px/1.6 ui-sans-serif,system-ui,"PingFang SC","Microsoft YaHei";color:var(--fg);background:
radial-gradient(1200px 700px at 20% -10%, #1a2458 0%, transparent 50%),
radial-gradient(900px 600px at 100% 0%, #00414a 0%, transparent 60%),
linear-gradient(180deg,#060a12, #0b0f17 40%, #0b0f17 100%);}
a{color:inherit;text-decoration:none}
.container{max-width:1180px;margin:0 auto;padding:24px}
header.nav{display:flex;align-items:center;justify-content:space-between}
.brand{display:flex;align-items:center;gap:10px}
.logo{width:36px;height:36px;border-radius:12px;background:linear-gradient(135deg,#0a0a0a,#191919);
display:grid;place-items:center;font-weight:800;color:var(--neon);box-shadow:inset 0 0 18px #000,0 0 14px #00e5ff33}
.navbtn{border:1px solid var(--line);background:#0d1423ad;color:var(--fg);padding:10px 14px;border-radius:12px;backdrop-filter:blur(10px);cursor:pointer}
.navbtn:hover{transform:translateY(-1px);border-color:#39507e}
.badge{font-size:10px;padding:4px 8px;border-radius:999px;border:1px solid #29405f;color:#9bc2ff;background:#0b1220}
.btn{border:1px solid var(--line);background:#0d1423ad;color:var(--fg);padding:10px 14px;border-radius:12px;cursor:pointer}
.btn.primary{background:linear-gradient(135deg,#00bcd44d,#6d28d94d);border-color:#3a4f79}
.btn.ghost{background:#0c1322;border:1px solid #2a3b60}
.input{width:100%;border:1px solid var(--line);border-radius:14px;padding:14px;background:#0b1220cc;color:var(--fg);outline:none}
.h1{font-weight:900;font-size:40px;line-height:1.15;margin:0;text-shadow:0 0 24px #00e5ff1a}
.h1 .g{background:linear-gradient(90deg,var(--neon),var(--vio));-webkit-background-clip:text;background-clip:text;color:transparent}
.sub{color:var(--muted)}
.grid2{display:grid;grid-template-columns:1.15fr 1fr;gap:22px;align-items:center}
.card{border:1px solid var(--line);border-radius:20px;background:var(--panel);backdrop-filter:blur(14px);box-shadow:0 20px 60px #0006}
.sec{margin-top:28px}
.chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
.chip,.pill{font-size:11px;padding:6px 9px;border-radius:999px;background:#11213d;border:1px dashed #274066;color:#a6bee8}
.pill{border-style:solid;border-color:#29466f;background:#0a1a33;color:#98b9ff}
.page{display:none;opacity:0;transform:translateY(12px);transition:.24s}
.page.show{display:block;opacity:1;transform:translateY(0)}
.breadcrumbs{color:#86a5e0;font-size:12px;margin:8px 0 16px}
.link{color:#9ec8ff;text-decoration:underline dotted}
.toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#0c1321;border:1px solid #274066;color:#e8f1ff;padding:10px 14px;border-radius:10px;opacity:0;transition:.2s;z-index:60}
.toast.show{opacity:1;transform:translate(-50%,-6px)}
/* è¡¨æ ¼ */
.tableWrap{border:1px solid var(--line);border-radius:16px;overflow:auto;background:var(--panel)}
table{width:100%;border-collapse:separate;border-spacing:0}
thead th{position:sticky;top:0;background:#0c1426;border-bottom:1px solid #233a63;padding:10px;text-align:left;font-weight:700}
tbody td{border-bottom:1px dashed #233a63;padding:10px;vertical-align:top}
th.sortable{cursor:pointer}
.rowActions{display:flex;gap:8px}
pre.note{white-space:pre-wrap;background:#0a1324;border:1px solid #20365f;border-radius:10px;padding:8px;margin:6px 0 0}
.toolbar{display:flex;align-items:center;justify-content:space-between;gap:8px}
.viewTabs{display:flex;gap:6px}
.viewTabs .btn.active{background:#11213d;border-color:#3b5a94}
/* åœ°å›¾ */
#map{height:540px;border:1px solid var(--line);border-radius:16px;overflow:hidden}
.leaflet-popup-content{margin:8px;line-height:1.4}
</style>
</head>
<body>
  <div class="container">
    <header class="nav">
      <div class="brand">
        <div class="logo">A</div>
        <div style="font-weight:800;letter-spacing:.4px">Agent Hyper</div>
        <span class="badge">è¡¨æ ¼ + åœ°å›¾ Â· å¤šé¡µ</span>
      </div>
      <nav style="display:flex;gap:8px">
        <a href="#/" class="navbtn">é¦–é¡µ</a>
        <a href="#/assets" class="navbtn">æˆ‘çš„èµ„äº§</a>
        <button id="btnReset" class="navbtn">æ¸…ç©ºæ¼”ç¤º</button>
      </nav>
    </header>

    <!-- é¦–é¡µ -->
    <section id="page-home" class="page show">
      <div class="grid2 sec">
        <div>
          <h1 class="h1">ä¸€å¥è¯å‘Šè¯‰æˆ‘ä½ æ˜¯è°ï¼Œ<span class="g">ç³»ç»Ÿè‡ªåŠ¨æ¨è</span>æœ€åˆé€‚çš„ Agentã€‚</h1>
          <p class="sub">ç¤ºä¾‹ï¼šæˆ‘æ˜¯ä¸Šæµ·äº‘æ‰è½¯ä»¶ï¼Œæƒ³æŠŠè®¾å¤‡å¥åº·ç›‘æµ‹SaaSå–ç»™åˆ¶é€ ä¸š</p>
          <div class="sec" style="display:flex;gap:10px;align-items:center">
            <input id="homeText" class="input" placeholder="è¾“å…¥ä¼ä¸šåæˆ–ä¸€å¥è¯ç›®æ ‡æè¿°"/>
            <button id="homeDetect" class="btn primary">è¯†åˆ«å¹¶æ¨è</button>
            <button id="homeLocate" class="btn ghost" title="ä½¿ç”¨å½“å‰ä½ç½®å¯»æ‰¾é™„è¿‘æ½œå®¢">ğŸ“é™„è¿‘</button>
          </div>
          <p class="sub" style="font-size:12px;margin-top:6px">æŒ‰ Enter ä¹Ÿå¯è¯†åˆ« Â· ç‚¹å‡» ğŸ“ å¯ç›´æ¥è¿›å…¥â€œé™„è¿‘æ½œå®¢â€</p>
        </div>
        <div class="card" style="padding:18px">
          <div style="font-size:12px;color:#9db7ff">ç³»ç»Ÿå°†è‡ªåŠ¨ï¼š</div>
          <div class="chips sec">
            <span class="chip">ä¼ä¸šç”»åƒè¡¥å…¨</span><span class="chip">Agentæ¨è</span><span class="chip">å¸‚åœºé»˜è®¤å€¼</span><span class="chip">é™„è¿‘æ½œå®¢</span>
          </div>
          <div class="sec"><a class="link" href="#/agent">è·³è¿‡ç¤ºä¾‹ï¼Œç›´æ¥çœ‹æ¨èé¡µ Â»</a></div>
        </div>
      </div>
    </section>

    <!-- æ¨èé¡µ -->
    <section id="page-agent" class="page">
      <div class="breadcrumbs">é¦–é¡µ / æ¨è Agent</div>
      <div class="grid2">
        <div>
          <h2 class="h1" style="font-size:32px">ç³»ç»Ÿæ¨èï¼š<span id="recoTitle">è½¯ä»¶è¡Œä¸šæ‰¾å®¢æˆ· Agent</span></h2>
          <p class="sub" id="recoDesc">åŸºäºä½ çš„ä¼ä¸šç”»åƒï¼ŒæŒ‰äº§å“Ã—è¡Œä¸šç—›ç‚¹ç›´è¾¾å®¢æˆ·ã€‚</p>
          <div id="recoChips" class="chips sec"></div>
          <div class="sec" style="display:flex;gap:10px">
            <a id="toConfig" class="btn primary" href="#/config">å¼€å§‹é…ç½®</a>
            <button id="switchAgent" class="btn ghost">æ¢ä¸€ä¸ª</button>
          </div>
          <p class="sub" style="font-size:12px;margin-top:8px"><a class="link" href="#/">è¿”å›é¦–é¡µ</a></p>
        </div>
        <div class="card" style="padding:18px">
          <div style="font-size:12px;color:#9db7ff">å…¶å®ƒå¯é€‰ Agent</div>
          <table class="table sec" id="agentTable">
            <thead><tr><th>åç§°</th><th>æ ‡ç­¾</th><th style="width:120px">é€‰æ‹©</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- é…ç½®é¡µ -->
    <section id="page-config" class="page">
      <div class="breadcrumbs">é¦–é¡µ / æ¨è Agent / é…ç½®</div>
      <h2 class="h1" style="font-size:30px"><span id="cfgAgent">è½¯ä»¶è¡Œä¸šæ‰¾å®¢æˆ·</span> Â· é…ç½®</h2>
      <div class="card sec" style="padding:18px">
        <div class="chips"><span class="chip">æœ€å°‘è¾“å…¥ï¼š1~2 é¡¹</span><span class="chip">å…¶ä½™è‡ªåŠ¨è¡¥å…¨</span></div>
        <div class="sec" style="display:grid;grid-template-columns:1fr;gap:12px">
          <label>äº§å“/æœåŠ¡ï¼ˆä¸€å¥è¯ï¼‰<span style="color:var(--warn)">*</span>
            <input id="inpProduct" class="input" placeholder="å¦‚ï¼šé¢å‘åˆ¶é€ ä¸šçš„è®¾å¤‡å¥åº·ç›‘æµ‹SaaS"/>
          </label>
          <label>ç›®æ ‡å¸‚åœºï¼ˆè¡Œä¸š/åœ°åŒºï¼Œå¯ç•™ç©ºï¼‰
            <input id="inpMarket" class="input" placeholder="å¦‚ï¼šæ–°èƒ½æºï½œé•¿ä¸‰è§’"/>
          </label>
        </div>
        <div class="sec" style="display:flex;gap:10px;flex-wrap:wrap">
          <a id="toResults" class="btn primary" href="#/results">ç”Ÿæˆåå•å¹¶è·³è½¬</a>
          <button id="cfgAuto" class="btn ghost">è‡ªåŠ¨è¡¥å…¨ç¤ºä¾‹</button>
          <a class="btn ghost" href="#/agent">ä¸Šä¸€æ­¥</a>
        </div>
      </div>
    </section>

    <!-- ç»“æœé¡µ -->
    <section id="page-results" class="page">
      <div class="breadcrumbs">é¦–é¡µ / æ¨è Agent / é…ç½® / ç»“æœ</div>
      <div class="toolbar">
        <h2 class="h1" style="font-size:30px">æ½œå®¢ç»“æœ</h2>
        <div class="viewTabs">
          <button id="tabTable" class="btn active">è¡¨æ ¼</button>
          <button id="tabMap" class="btn">åœ°å›¾</button>
          <button id="btnSave" class="btn ghost">ä¿å­˜åå•</button>
          <button id="btnCSV" class="btn primary">ä¸‹è½½ CSV</button>
        </div>
      </div>

      <div class="card sec" style="padding:12px">
        <div class="chips">
          <span class="pill">å¿«é€Ÿç­›é€‰ï¼š</span>
          <button class="pill" data-refine="industry:æ–°èƒ½æº">è¡Œä¸šÂ·æ–°èƒ½æº</button>
          <button class="pill" data-refine="industry:åˆ¶é€ ">è¡Œä¸šÂ·åˆ¶é€ </button>
          <button class="pill" data-refine="region:ä¸Šæµ·">åœ°åŒºÂ·ä¸Šæµ·</button>
          <button class="pill" data-refine="region:æ·±åœ³">åœ°åŒºÂ·æ·±åœ³</button>
          <button class="pill" data-refine="signal:æ‹›æŠ•æ ‡">ä¿¡å·Â·æ‹›æŠ•æ ‡</button>
          <button class="pill" data-refine="signal:æ‹›è˜">ä¿¡å·Â·æ‹›è˜</button>
          <button class="pill" id="btnNear">ğŸ“ é™„è¿‘10km</button>
          <button class="pill" id="btnResetFilter">é‡ç½®</button>
        </div>
      </div>

      <!-- è¡¨æ ¼è§†å›¾ -->
      <div id="viewTable" class="tableWrap sec">
        <table id="resultTable">
          <thead>
            <tr>
              <th class="sortable" data-sort="name">ä¼ä¸šå</th>
              <th class="sortable" data-sort="industry">è¡Œä¸š</th>
              <th class="sortable" data-sort="region">åœ°åŒº</th>
              <th>è§„æ¨¡</th>
              <th>åŠ¨æ€ä¿¡å·</th>
              <th class="sortable" data-sort="score">åˆ†æ•°</th>
              <th>æ¨èç†ç”±</th>
              <th>è¯æœ¯ï¼ˆç‚¹å‡»å¤åˆ¶ï¼‰</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- åœ°å›¾è§†å›¾ -->
      <div id="viewMap" class="sec" style="display:none">
        <div id="map"></div>
      </div>
    </section>

    <!-- èµ„äº§é¡µ -->
    <section id="page-assets" class="page">
      <div class="breadcrumbs">é¦–é¡µ / æˆ‘çš„èµ„äº§</div>
      <h2 class="h1" style="font-size:30px">æˆ‘çš„èµ„äº§</h2>
      <div class="card sec" style="padding:14px">
        <table class="table" id="assetsTable">
          <thead><tr><th>æ ‡é¢˜</th><th>è¯´æ˜</th><th>æ—¶é—´</th><th style="width:140px">æ“ä½œ</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <p class="sub" style="font-size:12px;margin-top:8px"><a class="link" href="#/">è¿”å›é¦–é¡µ</a></p>
    </section>
  </div>

  <div id="toast" class="toast"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* ===== util ===== */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
function toast(t){const n=$("#toast");n.textContent=t;n.classList.add("show");setTimeout(()=>n.classList.remove("show"),1600)}
function rand(a,b){return Math.floor(Math.random()*(b-a+1))+a}
function sample(arr,n){const cp=[...arr], out=[]; for(let i=0;i<n;i++){ const k=rand(0,cp.length-1); out.push(cp.splice(k,1)[0]); } return out}
function csvDownload(rows, fname){const csv = rows.map(r=>r.map(v=>{const s=String(v).replace(/"/g,'""');return /[",\n]/.test(s)?`"${s}"`:s}).join(',')).join('\n');
const blob = new Blob([csv], {type:'text/csv;charset=utf-8'}); const url = URL.createObjectURL(blob);
const a = document.createElement('a'); a.href=url; a.download=fname; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);}
function showPage(id){$$('.page').forEach(p=>p.classList.remove('show')); $(id).classList.add('show')}

/* ===== catalog & rules ===== */
const catalog = [
  { key:'software', title:'è½¯ä»¶è¡Œä¸šæ‰¾å®¢æˆ· Agent', badge:'SaaS', desc:p=>`åŸºäºä½ çš„ç”»åƒï¼ˆè¡Œä¸šï¼š${p.industry||'è½¯ä»¶'} / åœ°åŒºï¼š${p.region||'â€”'} / è§„æ¨¡ï¼š${p.size||'â€”'}ï¼‰ï¼ŒæŒ‰è½¯ä»¶å“ç±»Ã—è¡Œä¸šç—›ç‚¹ç›´è¾¾å®¢æˆ·ã€‚`, chips:['CRM / HR / MES / ä½ä»£ç ','è¡Œä¸šé€‚é…è¯æœ¯','å³æ—¶è¯„åˆ†'] },
  { key:'manufacturing', title:'åˆ¶é€ ä¸šæ‰¾å®¢æˆ· Agent', badge:'åˆ¶é€ ', desc:p=>`èšç„¦æ”¹é€ /é‡‡è´­é¡¹ç›®ï¼Œä¼˜å…ˆæ‹›æŠ•æ ‡&æ‹›è˜ä¿¡å·ï¼Œè¦†ç›–äº§ä¸šå¸¦é«˜å¯†åŒºã€‚`, chips:['è®¾å¤‡æ”¹é€ æœºä¼š','æ‹›æŠ•æ ‡çƒ­åº¦','åŒºåŸŸäº§ä¸šå¸¦'] },
  { key:'bank', title:'é“¶è¡Œå¯¹å…¬æ‹“å®¢ Agent', badge:'é‡‘è', desc:p=>`æŒ‰è§„æ¨¡/èµ„è´¨æ¨èæˆä¿¡&ç»“ç®—å®¢æˆ·ï¼Œå†…ç½®åŸºç¡€é£æ§ç­›é€‰ã€‚`, chips:['æˆä¿¡åå¥½','ç¥¨æ®/ç»“ç®—','é£æ§æ ‡ç­¾'] },
  { key:'supplier', title:'æ‰¾ä¾›åº”å•† Agent', badge:'é‡‡è´­', desc:p=>`å›´ç»•BOMåæ¨å…³é”®ç‰©æ–™ä¾›åº”å•†ï¼Œè¯„ä¼°äº¤ä»˜å‘¨æœŸä¸è´¨é‡å£ç¢‘ã€‚`, chips:['BOMåæ¨','äº¤ä»˜èƒ½åŠ›','è´¨é‡å£ç¢‘'] },
];
const rules = [
  {keys:['è½¯ä»¶','SaaS','ä¿¡æ¯','äº’è”ç½‘','ç§‘æŠ€','æ•°æ®'], agent:'software'},
  {keys:['åˆ¶é€ ','è£…å¤‡','æœºç”µ','è®¾å¤‡','å·¥å‚','è‡ªåŠ¨åŒ–','é›¶éƒ¨ä»¶','æœºå™¨äºº'], agent:'manufacturing'},
  {keys:['é“¶è¡Œ','é‡‘è','é‡‘æ§','ä¿¡æ‰˜','èµ„ç®¡'], agent:'bank'},
  {keys:['æ–°èƒ½æº','æ•´è½¦','ç”µæ± '], agent:'manufacturing'}
];

/* ===== geo city centers (ç²—ç²’åº¦) ===== */
const cityCenters = {
  'ä¸Šæµ·':[31.2304,121.4737], 'åŒ—äº¬':[39.9042,116.4074], 'æ·±åœ³':[22.5431,114.0579], 'æ­å·':[30.2741,120.1551],
  'å¹¿å·':[23.1291,113.2644], 'å—äº¬':[32.0603,118.7969], 'è‹å·':[31.2989,120.5853], 'åˆè‚¥':[31.8206,117.2290],
  'å¤©æ´¥':[39.0842,117.2009], 'é‡åº†':[29.5630,106.5516]
};
function jitter([lat,lng], km=5){
  // è¿‘ä¼¼ï¼š1åº¦çº¬åº¦â‰ˆ111kmï¼Œç»åº¦â‰ˆ111kmÂ·cos(lat)
  const dLat = (Math.random()-0.5) * (km/55); // ç²—æŠ–åŠ¨
  const dLng = (Math.random()-0.5) * (km/(55*Math.cos(lat*Math.PI/180)));
  return [lat+dLat, lng+dLng];
}

/* ===== state ===== */
let profile={name:'',industry:'',region:'',size:''};
let agent=catalog[0];
let results=[];      // å…¨é‡ç»“æœ
let filtered=[];     // å½“å‰ç­›é€‰è§†å›¾
let currentPos=null; // [lat,lng]
let map=null, markersLayer=null;

/* ===== routing ===== */
function router(){
  const hash = location.hash || '#/';
  if(hash.startsWith('#/agent')){ renderAgentPage(); showPage('#page-agent'); return; }
  if(hash.startsWith('#/config')){ renderConfigPage(); showPage('#page-config'); return; }
  if(hash.startsWith('#/results')){ renderResultsPage(); showPage('#page-results'); return; }
  if(hash.startsWith('#/assets')){ renderAssetsPage(); showPage('#page-assets'); return; }
  showPage('#page-home');
}
window.addEventListener('hashchange', router);

/* ===== home ===== */
$('#homeDetect').onclick = detectFromHome;
$('#homeText').addEventListener('keydown',e=>{ if(e.key==='Enter') detectFromHome(); });
$('#homeLocate').onclick = locateNearby;
$('#btnReset').onclick = ()=>{ localStorage.clear(); toast('å·²æ¸…ç©ºæ¼”ç¤ºæ•°æ®'); }
function detectFromHome(){
  const txt = $('#homeText').value.trim();
  if(!txt){ toast('è¯·è¾“å…¥ä¸€å¥è¯æˆ–ä¼ä¸šå'); return; }
  // ç®€å•è§£æ
  profile = {
    name: (txt.match(/(ä¸Šæµ·|åŒ—äº¬|æ·±åœ³|æ­å·|å¹¿å·|å—äº¬|è‹å·|åˆè‚¥).{1,10}(å…¬å¸|é“¶è¡Œ)/)?.[0]) || txt.split(/ï¼Œ|,|ã€‚/)[0],
    industry: guessIndustry(txt),
    region: guessRegion(txt),
    size: guessSize()
  };
  const rule = rules.find(r=> r.keys.some(k=> txt.includes(k)));
  agent = catalog.find(c=> c.key === (rule?rule.agent:'software')) || catalog[0];
  location.hash = '#/agent';
}
function locateNearby(){
  if(!navigator.geolocation){ toast('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒå®šä½'); return; }
  navigator.geolocation.getCurrentPosition((pos)=>{
    currentPos=[pos.coords.latitude, pos.coords.longitude];
    // ç›´æ¥ç”Ÿæˆé™„è¿‘æ½œå®¢ï¼ˆæ— éœ€é…ç½®ï¼‰
    const prod='é™„è¿‘æ‹“å±•'; const market=''; results = synthesizeLeads(prod, market, agent.key, currentPos);
    filtered=[...results];
    location.hash='#/results';
    setTimeout(()=>{ // åˆ‡åˆ°åœ°å›¾
      $('#tabMap').click();
      focusNear(currentPos, 10);
    },80);
  }, ()=>{ toast('å®šä½å¤±è´¥ï¼Œå·²ä½¿ç”¨é»˜è®¤åŸå¸‚ä¸Šæµ·'); currentPos=[31.23,121.47]; location.hash='#/results'; });
}
function guessIndustry(n){ if(/è½¯ä»¶|ä¿¡æ¯|æ•°æ®|ç§‘æŠ€|äº’è”ç½‘/.test(n)) return 'è½¯ä»¶'; if(/é“¶è¡Œ|é‡‘è|ä¿¡æ‰˜/.test(n)) return 'é‡‘è'; if(/åˆ¶é€ |è£…å¤‡|æœºç”µ|æœºæ¢°|æœºå™¨äºº|è‡ªåŠ¨åŒ–/.test(n)) return 'åˆ¶é€ '; return 'è½¯ä»¶'; }
function guessRegion(n){ return Object.keys(cityCenters).find(c=>n.includes(c)) || 'ä¸Šæµ·' }
function guessSize(){ return ['å°å‹','ä¸­å‹','å¤§å‹'][rand(0,2)] }

/* ===== agent page ===== */
function renderAgentPage(){
  $('#recoTitle').textContent = agent.title;
  $('#recoDesc').textContent  = agent.desc(profile);
  $('#recoChips').innerHTML   = agent.chips.map(c=>`<span class="chip">${c}</span>`).join('');
  $('#cfgAgent').textContent  = agent.title.replace(' Agent','');

  const tbody = $('#agentTable tbody'); tbody.innerHTML='';
  catalog.forEach(c=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${c.title.replace(' Agent','')}</td><td><span class="pill">${c.badge}</span></td>
      <td><button class="btn ghost" data-pick="${c.key}">${c.key===agent.key?'å·²é€‰æ‹©':'é€‰æ‹©'}</button></td>`;
    tr.addEventListener('click', (e)=>{
      const btn = e.target.closest('[data-pick]'); if(!btn) return;
      agent = catalog.find(x=> x.key === btn.getAttribute('data-pick')) || agent;
      renderAgentPage();
    });
    tbody.appendChild(tr);
  });

  $('#switchAgent').onclick = ()=>{
    const idx = catalog.findIndex(c=>c.key===agent.key);
    agent = catalog[(idx+1)%catalog.length]; renderAgentPage();
  };
}

/* ===== config page ===== */
function renderConfigPage(){
  $('#cfgAgent').textContent = agent.title.replace(' Agent','');
  $('#cfgAuto').onclick = ()=>{
    $('#inpProduct').value = (agent.key==='supplier') ? 'é‡‡è´­åŠ¨åŠ›ç”µæ± é“å‹æä¸CNCåŠ å·¥ä»¶'
      : (agent.key==='software') ? 'é¢å‘åˆ¶é€ ä¸šçš„è®¾å¤‡å¥åº·ç›‘æµ‹SaaS'
      : (agent.key==='bank') ? 'å¯¹å…¬ç»“ç®—ä¸ä¾›åº”é“¾é‡‘èå¥—é¤'
      : 'æœºå™¨è§†è§‰ç¼ºé™·æ£€æµ‹ç³»ç»Ÿ';
    $('#inpMarket').value = (agent.key==='bank') ? 'ä¾›åº”é“¾ä¼ä¸šï½œåä¸œ' : 'æ–°èƒ½æºï½œé•¿ä¸‰è§’';
  };
  $('#toResults').onclick = (e)=>{
    const prod = $('#inpProduct').value.trim();
    if(!prod){ e.preventDefault(); toast('è¯·å¡«å†™äº§å“/æœåŠ¡'); return; }
    const market = $('#inpMarket').value.trim();
    results = synthesizeLeads(prod, market, agent.key);
    filtered=[...results];
  };
}

/* ===== synthesize & scoring & geo ===== */
function synthesizeLeads(prod, market, key, aroundPos=null){
  const inds = (key==='software')?['åˆ¶é€ ','æ–°èƒ½æº','æ±½è½¦','ç‰©æµ','åŒ–å·¥']
              : (key==='bank')?['åˆ¶é€ ','æ‰¹å‘é›¶å”®','å¤–è´¸','åŸºå»º','ç‰©æµ']
              : (key==='supplier')?['ææ–™','æœºæ¢°','æ³¨å¡‘','CNC','ç”µæ± '] : ['åˆ¶é€ ','æ–°èƒ½æº','æ±½è½¦','ç”µå­','åŒ»è¯'];
  const regs = Object.keys(cityCenters);
  const signals = ['æ‹›æŠ•æ ‡','æ‹›è˜','èµ„è´¨','æ–°è®¾','ç ”å‘','å‡ºå£'];
  const list=[];
  for(let i=0;i<80;i++){
    const industry = pickNear(inds, market);
    const region = pickNear(regs, market) || 'ä¸Šæµ·';
    const size = ['å°å‹','ä¸­å‹','å¤§å‹'][rand(0,2)];
    const tags = sample(signals, rand(1,3));
    const score = calcScore({industry,region,size,tags}, market);
    // åœ°ç†åæ ‡
    let baseLatLng = cityCenters[region] || [31.23,121.47];
    if(aroundPos){ baseLatLng = aroundPos; }
    const [lat,lng] = jitter(baseLatLng, aroundPos? 8 : 12);
    const reason = `è¡Œä¸šåŒ¹é…ï¼š${industry} Â· åœ°åŒºï¼š${region} Â· åŠ¨æ€ï¼š${tags.join('ã€')} Â· è§„æ¨¡ï¼š${size}`;
    list.push({ id:`U${i}_${Date.now()}`, name:`${region}${industry}ç§‘æŠ€ç¬¬${100+i}å·`, industry, region, size, tags, score, reason, prod, lat, lng });
  }
  return list.sort((a,b)=>b.score-a.score);
}
function pickNear(arr, market){ if(!market) return arr[rand(0,arr.length-1)]; const hit = arr.find(x=> market.includes(x)); return hit || arr[rand(0,arr.length-1)] }
function calcScore(item, market){
  let s=0; s += market && market.includes(item.industry) ? 42 : 26;
  s += market && market.includes(item.region) ? 18 : 10;
  s += (item.tags.includes('æ‹›æŠ•æ ‡')||item.tags.includes('æ‹›è˜')) ? 20 : 12;
  s += (item.size!=='å°å‹') ? 14 : 9;
  s += rand(-3,3);
  return Math.max(0,Math.min(100,s));
}
function buildPitch(it, style='formal'){
  const company = profile.name || 'æˆ‘ä»¬';
  const hook = style==='friendly' ? `å—¨ï½æ³¨æ„åˆ°è´µå¸åœ¨${it.industry}é¢†åŸŸè¿‘æœŸæœ‰${it.tags[0]||'é¡¹ç›®'}åŠ¨æ€ã€‚`
             : style==='expert' ? `ç»“åˆè´µå¸åœ¨${it.industry}èµ›é“çš„é¡¹ç›®èŠ‚å¥ä¸${it.tags[0]||'ä¸šåŠ¡æ‰©å¼ '}ä¿¡å·ï¼Œæˆ‘ä»¬æœ‰æ›´å¥‘åˆçš„è·¯å¾„ã€‚`
             : `æ‚¨å¥½ï¼Œç•™æ„åˆ°è´µå¸è¿‘æœŸåœ¨${it.industry}æ–¹å‘çš„${it.tags[0]||'ä¸šåŠ¡'}åŠ¨æ€ã€‚`;
  const body = (agent.key==='supplier')
      ? `${company}æ­£åœ¨ã€Œ${it.prod}ã€ï¼Œæˆ‘ä»¬æä¾›å¯è§†åŒ–è´¨é‡ä¸äº¤ä»˜ç®¡æ§æ–¹æ¡ˆï¼Œè¦†ç›–æ¥æ–™æ£€éªŒâ€”è¿‡ç¨‹è¿½æº¯â€”éªŒæ”¶ã€‚`
      : `${company}æ¨å‡ºã€Œ${it.prod}ã€ï¼Œå·²åœ¨åŒç±»ä¼ä¸šè½åœ°ï¼Œå¯æ˜¾è‘—æå‡${it.industry}åœºæ™¯çš„äººæ•ˆä¸è´¨é‡ã€‚`;
  const cta = style==='friendly' ? `è¿™å‘¨å¯å¦æ¥ä¸ª 20 åˆ†é’Ÿå°èŠï¼Ÿæˆ‘å¸¦ä¸Šæ¡ˆä¾‹å’ŒæŠ¥ä»·å‚è€ƒã€‚`
             : style==='expert' ? `å»ºè®®å…ˆåš 20 åˆ†é’Ÿéœ€æ±‚æ¾„æ¸…ï¼ŒæŒ‰${it.size}ä¼ä¸šæ ‡å‡†æ ¸ç®—äººæ•ˆå›æŠ¥ä¸ä¸Šçº¿è·¯å¾„ã€‚`
             : `æ˜¯å¦æ–¹ä¾¿å®‰æ’ä¸€æ¬¡ 20 åˆ†é’Ÿæ²Ÿé€šï¼Ÿæˆ‘ä»¬å‡†å¤‡äº†åŒ¹é…${it.region}${it.industry}çš„å®æ–½æ–¹æ¡ˆä¸æµ‹ç®—ã€‚`;
  return `${hook}\n${body}\n${cta}`;
}

/* ===== results page ===== */
let sortKey='score', sortAsc=false;
let currentFilter=null;

function renderResultsPage(){
  // åˆæ¬¡è¿›å…¥å…œåº•
  if(!results.length){ results = synthesizeLeads('è§£å†³æ–¹æ¡ˆ','æ–°èƒ½æºï½œé•¿ä¸‰è§’', agent.key); filtered=[...results]; }
  // è§†å›¾ç»‘å®š
  $('#tabTable').onclick=()=>{ $('#tabTable').classList.add('active'); $('#tabMap').classList.remove('active'); $('#viewTable').style.display='block'; $('#viewMap').style.display='none'; };
  $('#tabMap').onclick=()=>{ $('#tabMap').classList.add('active'); $('#tabTable').classList.remove('active'); $('#viewTable').style.display='none'; $('#viewMap').style.display='block'; initMap(); };
  $('#btnCSV').onclick = ()=> exportCSV(filtered);
  $('#btnSave').onclick = saveList;
  $('#btnNear').onclick = ()=> {
    if(!navigator.geolocation){ toast('æµè§ˆå™¨ä¸æ”¯æŒå®šä½'); return; }
    navigator.geolocation.getCurrentPosition((pos)=>{
      currentPos=[pos.coords.latitude, pos.coords.longitude];
      filtered = results.filter(r => haversine([r.lat,r.lng], currentPos) <= 10);
      renderTable(); if(map){ map.setView(currentPos, 12); renderMarkers(filtered); }
      toast('å·²ç­›é€‰é™„è¿‘10km');
    }, ()=> toast('å®šä½å¤±è´¥'));
  };
  $('#btnResetFilter').onclick = ()=>{ filtered=[...results]; currentFilter=null; renderTable(); if(map) renderMarkers(filtered); };

  // ç­›é€‰ chips
  $('#page-results').addEventListener('click', (e)=>{
    const b=e.target.closest('[data-refine]'); if(!b) return;
    const [k,v]=b.getAttribute('data-refine').split(':');
    currentFilter={k,v};
    filtered = results.filter(x => k==='industry' ? x.industry.includes(v)
                               : k==='region'   ? x.region.includes(v)
                               : x.tags.includes(v));
    renderTable(); if(map) renderMarkers(filtered);
    toast(`å·²åº”ç”¨ï¼š${k}=${v}`);
  });

  // åˆå§‹æ¸²æŸ“
  renderTable();
  // åœ°å›¾æ‡’åˆå§‹åŒ–
}

function renderTable(){
  // æ’åº
  filtered.sort((a,b)=>{
    if(a[sortKey]===b[sortKey]) return 0;
    return sortAsc ? (a[sortKey] > b[sortKey] ? 1 : -1) : (a[sortKey] < b[sortKey] ? 1 : -1);
  });
  const tb = $('#resultTable tbody'); tb.innerHTML='';
  filtered.slice(0,100).forEach(it=>{
    const tr=document.createElement('tr');
    const pitch = buildPitch(it,'formal');
    tr.innerHTML = `
      <td>${it.name}</td>
      <td>${it.industry}</td>
      <td>${it.region}</td>
      <td>${it.size}</td>
      <td>${it.tags.join('ã€')}</td>
      <td>${it.score}</td>
      <td>${it.reason}</td>
      <td>
        <div class="rowActions">
          <button class="btn ghost" data-pitch="${it.id}" data-style="formal">æ­£å¼</button>
          <button class="btn ghost" data-pitch="${it.id}" data-style="friendly">è½»æ¾</button>
          <button class="btn ghost" data-pitch="${it.id}" data-style="expert">ä¸“ä¸š</button>
          <button class="btn" data-copy="${it.id}">å¤åˆ¶</button>
        </div>
        <pre id="p_${it.id}" class="note">${pitch}</pre>
      </td>`;
    tr.addEventListener('click', (e)=>{
      const ps=e.target.closest('[data-pitch]'); if(ps){ const st=ps.getAttribute('data-style'); $('#p_'+ps.getAttribute('data-pitch')).textContent=buildPitch(it,st); }
      const cp=e.target.closest('[data-copy]'); if(cp){ const txt=$('#p_'+cp.getAttribute('data-copy')).textContent; navigator.clipboard.writeText(txt).then(()=>toast('å·²å¤åˆ¶è¯æœ¯')); }
    });
    tb.appendChild(tr);
  });

  // ç»‘å®šåˆ—å¤´æ’åº
  $$('#resultTable thead th.sortable').forEach(th=>{
    th.onclick = ()=>{
      const key = th.getAttribute('data-sort');
      if(sortKey===key) sortAsc=!sortAsc; else { sortKey=key; sortAsc=true; }
      renderTable();
    };
  });
}

function exportCSV(list){
  const rows=[['name','industry','region','size','tags','score','reason','lat','lng'],
    ...list.map(it=>[it.name,it.industry,it.region,it.size,it.tags.join('|'),it.score,it.reason,it.lat,it.lng])];
  csvDownload(rows,'leads.csv');
}

/* ===== map ===== */
function initMap(){
  if(map) { renderMarkers(filtered); return; }
  map = L.map('map',{zoomControl:true}).setView([31.23,121.47], 10);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'Â© OpenStreetMap'}).addTo(map);
  markersLayer = L.layerGroup().addTo(map);
  renderMarkers(filtered);
}
function renderMarkers(list){
  markersLayer.clearLayers();
  list.forEach(it=>{
    const m = L.marker([it.lat,it.lng]).addTo(markersLayer);
    const html = `<b>${it.name}</b><br>${it.region} Â· ${it.industry} Â· ${it.size}<br/>åˆ†æ•°ï¼š<b>${it.score}</b><br/><small>${it.reason}</small><br/><button data-mid="${it.id}" class="leaf-copy">å¤åˆ¶è¯æœ¯</button>`;
    m.bindPopup(html);
    m.on('popupopen', (e)=>{
      const btn = e.popup._contentNode.querySelector('.leaf-copy');
      if(btn){
        btn.addEventListener('click', ()=>{
          const txt = buildPitch(it,'formal');
          navigator.clipboard.writeText(txt).then(()=>toast('å·²å¤åˆ¶è¯æœ¯'));
        });
      }
    });
  });
}
function focusNear(center, km=10){
  if(!map) initMap();
  map.setView(center, 12);
  // ç”¨åœ†åœˆç¤ºæ„èŒƒå›´
  L.circle(center,{radius:km*1000,color:'#22d3ee',fill:false}).addTo(map);
}
function haversine([lat1,lon1],[lat2,lon2]){
  const toRad = d=>d*Math.PI/180, R=6371;
  const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(a)); // km
}

/* ===== assets ===== */
const cacheKey='hyper_map_lists';
function saveList(){
  if(!filtered.length) return toast('æ²¡æœ‰å¯ä¿å­˜çš„æ•°æ®');
  const rec={ id:'L'+Date.now(), title:`${profile.name||'æœªå‘½å'} Â· ${results[0]?.prod||'æ–¹æ¡ˆ'}`, detail:`æ¡ç›®ï¼š${filtered.length}`, ts:new Date().toLocaleString(),
    items: filtered.map(it=>[it.name,it.industry,it.region,it.size,it.tags.join('|'),it.score,it.reason,it.lat,it.lng]) };
  const box=JSON.parse(localStorage.getItem(cacheKey)||'[]'); box.unshift(rec); localStorage.setItem(cacheKey,JSON.stringify(box));
  toast('å·²ä¿å­˜åˆ°èµ„äº§'); location.hash="#/assets";
}
function renderAssetsPage(){
  const data=JSON.parse(localStorage.getItem(cacheKey)||'[]');
  const tbody=$('#assetsTable tbody'); tbody.innerHTML='';
  if(!data.length){ tbody.innerHTML = `<tr><td colspan="4" style="color:#9db7ff">æš‚æ— ä¿å­˜çš„åå•ã€‚</td></tr>`; return; }
  data.forEach((r,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${r.title}</td><td>${r.detail}</td><td>${r.ts}</td>
      <td><button class="btn ghost" data-exp="${i}">å¯¼å‡º</button> <button class="btn ghost" data-del="${i}">åˆ é™¤</button></td>`;
    tr.addEventListener('click',e=>{
      const ex=e.target.closest('[data-exp]'); const dl=e.target.closest('[data-del]');
      if(ex){ const idx=+ex.getAttribute('data-exp'); const rows=[['name','industry','region','size','tags','score','reason','lat','lng'], ...data[idx].items]; csvDownload(rows, `${data[idx].title}.csv`); }
      if(dl){ const idx=+e.target.getAttribute('data-del'); const arr=JSON.parse(localStorage.getItem(cacheKey)||'[]'); arr.splice(idx,1); localStorage.setItem(cacheKey,JSON.stringify(arr)); renderAssetsPage(); toast('å·²åˆ é™¤'); }
    });
    tbody.appendChild(tr);
  });
}

/* ===== boot & router ===== */
router();
// ä¾¿æ·ï¼šä»é¦–é¡µè‡ªåŠ¨æ¨è
function autoSeedFromText(text){
  $('#homeText').value=text; detectFromHome();
}
// å¯æŒ‰éœ€æ‰“å¼€ï¼šautoSeedFromText('æˆ‘æ˜¯ä¸Šæµ·äº‘æ‰è½¯ä»¶ï¼Œæƒ³å–SaaSç»™åˆ¶é€ ä¸š');
</script>
</body>
</html>
