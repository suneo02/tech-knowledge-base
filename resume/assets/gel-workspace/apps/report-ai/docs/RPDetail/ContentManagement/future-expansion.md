# 未来扩展（按层 / 按场景）

> 汇总 Canonical 层、前端数据层、展示层以及生成/保存等纵向场景的潜在演进方向。实施前请同步更新横纵文档，保证团队心智一致。

## 1. 按层扩展

### 1.1 Canonical 层

- **逻辑全量 / 差量上报**：保持大纲结构全量，正文仅上传变动章节；后端需支持混合载荷与 Canonical 复合。
- **版本指纹**：为 Canonical 引入 `version`/`ETag`，配合前端 `txId` 提供幂等与冲突检测基础。
- **生成日志持久化**：将 `generationMessages` 升级为 `generationSession`（含 prompt、模型版本、轨迹），方便追溯。

### 1.2 前端数据层

- **章节级状态**：Draft 节点增加 `baselineHash`、`dirtySince`，支持更细粒度的待保存/失败提示。
- **自动保存调度**：根据输入频率、网络质量动态调整自动保存阈值；在弱网场景启用批量/指数退避。
- **并发与协同**：探索 version/Idempotency-Key、乐观锁策略，或评估 OT/CRDT 接入，实现多端协作。
- **离线缓存**：接入 IndexedDB，将保存快照缓存在本地，恢复网络后对比哈希再批量上报。

### 1.3 展示层

- **增量注水**：在保留章节结构的前提下，只重绘发生改变的块，进一步减少 DOM 抖动。
- **Diff 可视化**：在 LiveOutline/正文中突出未保存差异，配合 Draft 的章级指纹。
- **流式体验优化**：对超长章节的流式更新做分段渲染，保持帧率。

## 2. 按场景扩展

### 2.1 生成场景

- **章节增量生成**：在保持全量树的前提下，只对指定章节执行生成和注水，减少锁定范围。
- **多草稿保留**：支持一次生成保留多个候选稿，用户可择优合入 Canonical。
- **生成回溯与审计**：将生成输出与输入参数存档，提供可视化对比与回溯。

### 2.2 编辑与保存场景

- **Diff-Match-Patch**：对超大章节使用文本 diff，降低载荷并保留冲突检测能力。
- **保存配额监控**：提供界面级提示（例如“保存过于频繁”），并在后台限流或合并请求。
- **失败自愈**：自动重试策略（指数退避），并允许用户在错误提示中直接上传离线快照。

### 2.3 守卫 / 路由场景

- **粒度更细的提示**：在离开页面弹窗中列出受影响章节，辅助决策。
- **跨报告同步**：多标签或多窗口同时编辑时，提示“最新保存时间/来源”，避免覆盖。

### 2.4 监控与告警

- **保存/生成闭环指标**：成功率、P95 延迟、失败分类、`docHash` 重复失败次数。
- **链路追踪**：`docHash + txId` 全链路追踪（前端 → API → 后端），便于排查。
- **用户级体验指标**：记录自动保存打断编辑的次数、生成失败的重试路径。

> 扩展工作开始前，请确认对应的层或场景负责人，并在实施后同步更新 README 横纵矩阵及相关场景文档。

