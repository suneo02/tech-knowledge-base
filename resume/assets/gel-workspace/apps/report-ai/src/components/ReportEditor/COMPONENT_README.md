# ReportEditor 组件（方案 A）

本页将 ReportEditor 在“方案 A = 内容只走 ref 命令；props 仅承载结构/控制”下的定位、边界与操作手册沉淀为文档，不包含代码。

## 组件定位

- 半受控编辑器：内容非全受控（不绑定 value），行为受控（只读/锁定/Loading/保存指示等通过 props 控制）。
- 纯视图角色：不内置保存/生成/并发控制等业务流程；仅提供命令式内容注入与必要的交互能力。

## 设计原则

- 内容命令式：正文写入仅走 ref 命令（全量注水、章节替换、Range 增量 patch）。
- props 轻：仅承载结构与控制状态，不传 html，避免大对象 diff。
- 外层决策：是否/何时覆盖正文完全由 ReportContent 判定，编辑器只执行命令。

## 输入/输出

- 输入（props）：
  - 结构：大纲映射（章节顺序/层级/折叠等）。
  - 控制：只读、锁定、Loading、模式（编辑/预览）、高亮等。
  - 不包含：任何 html 正文或富文本快照。
- 输出（回调）：
  - 章节粒度的内容变更（onChange）。
  - 内联大纲变更意图（如标题/层级调整）。
  - 滚动/选区变化等交互信号。
- 命令（ref）：
  - 注水类：全量设值、章节替换、基于 Range 的增量 patch（用于流式预览的合批写入）。
  - 交互类：focus、scrollToChapter、选区读取/恢复、就绪查询等。

## 生命周期与操作手册

1. 初始化 / 切版

- 外层拼接完整 HTML → 通过 ref 做一次性全量注水；重置所有 LocalDraft。
- 根据场景设置只读/Loading 等控制。

2. 用户编辑

- 编辑行为仅通过回调上报，外层更新 LocalDraft 与保存状态机；编辑器不被重设内容。

3. 保存 ACK

- 成功仅合入 Canonical，不触发 setContent（避免回环与光标抖动）。
- 失败保留现状、标记错误，允许重试。

4. AI 生成

- 目标范围只读；允许以小粒度增量预览（不走 setContent），50–100ms 节流合批。
- 生成完成后：
  - 全文完成 → 全量注水；
  - 某章完成 → 仅该章注水（建议保留选区）；
  - 注水后解除只读，并重置相应 LocalDraft。

5. 章节重生成

- 触发时清空该章 htmlContent 并设为只读；完成时落盘新的 aigcContent → 章节级注水 → 解锁。

## 闸门（允许/禁止注水）

- 允许：页面还原/切版、AI（重）生成完成、外部合并/回到快照（业务审查通过）。
- 禁止：保存 ACK、局部结构微调、保存状态变化等。

## 并发与一致性

- 不理解 Epoch/Lease：编辑器不参与版本判断；是否覆盖由业务层决定。
- 只读门控：生成/重生成期间目标范围只读，避免与增量写入冲突。

## 性能与体验

- props 轻、命令重：正文仅通过命令写入，减少 React diff 压力。
- 增量期节流：流式预览使用小粒度 patch，并在主线程 50–100ms 节流合批；完成后一次性“干净版本”注水。
- 注水粒度优先章节级：减少重排、尽量保留光标；全文注水仅用于初始化/切版/全文生成完成。

## 错误与冲突

- 423/409（锁定/版本冲突）：保留本地草稿、标记冲突，不做注水覆盖；由用户决定合并或覆盖。
- 生成失败：解除只读，保留现状，允许重试；不做注水。

## 验收清单（组件侧）

- 不从 props 读取/覆盖 html。
- 命令式 API 完整覆盖：全量注水、章节替换、增量 patch、focus/scroll/选区。
- 回调粒度：章节级 onChange 与大纲变更意图可被外层可靠消费。
- 只读门控：生成/重生成期间可精确锁定目标范围。

更多上下文与策略：../../../docs/RPDetail/ContentManagement/data-layer-guide.md
