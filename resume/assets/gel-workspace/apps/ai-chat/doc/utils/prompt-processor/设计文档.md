# 提示词处理器 (Prompt Processor) 设计文档

## 概述

提示词处理器是一个用于处理提示词中特殊标记的工具函数集合。它能够识别提示词中的 `@标记`，并将其转换为对应列字段的模板变量格式 `{{field}}`，支持多种匹配策略，包括精确匹配、模糊匹配、忽略空格匹配等，适用于各种复杂的提示词处理场景。

## 详细功能说明

### 1. 基础标记处理 (processColumnTags)

- 使用正则表达式识别提示词中的 `@标记`
- 支持四种匹配策略：
  1. 精确匹配：完全匹配列标题
  2. 忽略空格匹配：忽略空格后进行匹配
  3. 部分匹配：检查列标题是否包含在输入文本中
  4. 反向部分匹配：检查输入文本是否包含在列标题中
- 替换为双花括号格式：`{{field}}`

### 2. 高级标记处理 (processAdvancedTags)

- 增强版的标记处理函数，支持更多配置选项
- 支持直接关键词映射，无需依赖列定义
- 模糊匹配选项，可以根据相似度自动选择最佳匹配
- 支持区分大小写选项
- 使用编辑距离算法计算字符串相似度
- 处理文本偏移量，确保多次替换不会影响后续匹配位置

### 3. 企业信息处理 (processCompanyPrompt)

- 针对企业相关信息提取的专用处理函数
- 预定义常见企业关键词映射（如"企业名称"、"网站"、"联系方式"等）
- 自动处理同义词（如"公司"="企业名称"，"官网"="网站"等）
- 优化企业信息提取类提示词的处理效率
- 支持处理复杂的 Markdown 格式提示词，如企业上下游生态信息提取模板

## 参数说明

### processColumnTags

| 参数名  | 类型                   | 描述             |
| ------- | ---------------------- | ---------------- |
| prompt  | string                 | 原始提示词       |
| columns | ExtendedColumnDefine[] | 可用的列定义数组 |
| 返回值  | string                 | 处理后的提示词   |

### processAdvancedTags

| 参数名                 | 类型                   | 描述                          |
| ---------------------- | ---------------------- | ----------------------------- |
| prompt                 | string                 | 原始提示词                    |
| columns                | ExtendedColumnDefine[] | 可用的列定义数组              |
| options                | object                 | 额外配置选项                  |
| options.fuzzyMatch     | boolean                | 是否启用模糊匹配，默认为 true |
| options.caseSensitive  | boolean                | 是否区分大小写，默认为 false  |
| options.keywordMapping | Record<string, string> | 特定关键词到字段的映射        |
| 返回值                 | string                 | 处理后的提示词                |

### processCompanyPrompt

| 参数名  | 类型                   | 描述             |
| ------- | ---------------------- | ---------------- |
| prompt  | string                 | 原始提示词       |
| columns | ExtendedColumnDefine[] | 可用的列定义数组 |
| 返回值  | string                 | 处理后的提示词   |

## 返回值说明

所有处理函数都返回处理后的提示词字符串，其中 `@标记` 被替换为 `{{field}}` 格式。如果无法找到匹配的标记，则保留原始文本不变。

## 使用示例

### 基础使用

```typescript
import { processColumnTags } from '@/utils/prompt-processor'

// 列定义
const columns = [
  { field: 'companyName', title: '企业名称', width: 120 },
  { field: 'website', title: '网站', width: 120 },
]

// 处理提示词
const prompt = '请分析@企业名称的基本情况'
const processed = processColumnTags(prompt, columns)
// 结果: '请分析{{companyName}}的基本情况'
```

### 高级使用

```typescript
import { processAdvancedTags } from '@/utils/prompt-processor'

// 列定义
const columns = [
  { field: 'companyName', title: '企业名称', width: 120 },
  { field: 'website', title: '网站', width: 120 },
]

// 关键词映射
const keywordMapping = {
  公司: 'companyName',
  官网: 'website',
}

// 处理提示词
const prompt = '请访问 @公司 的 @官网'
const processed = processAdvancedTags(prompt, columns, { keywordMapping })
// 结果: '请访问 {{companyName}} 的 {{website}}'
```

### 处理企业信息

```typescript
import { processCompanyPrompt } from '@/utils/prompt-processor'

// 列定义
const columns = [
  { field: 'companyName', title: '企业名称', width: 120 },
  { field: 'website', title: '网站', width: 120 },
  { field: 'industry', title: '行业', width: 100 },
]

// 处理提示词
const prompt = `请访问 @企业名称 的网址（ @网站 ），分析其所属 @行业`
const processed = processCompanyPrompt(prompt, columns)
// 结果: '请访问 {{companyName}} 的网址（ {{website}} ），分析其所属 {{industry}}'
```

### 处理企业上下游生态提取模板

```typescript
import { processCompanyPrompt } from '@/utils/prompt-processor'

// 列定义
const columns = [
  { field: 'companyName', title: '企业名称', width: 120 },
  { field: 'website', title: '网站', width: 120 },
]

// 复杂的企业上下游生态提取提示词
const prompt = `请访问 @企业名称 的网址（ @网站 ），提取以下与上下游生态相关的信息：
1. **客户名称**：列出网址中明确提及的企业客户名称。
2. **合作伙伴**：提取网址中提到的战略合作方、生态合作方等。
3. **渠道合作**：是否提及分销商、代理商、渠道合作模式或相关企业名称。
4. **服务商或供应商**：是否提到技术提供商、硬件/软件供应商、云服务平台等。
5. **合作内容简述**：对每类合作可附带一句简要描述合作内容。`

const processed = processCompanyPrompt(prompt, columns)
// 结果: 将 @企业名称 替换为 {{companyName}}，将 @网站 替换为 {{website}}
```

## 单元测试

提示词处理器包含全面的单元测试，覆盖了各种使用场景和边界情况。测试位于 `src/utils/__tests__/prompt-processor.test.ts`。

测试示例包括：

- 精确匹配测试
- 忽略空格匹配测试
- 多个标记处理测试
- 关键词映射测试
- 模糊匹配测试
- 企业信息提取测试
- 复杂的企业上下游生态提取模板测试
