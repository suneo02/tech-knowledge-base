# API错误处理系统设计文档

## 概述

本文档描述了统一的API错误处理系统设计与实现，该系统基于错误码配置，能够根据不同的错误类型显示不同的错误弹窗，并支持自定义操作按钮和交互逻辑。

## 系统架构

错误处理系统由以下几个部分组成：

1. **错误配置（ErrorConfig）**：定义不同错误码对应的处理方式和UI配置
2. **错误弹窗组件（ErrorPopup）**：显示不同类型的错误弹窗
3. **错误处理服务（ErrorService）**：管理错误弹窗的显示和处理逻辑
4. **API拦截器（Interceptors）**：拦截API请求中的错误并调用错误处理器
5. **错误处理Hook（useErrorHandler）**：提供在组件中使用错误处理系统的便捷方法

## 核心功能

### 错误配置

错误配置定义了不同错误码对应的UI和交互逻辑，包括：

- 错误标题和消息
- 错误类型（error、warning、info、success）
- 是否显示图标
- 操作按钮配置
- 自动关闭时间
- 是否可手动关闭

### 错误弹窗组件

错误弹窗组件负责根据错误配置显示不同类型的错误弹窗，包括：

- 显示错误信息
- 显示对应类型的图标
- 显示操作按钮
- 处理按钮点击事件

### 错误处理服务

错误处理服务提供了统一的错误处理逻辑，包括：

- 创建和管理错误弹窗
- 处理API错误
- 提供手动显示错误的方法
- 提供关闭错误弹窗的方法

### API拦截器

API拦截器负责拦截API请求中的错误，并调用错误处理服务进行处理，包括：

- 拦截API请求中的错误
- 解析错误码和错误消息
- 调用错误处理服务显示错误弹窗

### 错误处理Hook

错误处理Hook提供了在组件中使用错误处理系统的便捷方法，包括：

- 显示错误
- 关闭错误
- 创建自定义错误操作
- 显示自定义错误

## 使用示例

### 1. 使用API请求（自动错误处理）

当使用API请求时，错误会被自动拦截并处理：

```typescript
import { requestRaw } from '@/api/axios'

// 发起API请求
const fetchData = async () => {
  try {
    const response = await requestRaw.get('/api/data')
    return response.data
  } catch (error) {
    // 错误已由拦截器自动处理，无需额外处理
    console.error('API请求失败', error)
    return null
  }
}
```

### 2. 手动显示错误

在某些场景下，可能需要手动显示错误：

```tsx
import { useErrorHandler } from '@/hooks/useErrorHandler'

const MyComponent = () => {
  const { displayError } = useErrorHandler()

  const handleButtonClick = () => {
    // 显示积分不足错误
    displayError(100001)
  }

  return <button onClick={handleButtonClick}>测试积分不足错误</button>
}
```

### 3. 自定义错误操作

可以自定义错误操作按钮和交互逻辑：

```tsx
import { useErrorHandler } from '@/hooks/useErrorHandler'
import { ErrorActionType } from '@/api/error/errorConfig'

const MyComponent = () => {
  const { displayCustomError, createErrorAction } = useErrorHandler()

  const handleShowCustomError = () => {
    displayCustomError(100001, {
      title: '自定义标题',
      message: '自定义错误消息',
      actions: [
        createErrorAction(ErrorActionType.CONFIRM, '去充值', () => {
          // 自定义充值逻辑
          console.log('跳转到自定义充值页面')
        }),
        createErrorAction(ErrorActionType.CANCEL, '暂不充值'),
      ],
    })
  }

  return <button onClick={handleShowCustomError}>显示自定义错误</button>
}
```

## 配置新的错误码

要配置新的错误码，需要在 `src/api/error/errorConfig.ts` 文件中的 `ERROR_CONFIG_MAP` 中添加配置：

```typescript
// 在 ERROR_CONFIG_MAP 中添加新的错误码配置
export const ERROR_CONFIG_MAP: Record<string | number, ErrorConfig> = {
  // ... 已有配置

  // 添加新的错误码配置
  200001: {
    title: t('新错误码标题ID', '新错误标题'),
    message: t('新错误码消息ID', '新错误消息'),
    type: 'warning',
    showIcon: true,
    actions: [
      {
        type: ErrorActionType.CONFIRM,
        text: t('确认按钮ID', '确认'),
      },
      {
        type: ErrorActionType.CANCEL,
        text: t('取消按钮ID', '取消'),
      },
    ],
    closable: true,
  },
}
```

## 注意事项

1. 错误配置应该尽量简洁明了，避免过多的文本内容
2. 操作按钮应该清晰表达操作意图，避免模糊的表述
3. 对于需要用户确认的错误，应该提供明确的操作选项
4. 对于通知类型的错误，可以设置自动关闭时间
5. 错误类型应该与错误严重程度相符（error、warning、info、success）
