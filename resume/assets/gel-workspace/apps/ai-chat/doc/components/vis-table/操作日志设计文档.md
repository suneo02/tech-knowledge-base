# VisTable 操作日志功能设计文档

## 概述

本文档描述了 VisTable 组件中操作日志功能的设计与实现。该功能允许记录用户对表格的操作，并提供撤销/重做能力，帮助用户在数据操作过程中避免错误，提高用户体验。

## 设计目标

1. **操作记录**：记录用户对表格的所有操作，包括修改单元格、添加列、删除行等
2. **撤销/重做**：提供撤销和重做功能，允许用户回退或前进操作
3. **操作历史查看**：提供界面组件展示操作历史
4. **扩展性**：设计应易于扩展，支持将来添加新的操作类型
5. **与现有代码集成**：无缝集成到现有的 VisTable 组件中

## 系统架构

### 核心组件

1. **类型定义 (operationTypes.ts)**：

   - 定义操作类型枚举
   - 定义各种操作的接口
   - 定义同步状态枚举

2. **操作上下文 (VisTableOperationContext.tsx)**：

   - 提供操作日志的状态管理
   - 实现记录、撤销、重做等功能
   - 维护操作日志的状态

3. **操作状态钩子 (useVisTableOperationState.ts)**：

   - 提供访问和管理操作状态的方法
   - 过滤特定表格的操作记录

4. **表格历史增强钩子 (useTableHistoryActions.ts)**：

   - 包装 useTableActions 方法，添加操作日志功能
   - 维护原始方法的接口不变

5. **操作历史面板 (OperationHistoryPanel.tsx)**：
   - 展示操作历史记录
   - 显示操作类型、时间、状态等信息

### 数据流

```
用户操作 → useTableHistoryActions → 执行原始方法 → 记录操作 → 更新操作日志状态
      ↑                                                     ↓
      └─────────────── 撤销/重做 ───────────────────────────┘
```

## 核心功能实现

### 1. 操作类型定义

```typescript
// 定义操作类型枚举
export enum VisTableOperationType {
  SET_CELL_VALUE = 'SET_CELL_VALUE',
  ADD_COLUMN = 'ADD_COLUMN',
  DELETE_RECORDS = 'DELETE_RECORDS',
  SET_RECORDS = 'SET_RECORDS',
  // ...其他操作类型
}

// 基础操作接口
export interface BaseOperation {
  type: VisTableOperationType
  timestamp: string
  syncStatus: keyof typeof SyncStatus
  error?: string
}

// 各种具体操作接口...
```

### 2. 操作上下文实现

```typescript
// 操作状态
interface VisTableOperationState {
  operations: Array<VisTableOperation & { id: string; disabled?: boolean }>
  operationLogs: OperationLog[]
  tableIdMap: Record<string, string> // 操作ID到表格ID的映射
}

// 记录操作
const recordOperation = (operation, tableId) => {
  // 记录操作并创建日志
}

// 撤销操作
const undo = (tableId) => {
  // 标记最近一个未禁用的操作为禁用
}

// 重做操作
const redo = (tableId) => {
  // 标记最近一个禁用的操作为未禁用
}
```

### 3. 表格历史增强钩子

```typescript
export const useTableHistoryActions = (options: WithTableHistoryOptions) => {
  // 获取基础表格操作方法
  const baseActions = useTableActions()

  // 获取操作状态管理
  const { recordOperation, undo, redo } = useVisTableOperationState(tableId)

  // 包装方法（例如 setCellValue）
  const setCellValue = (col, row, value) => {
    // 获取原始值
    const oldValue = baseActions.getCellValue(col, row)

    // 执行原始操作
    const result = baseActions.setCellValue(col, row, value)

    // 记录操作日志
    if (result) {
      recordOperation({
        type: VisTableOperationType.SET_CELL_VALUE,
        payload: { colIndex: col, rowIndex: row, value, originalValue: oldValue },
        // ...其他属性
      })
    }

    return result
  }

  // 返回增强后的方法
  return {
    ...baseActions,
    setCellValue,
    // ...其他增强方法
    undo,
    redo,
  }
}
```

## 使用方式

### 基本用法

1. **包装组件**：

   ```tsx
   // 引入 VisTableOperationProvider
   import { VisTableOperationProvider } from '@/components/VisTable'

   // 包装目标组件
   ;<VisTableOperationProvider>
     <VisTable />
   </VisTableOperationProvider>
   ```

2. **使用增强的表格操作**：

   ```tsx
   // 使用 useTableHistoryActions 代替 useTableActions
   const tableActions = useTableHistoryActions({ tableId: 'main-table' })

   // 使用方法，与原始 useTableActions 相同
   tableActions.setCellValue(0, 0, 'new value')

   // 使用撤销/重做
   tableActions.undo()
   tableActions.redo()
   ```

3. **显示操作历史**：
   ```tsx
   // 在工具栏或侧边栏中显示操作历史
   <OperationHistoryPanel tableId="main-table" />
   ```

## 后续扩展计划

1. **多重撤销/重做**：支持一次撤销/重做多个操作
2. **操作分组**：将相关操作分组，作为一个单元进行撤销/重做
3. **持久化**：将操作历史持久化到本地存储
4. **协作功能**：支持多用户协作时的操作历史同步

## 注意事项

1. 所有表格操作方法应返回布尔值表示成功或失败
2. 撤销/重做功能需要操作有明确的相反操作
3. 操作日志可能会占用内存，需要考虑限制日志数量或清理机制

## 相关文件

- `src/components/VisTable/types/operationTypes.ts`
- `src/components/VisTable/context/VisTableOperationContext.tsx`
- `src/components/VisTable/hooks/useVisTableOperationState.ts`
- `src/components/VisTable/hooks/withTableHistory.ts`
- `src/components/VisTable/components/OperationHistoryPanel.tsx`
