# AI-Chat 对话应用 | 2023.08 - 2024.03

**角色**：核心开发者（开发约 2 万行代码）

**项目背景**：企业对话应用，支持 AI 问答、表格处理、企业数据筛选。日均对话 5000+次，支持 100+并发用户。

## 技术挑战

- **代码组织**：2 万行代码的分层组织（UI/状态/逻辑/服务）
- **流式响应**：AI 流式数据的实时渲染、中断恢复、错误处理
- **表格处理**：1000+行表格数据的 AI 批量处理和进度跟踪
- **类型扩展**：文本、表格、图表等多种消息类型的渲染

## 🏗️ 代码组织

[📄](resume/assets/gel-workspace/packages/gel-ui/docs/biz/ai-chat/design/architecture-design.md)

### 四层代码分层

- **UI 层**：开发 AIChatApp 容器组件和 20+子组件，支持插槽定制
- **状态层**：封装 useChatBase Hook 管理会话状态，支持 1000+消息/会话
- **逻辑层**：编写 ChatHandler 处理对话流程，通过 HookBus 解耦事件
- **服务层**：实现 Preprocessing/Streaming/Finalize 处理请求生命周期

### 扩展能力

- **流程扩展**：在 Preflight/Streaming/Finalize 阶段注入业务逻辑
- **UI 扩展**：通过 React 插槽配置消息渲染组件
- **数据扩展**：编写自定义解析器处理业务数据格式

## 🧠 AI 对话功能

[📄](resume/assets/gel-workspace/packages/gel-ui/docs/biz/ai-chat/requirements/functional-requirements.md)

### 流式响应处理

- **SSE 集成**：接入 Server-Sent Events，首字节响应<2 秒，流式延迟<500ms
- **上下文管理**：使用 Redux 存储会话历史，支持 1000+消息/会话
- **状态管理**：实现创建 → 流式 → 完成 → 失败的状态机，处理中断和恢复
- **中断处理**：通过 AbortController 取消请求，保存已接收内容

### 消息解析

[📄](resume/assets/gel-workspace/packages/gel-ui/docs/biz/ai-chat/design/message-model-design.md)

- **类型继承**：定义 BaseMessage 基类，派生 AIMessage/UserMessage 等子类
- **解析流程**：检测消息类型 → 验证数据格式 → 转换为前端模型
- **错误降级**：解析失败时回退到纯文本渲染，避免白屏
- **组件映射**：根据消息类型映射到文本、表格、图表等渲染组件

## 📊 表格操作功能

### 表格事件处理

- **CRUD 操作**：开发表格的增删改查功能，支持单行和批量操作
- **状态同步**：通过 Redux 同步操作状态到服务端
- **批量处理**：实现多行数据的批量提交，减少网络请求

### AI 任务调度

- **任务队列**：使用数组实现 FIFO 队列，按优先级调度任务
- **轮询机制**：每 3 秒轮询任务状态，获取 AI 处理结果
- **日志记录**：记录任务 ID、状态、耗时等信息到 localStorage
- **并发控制**：限制同时执行 5 个任务，避免服务端过载

### 权限控制

- **积分扣减**：调用积分 API 扣减用户积分，不足时禁用功能
- **权限校验**：根据用户角色控制功能可见性和操作权限
- **资源限制**：限制单次处理行数 ≤1000，避免内存溢出

## 🔧 表格 AI 功能

### ETable 表格集成

- **AI 填充**：调用 AI API 根据列名和上下文生成单元格内容
- **批量处理**：将 1000 行数据分批(每批 50 行)并行提交，减少等待时间
- **进度展示**：使用 Progress 组件显示"已处理 50/1000 行"
- **错误重试**：单行失败时标记为红色，支持点击重试

### VTable 虚拟滚动

- **虚拟渲染**：使用 react-window 只渲染可见区域的 20 行，支持 10 万+行数据
- **懒加载**：滚动到底部时加载下一页数据(每页 100 行)
- **缓存优化**：使用 Map 缓存已渲染行，避免重复计算
- **实时更新**：通过 WebSocket 接收服务端推送，更新单元格状态

### 单元格 AI 处理

- **类型识别**：通过正则表达式识别日期、数字、邮箱等类型
- **上下文分析**：读取同行其他列和上下 3 行数据作为上下文
- **格式化**：统一日期格式为 YYYY-MM-DD，数字保留 2 位小数
- **异常检测**：检测空值、重复值、异常值，标记为黄色并提示

## 🎯 CDE 企业数据筛选

### 筛选条件构建

- **条件组合**：支持"(A AND B) OR C"的嵌套条件，最多 3 层
- **实时筛选**：输入条件后 300ms 防抖，自动更新结果列表
- **逻辑组合**：通过下拉选择 AND/OR，动态构建查询表达式
- **预设模板**：提供"注册资本>1000 万"等 10 个常用模板

### 数据预处理

- **数据清洗**：去除空格、统一大小写、删除特殊字符
- **质量检测**：检测缺失率、重复率、异常值占比，生成质量报告
- **格式转换**：统一日期格式、金额单位(万元/亿元)
- **完整性校验**：验证必填字段，标记不完整数据

### 监控和刷新

- **监控面板**：显示筛选耗时、结果数量、缓存命中率
- **定时刷新**：每 5 分钟自动刷新数据，支持手动刷新按钮
- **异常告警**：筛选超时(>10s)或结果为空时弹窗提示
- **性能分析**：记录慢查询(>5s)，输出到控制台供优化

## 📊 量化成果

### 代码质量

- **分层组织**：2 万行代码按 UI/状态/逻辑/服务分层，新功能开发时间从 3 天降至 2 天
- **流式响应**：SSE 首字节响应<2 秒，流式延迟<500ms，支持 1000+消息/会话
- **渲染优化**：使用 React.memo 包裹 15 个组件，重渲染次数减少 70%
- **虚拟滚动**：react-window 渲染 10 万行表格，FPS 从 15 提升至 60

### AI 处理

- **批量处理**：1000 行数据分 20 批并行处理，总耗时从 40 分钟降至 8 分钟
- **任务调度**：限制并发 5 个任务，服务端 CPU 占用从 90%降至 60%
- **错误重试**：单行失败自动重试 3 次，成功率从 95%提升至 98%

### 用户体验

- **加载速度**：首屏加载从 5 秒降至 2.8 秒，操作响应<200ms
- **进度反馈**：显示"已处理 50/1000 行"，用户投诉减少 40%
- **稳定性**：添加 ErrorBoundary 捕获异常，崩溃率从 0.5%降至<0.1%
