# AI-Chat 对话应用 | 2023.08 - 2024.03

**角色**：核心开发者（开发约 2 万行代码）

**项目背景**：企业级 AI 对话应用，支持多轮对话、流式响应、用户中断等核心功能。日均对话 5000+次，支持 100+并发用户。

## 技术挑战

- **代码组织**：2 万行代码的分层组织（UI/状态/逻辑/服务）
- **流式响应**：AI 流式数据的实时渲染、中断恢复、错误处理
- **状态管理**：对话生命周期的状态流转和异常处理
- **类型扩展**：文本、表格、图表等多种消息类型的渲染

## 🏗️ 代码组织

[📄](resume/assets/gel-workspace/packages/gel-ui/docs/biz/ai-chat/design/architecture-design.md)

### 四层代码分层

- **UI 层**：开发 AIChatApp 容器组件和 20+子组件，支持插槽定制
- **状态层**：封装 useChatBase Hook 管理会话状态，支持 1000+消息/会话
- **逻辑层**：编写 ChatHandler 处理对话流程，通过 HookBus 解耦事件
- **服务层**：实现 Preprocessing/Streaming/Finalize 处理请求生命周期

### 扩展能力

- **流程扩展**：在 Preflight/Streaming/Finalize 阶段注入业务逻辑
- **UI 扩展**：通过 React 插槽配置消息渲染组件
- **数据扩展**：编写自定义解析器处理业务数据格式

## 🧠 对话流程集成

[📄](resume/assets/gel-workspace/packages/gel-ui/docs/biz/ai-chat/requirements/functional-requirements.md)

### 流式响应处理

- **SSE 集成**：接入 Server-Sent Events，首字节响应<2 秒，流式延迟<500ms
- **实时渲染**：通过 EventSource 接收流式数据，逐字符追加到消息内容
- **增量更新**：使用 React.memo 和 useMemo 优化渲染，避免全量重绘
- **缓冲机制**：每 100ms 批量更新 DOM，减少渲染次数，提升流畅度

### 对话状态管理

[📄](resume/assets/gel-workspace/packages/gel-ui/docs/biz/ai-chat/design/message-model-design.md)

- **状态机设计**：实现 idle → pending → streaming → completed → failed 的状态流转
- **上下文管理**：使用 Redux 存储会话历史，支持 1000+消息/会话
- **状态同步**：通过 Redux action 同步消息状态到全局 store
- **持久化**：将会话数据存储到 localStorage，刷新页面后恢复对话

### 用户中断处理

- **中断请求**：通过 AbortController 取消正在进行的 SSE 连接
- **内容保存**：中断时保存已接收的部分内容，标记消息状态为 interrupted
- **重试机制**：支持从中断点继续对话，传递上下文给后端
- **UI 反馈**：显示"已中断"状态，提供"继续"和"重新开始"按钮

### 消息解析

- **类型识别**：定义 BaseMessage 基类，派生 TextMessage/TableMessage/ChartMessage 等子类
- **解析流程**：检测消息类型 → 验证数据格式 → 转换为前端模型
- **错误降级**：解析失败时回退到纯文本渲染，避免白屏
- **组件映射**：根据消息类型映射到对应的渲染组件（TextRenderer/TableRenderer/ChartRenderer）

## � 异常处理与能恢复

### 错误处理

- **分类捕获**：区分网络错误、服务端错误、解析错误，显示不同提示
- **ErrorBoundary**：使用 React ErrorBoundary 捕获组件渲染异常，避免整个应用崩溃
- **降级策略**：AI 服务不可用时，显示"服务繁忙"提示，支持切换到备用模型
- **日志上报**：通过 Sentry 上报错误堆栈和用户操作路径，便于排查问题

### 重试机制

- **自动重试**：网络错误时自动重试 3 次，每次间隔 2 秒
- **指数退避**：重试间隔按 2s、4s、8s 递增，避免服务端压力
- **手动重试**：失败消息显示"重试"按钮，点击后重新发送请求
- **上下文保持**：重试时携带完整的对话历史，保证上下文连贯性

### 连接恢复

- **心跳检测**：每 30 秒发送 ping 消息，检测 SSE 连接是否存活
- **断线重连**：连接断开时自动重连，最多尝试 5 次
- **状态恢复**：重连成功后，从上次中断的消息继续接收数据
- **用户提示**：连接断开时显示"连接已断开，正在重连..."提示

## 📊 量化成果

### 代码质量

- **分层组织**：2 万行代码按 UI/状态/逻辑/服务分层，新功能开发时间从 3 天降至 2 天
- **流式响应**：SSE 首字节响应<2 秒，流式延迟<500ms，支持 1000+消息/会话
- **渲染优化**：使用 React.memo 包裹 15 个组件，重渲染次数减少 70%
- **状态管理**：通过状态机管理对话生命周期，状态流转清晰，bug 率降低 60%

### 对话体验

- **中断响应**：用户点击中断后 200ms 内停止流式输出，响应及时
- **内容保留**：中断时保存已接收内容，用户满意度提升 35%
- **重连成功率**：断线重连成功率达 95%，平均重连时间<3 秒
- **错误恢复**：自动重试机制使对话成功率从 92%提升至 98%

### 稳定性

- **异常捕获**：通过 ErrorBoundary 捕获渲染异常，崩溃率从 0.5%降至<0.1%
- **降级处理**：解析失败时回退到纯文本，白屏率降低 90%
- **日志上报**：Sentry 上报覆盖 95%的错误场景，问题定位时间缩短 70%
