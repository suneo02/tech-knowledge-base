# AI-Chat 智能对话助手 | 2023.08 - 2024.03

**角色**：核心开发者（核心功能实现与架构设计）

**项目背景**：
企业级 AI 助手应用，需处理多轮自然语言对话、实时流式响应，并支持对复杂表格数据进行即时分析与可视化。项目面临长连接稳定性、复杂消息类型渲染及异步任务状态管理的挑战。

**核心技术栈**：React 18 + TypeScript + Redux Toolkit + SSE (Server-Sent Events) + VisTable

## 🏗️ 架构设计

### 1. 四层代码架构
采用分层架构设计，确保业务逻辑与视图层的解耦，提升代码可维护性：
- **UI 层**：构建 `AIChatApp` 容器组件及 20+ 原子组件，通过 `Slot` 模式支持消息渲染组件的动态注入。
- **状态层**：封装 `useChatBase` Hook 与 Redux Slice，统一管理会话列表、消息队列及加载状态。
- **逻辑层**：设计 `ChatHandler` 处理器，通过 `HookBus` 事件总线解耦 UI 交互与底层业务逻辑。
- **服务层**：封装 `Preprocessing/Streaming/Finalize` 请求生命周期，统一处理请求拦截、流式解析与错误重试。

### 2. 消息模型设计
- **多态消息解析**：定义 `BaseMessage` 抽象基类，派生出 `TextMessage`、`TableMessage`、`ChartMessage` 等子类，通过工厂模式实现消息类型的自动识别与解析。
- **渲染映射**：建立消息类型到 React 组件的映射注册表，支持 Markdown、表格、图表等多种格式的混合渲染。

## ⚡️ 核心功能实现

### 3. 稳健的流式响应 (SSE)
- **SSE 客户端封装**：基于 `EventSource` 与 `fetch` API 封装流式请求库，支持 `text/event-stream` 格式的实时解析。
- **打字机效果**：实现基于 `requestAnimationFrame` 的字符缓冲队列，将高频的流式更新平滑渲染为打字机动画，避免 React 频繁 Re-render 导致的性能抖动。
- **连接管理**：
  - **心跳检测**：实现 Keep-Alive 机制，定期发送 ping 消息检测连接活性。
  - **断线重连**：设计指数退避（Exponential Backoff）重连策略，在网络波动时自动尝试恢复连接。
  - **中断控制**：集成 `AbortController`，支持用户随时中断生成过程，并保持已生成的上下文。

### 4. 异步任务轮询 (Task Polling)
- **长耗时任务管理**：针对表格分析等长耗时操作，设计 "提交-轮询-通知" 的异步处理机制。
- **状态机流转**：实现 `useSheetTask` Hook，管理任务从 `pending` -> `processing` -> `completed/failed` 的状态流转。
- **性能优化**：采用自适应轮询间隔策略，根据任务执行时长动态调整轮询频率，减少服务器负载。

### 5. 复杂表格渲染 (VisTable)
- **高性能表格组件**：基于 Canvas/Virtual DOM 混合技术开发 `VisTable` 组件，支持行列冻结、列宽拖拽及百万级单元格的流畅渲染。
- **数据可视化**：集成 ECharts 实现表格数据的即时图表化展示，支持柱状图、折线图、饼图的动态切换。

## 🛡️ 稳定性与工程化

### 6. 异常处理体系
- **全链路错误捕获**：区分网络错误、解析错误与业务异常，提供分级降级策略（如解析失败回退至纯文本）。
- **边界防护**：在核心组件外层包裹 `ErrorBoundary`，防止局部渲染异常导致整个应用崩溃。
- **监控集成**：集成 Sentry SDK，自动捕获并上报前端异常堆栈及用户操作路径，便于问题回溯。

## 📊 技术成果
- **交互流畅度**：流式响应首字节延迟大幅降低，打字机效果平滑无卡顿。
- **功能扩展性**：分层架构使得新增消息类型（如语音、图片）的开发成本降低 50%。
- **稳定性**：通过完善的异常处理与重连机制，显著提升了长对话场景下的会话稳定性。
