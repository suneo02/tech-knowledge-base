## 背景

- 现状：页面/Provider 卸载时未统一终止请求、清空消息与复位 RTK 状态。
- 影响：残留流式更新、重复请求、旧实例消息污染新实例，导致「大纲会话」与「报告详情」在切页后状态异常。

## 改动文件

- `apps\report-ai\src\context\RPOutline.tsx`（Provider 清理）
- `apps\report-ai\src\context\ReportDetail.tsx`（Provider 清理）
- `apps\report-ai\src\store\reportContentStore\hooks\useFullDocGenerationController.ts`（控制器卸载清理）
- `apps\report-ai\src\store\rpOutline\slice.ts`（补充 reset 动作，或采用 batch 恢复）

## 实施步骤

### RPOutlineProvider 卸载清理（大纲会话）

- 在 `useRPOutlineChat` 解构 `cancelRequest` 与 `setMessages`，并在卸载时执行：
  - 终止进行中的请求/流：`cancelRequest()`。
  - 清空会话消息：`setMessages([])`。
- 代码落点：`apps\report-ai\src\context\RPOutline.tsx:38` 引入 `cancelRequest`；在 `return` 之前新增 `useEffect(() => () => { cancelRequest(); setMessages([]); }, [])`（靠近 `apps\report-ai\src\context\RPOutline.tsx:92`）。

### ReportDetailProvider 卸载清理（报告详情）

- 在 `useRPContentChat` 解构 `cancelRequest` 与 `setMessages`，卸载时执行：
  - 终止请求：`cancelRequest()`。
  - 清空消息：`setMsgs([])`。
  - 释放页面级引用：`reportEditorRef.current = null`、`referenceViewRef.current = null`。
- 代码落点：修改解构 `apps\report-ai\src\context\ReportDetail.tsx:34-39` 以包含 `cancelRequest`；在 `return` 之前新增 `useEffect(() => () => { cancelRequest(); setMsgs([]); reportEditorRef.current = null; referenceViewRef.current = null; }, [])`（靠近 `apps\report-ai\src\context\ReportDetail.tsx:67`）。

### 全文生成控制器卸载清理

- 在控制器卸载时撤销/复位生成相关状态：
  - 中断全文生成：`rpDetailActions.interruptFullDocumentGeneration()`。
  - 复位注水任务为 `idle`：`rpDetailActions.setHydrationTask({ type: 'idle' })`。
- 代码落点：在 `apps\report-ai\src\store\reportContentStore\hooks\useFullDocGenerationController.ts:129` 之后新增 `useEffect(() => () => { dispatch(rpDetailActions.interruptFullDocumentGeneration()); dispatch(rpDetailActions.setHydrationTask({ type: 'idle' })); }, [])`。

### Outline Slice 提供 reset（可选优先）

- 在 `rpOutlineSlice` 中新增 `reset` reducer：返回 `createInitialState()`。
- 在 `RPOutlineProvider` 卸载时调度 `rpOutlineActions.reset()`；若暂不新增动作，则用已有 `batchUpdate` 还原关键字段：`files: [], progress: createInitialProgressState(), agentMessages: []`。
- 代码落点：`apps\report-ai\src\store\rpOutline\slice.ts:24-28` 扩展 `reducers`；或在 Provider 中引入 `useAppDispatch` 执行 `batchUpdate`。

## 验证

- 导航离开「大纲会话」或「报告详情」时：
  - 网络/流式请求被终止，控制台不再出现新更新。
  - 新实例挂载后消息列表为空，且不会复用旧会话消息。
  - 全文生成被中断，`globalOp.kind` 复位为 `idle`，`hydration.currentTask` 为 `idle`。
- 回归检查：使用现有 `useEditorDraftSync` 的防抖清理已生效（`apps\report-ai\src\store\reportContentStore\hooks\useEditorDraftSync.ts:142-146`）。

## 回滚与兼容

- 若 `reset` 动作暂不合入，保留 `batchUpdate` 方案，不影响现有选择器与组件逻辑。
- 清理逻辑均在 Provider/控制器本地，卸载即生效，回滚仅需移除对应 `useEffect` 即可。
