# 实施计划：司法风险与经营风险模块扩展

> 所属任务：[司法风险与经营风险模块扩展](./README.md)  
> 文档版本：v1  
> 创建日期：2025-11-11

## 实施策略

- 分阶段实施，先完成配置，再实现交互
- 每个阶段独立测试，确保不影响现有功能
- 优先完成司法风险模块，再完成经营风险模块

## 任务拆解

### 阶段一：类型定义扩展（0.5天）

**负责人**：待分配  
**预计时间**：0.5天  
**关联代码**：`src/components/company/type/corpDetail/CorpTableCfg.ts`

**任务内容**：

1. 扩展 `CorpTableCfg` 类型定义
   - 添加 `maskRedirect?: { url: string; title: string; description: string }` 配置类型
2. 更新类型导出

**验收标准**：

- [ ] 类型定义完整，无 TypeScript 错误
- [ ] 不影响现有类型使用

**关键代码位置**：

```
src/components/company/type/corpDetail/CorpTableCfg.ts
```

---

### 阶段二：司法风险模块配置（1天）✅

**负责人**：已完成  
**预计时间**：1天  
**关联代码**：`src/handle/corpModuleCfg/risk/risk.tsx`

**任务内容**：

1. 新增3个模块配置
   - 股权冻结（`equityfreeze`）
   - 悬赏公告（`rewardnotice`）
   - 限制出境（`exitrestriction`）
2. 调整模块顺序
3. 添加国际化文案
4. 确认统计字段名称

**验收标准**：

- [x] 3个新模块配置完整
- [x] 模块顺序符合需求
- [x] 国际化文案完整（使用临时 ID）
- [x] 统计字段名称正确

**关键代码位置**：

```
src/handle/corpModuleCfg/risk/risk.tsx
```

**配置要点**：

- 使用 `custom: 'MaskRedirect'` 标识蒙版引流类型
- 配置 `maskRedirect` 对象（url、title、description）
- URL 使用协议相对路径 `//riskwebserver/wind.risk.platform/...`
- URL 支持 `{companyCode}` 占位符，运行时动态替换
- 风控链接生成逻辑参考 `packages/gel-util/src/link/out/risk.ts`
- 确认统计字段名称（`modelNum`）

---

### 阶段三：经营风险模块配置（1天）✅

**负责人**：已完成  
**预计时间**：1天  
**关联代码**：`src/handle/corpModuleCfg/bussRisk/bussRisk.tsx`

**任务内容**：

1. 新增5个模块配置
   - 债务逾期（`debtoverdue`）
   - 商票逾期（`commercialoverdue`）
   - 环保信用（`environmentalcredit`）
   - 股权质押（`equitypledge`）
   - 简易注销（`simplecancellation`）
2. 调整现有模块位置
   - 债券违约（`getdefaultbond`）- 已存在，仅调整位置，保持原有功能
   - 非标违约（`getnostandard`）- 已存在，仅调整位置，保持原有功能
3. 调整模块顺序
4. 添加国际化文案
5. 确认统计字段名称

**验收标准**：

- [x] 5个新模块配置完整
- [x] 2个现有模块位置调整正确（保持原有列表功能）
- [x] 模块顺序符合需求
- [x] 国际化文案完整（使用临时 ID）
- [x] 统计字段名称正确

**关键代码位置**：

```
src/handle/corpModuleCfg/bussRisk/bussRisk.tsx
packages/gel-util/src/link/out/risk.ts (风控链接配置)
```

**配置要点**：

- 使用 `custom: 'MaskRedirect'` 标识蒙版引流类型
- 配置 `maskRedirect` 对象（url、title、description）
- URL 使用协议相对路径 `//riskwebserver/wind.risk.platform/...`
- URL 支持 `{companyCode}` 占位符，运行时动态替换
- 风控链接生成逻辑参考 `packages/gel-util/src/link/out/risk.ts`
- 现有模块（债券违约、非标违约）保持原有列表配置

---

### 阶段四：蒙版组件开发（2天）✅

**负责人**：已完成  
**预计时间**：2天  
**关联代码**：`src/components/company/MaskRedirectModal`

**任务内容**：

1. 创建蒙版弹窗组件
   - 组件结构设计
   - 样式实现
   - 交互逻辑
2. 实现跳转链接处理
   - 使用 getRiskOutUrl 函数生成链接
   - 支持 undefined 处理（禁用按钮）
3. 编写组件单元测试
4. 编写 Storybook 文档

**验收标准**：

- [x] 蒙版组件功能完整
- [x] 样式符合设计规范
- [x] 跳转链接生成正确
- [x] 单元测试覆盖完整场景
- [x] Storybook 文档完整

**关键代码位置**：

```
src/components/company/MaskRedirect/
  ├── Card/              # 统计卡片组件
  │   ├── index.tsx
  │   ├── index.module.less
  │   └── index.test.tsx
  ├── Mask/              # 蒙版组件（不可关闭）
  │   ├── index.tsx
  │   ├── index.module.less
  │   └── index.test.tsx
  ├── index.tsx          # 导出文件
  └── MaskRedirect.stories.tsx  # Storybook 文档
```

**组件说明**：

- MaskRedirectCard：展示统计数字的卡片，点击触发蒙版
- MaskRedirectMask：蒙版组件，不可通过点击遮罩关闭，必须点击按钮

---

### 阶段五：模块渲染逻辑改造（1.5天）

**负责人**：待分配  
**预计时间**：1.5天  
**关联代码**：`src/components/company/CompanyBase.tsx`

**任务内容**：

1. 修改模块渲染逻辑
   - 判断 `maskRedirect` 字段
   - 渲染统计类型模块样式
   - 绑定点击事件
2. 集成蒙版组件
   - 管理弹窗状态
   - 传递配置参数
3. 实现跳转逻辑
4. 编写集成测试

**验收标准**：

- [ ] 统计类型模块正确渲染
- [ ] 点击触发蒙版弹窗
- [ ] 跳转链接正确
- [ ] 不影响普通模块渲染
- [ ] 集成测试通过

**关键代码位置**：

```
src/components/company/CompanyBase.tsx
```

---

### 阶段六：左侧菜单配置（1天）✅

**负责人**：已完成  
**预计时间**：1天  
**关联代码**：`src/components/company/layoutConfig/risk.ts`, `src/components/company/layoutConfig/businessRisk.ts`

**任务内容**：

1. 更新司法风险菜单配置（`risk`）
   - 在 `showList` 中添加新模块标识：`equityfreeze`、`rewardnotice`、`exitrestriction`
   - 在 `showName` 中添加对应的国际化名称
   - 在 `numArr` 中添加对应的统计字段名称
   - 调整模块顺序，确保符合需求文档
2. 更新经营风险菜单配置（`businessRisk`）
   - 在 `showList` 中添加新模块标识：`debtoverdue`、`commercialoverdue`、`environmentalcredit`、`equitypledge`、`simplecancellation`
   - 调整现有模块位置：`getdefaultbond`（债券违约）、`getnostandard`（非标违约）
   - 在 `showName` 中添加对应的国际化名称
   - 在 `numArr` 中添加对应的统计字段名称
   - 调整模块顺序，确保符合需求文档
3. 确认统计字段映射关系
   - 与后端确认统计字段名称
   - 确保 `numArr` 中的字段名与 `basicNum` 数据结构一致

**验收标准**：

- [x] 司法风险菜单配置完整，包含3个新模块
- [x] 经营风险菜单配置完整，包含7个新模块
- [x] 模块顺序符合需求文档
- [x] 国际化文案完整（使用临时 ID）
- [x] 统计字段映射正确
- [x] 不影响现有菜单配置

**关键代码位置**：

```
src/views/Company/menu/menus.ts
```

**配置要点**：

- 参考 `layout-left.md` 和 `layout-config.md` 文档
- 菜单配置与模块配置保持一致
- 统计字段名称需要与 `basicNum` 数据结构对应
- 新增模块不在 `corpDetailBaseMenuNumHide` 列表中，需要显示统计数字

**司法风险目标顺序**：
裁判文书 → 立案信息 → 开庭公告 → 送达公告 → 法院公告 → 被执行人 → 失信被执行人 → 终本案件 → 限制高消费 → **股权冻结** → 司法拍卖 → 破产重整 → **悬赏公告** → **限制出境** → 询价评估

**经营风险目标顺序**：
诚信信息 → **债券违约** → **非标违约** → **债务逾期** → **商票逾期** → 欠税信息 → 经营异常 → 严重违法 → **环保信用** → 股权出质 → **股权质押** → 税收违法 → 担保信息 → 知识产权出质 → **简易注销** → 抽查检查

---

### 阶段七：菜单显示优化（1天）

**负责人**：待分配  
**预计时间**：1天  
**关联代码**：`src/views/Company/menu/`

**任务内容**：

1. 确认菜单显示逻辑
   - 统计类型模块在菜单中显示
   - 统计数字显示正确
2. 测试菜单点击行为
   - 点击滚动到对应位置
   - 高亮状态正确
3. 测试不同企业类型
4. 测试不同 type 类型的模块

**验收标准**：

- [ ] 菜单显示完整
- [ ] 统计数字正确
- [ ] 点击行为正常
- [ ] 不同企业类型显示正确

**关键代码位置**：

```
src/views/Company/menu/useCorpMenuByType.ts
src/views/Company/menu/getMenuByCorpType.ts
```

---

### 阶段八：完整测试与上线（2天）

**负责人**：待分配  
**预计时间**：2天

**任务内容**：

1. 功能回归测试
   - 测试所有新增模块
   - 测试现有模块不受影响
   - 测试不同企业类型
   - 测试海外企业、特殊企业
2. 兼容性测试
   - 测试不同浏览器
   - 测试不同分辨率
3. 性能测试
   - 测试页面加载时间
   - 测试菜单渲染性能
4. 准备上线
   - 编写上线文档
   - 准备回滚方案

**验收标准**：

- [ ] 所有功能测试通过
- [ ] 兼容性测试通过
- [ ] 性能测试通过
- [ ] 上线文档完整
- [ ] 回滚方案准备完毕

## 时间规划

| 阶段     | 任务             | 预计时间 | 依赖关系       |
| -------- | ---------------- | -------- | -------------- |
| 阶段一   | 类型定义扩展     | 0.5天    | 无             |
| 阶段二   | 司法风险模块配置 | 1天      | 阶段一         |
| 阶段三   | 经营风险模块配置 | 1天      | 阶段一         |
| 阶段四   | 蒙版组件开发     | 2天      | 阶段一         |
| 阶段五   | 模块渲染逻辑改造 | 1.5天    | 阶段二、三、四 |
| 阶段六   | 左侧菜单配置     | 1天      | 阶段二、三     |
| 阶段七   | 菜单显示优化     | 1天      | 阶段五、六     |
| 阶段八   | 完整测试与上线   | 2天      | 阶段七         |
| **总计** |                  | **10天** |                |

## 关键里程碑

| 里程碑             | 时间点 | 交付物                     |
| ------------------ | ------ | -------------------------- |
| 配置完成           | D3.5   | 所有模块配置完成           |
| 组件开发完成       | D5.5   | 蒙版组件开发完成           |
| 功能开发完成       | D8     | 所有功能开发完成           |
| 测试完成，准备上线 | D10    | 测试通过，上线文档准备完毕 |

## 风险应对

| 风险                     | 应对措施                             | 负责人 |
| ------------------------ | ------------------------------------ | ------ |
| 统计字段名称未确认       | 提前与后端确认，预留调整时间         | 待分配 |
| 风控跳转链接规则未明确   | 提前与产品确认，预留调整时间         | 待分配 |
| 模块顺序调整影响现有功能 | 充分测试，准备回滚方案               | 待分配 |
| 蒙版交互体验不佳         | 与设计师确认交互细节，多轮测试       | 待分配 |
| 开发时间不足             | 优先完成核心功能，次要功能可延后上线 | 待分配 |

## 测试用例

### 功能测试用例

| 用例编号 | 测试场景                 | 预期结果                       |
| -------- | ------------------------ | ------------------------------ |
| TC-001   | 查看司法风险模块         | 新增3个模块，顺序正确          |
| TC-002   | 查看经营风险模块         | 新增7个模块，顺序正确          |
| TC-003   | 查看左侧菜单司法风险     | 新增3个菜单项，顺序正确        |
| TC-004   | 查看左侧菜单经营风险     | 新增7个菜单项，顺序正确        |
| TC-005   | 查看菜单统计数字         | 新增模块统计数字显示正确       |
| TC-006   | 点击菜单项               | 滚动到对应模块                 |
| TC-007   | 点击仅统计模块           | 显示蒙版弹窗                   |
| TC-008   | 点击蒙版"前往查看"       | 跳转至风控对应页面             |
| TC-009   | 点击蒙版"取消"           | 关闭弹窗                       |
| TC-010   | 查看普通模块             | 不受影响，正常展示列表         |
| TC-011   | 菜单与模块配置一致性检查 | 菜单配置与模块配置标识完全一致 |

### 兼容性测试用例

| 用例编号 | 测试场景       | 预期结果         |
| -------- | -------------- | ---------------- |
| TC-101   | 普通企业       | 所有模块正常显示 |
| TC-102   | 海外企业       | 过滤规则正常     |
| TC-103   | 特殊企业       | 过滤规则正常     |
| TC-104   | 个体工商户     | 过滤规则正常     |
| TC-105   | Chrome 浏览器  | 功能正常         |
| TC-106   | Safari 浏览器  | 功能正常         |
| TC-107   | Firefox 浏览器 | 功能正常         |

## 更新记录

| 日期       | 修改人 | 更新内容                                                         |
| ---------- | ------ | ---------------------------------------------------------------- |
| 2025-11-11 | -      | 创建实施计划                                                     |
| 2025-11-11 | -      | 补充阶段六：左侧菜单配置步骤，调整阶段编号                       |
| 2025-11-12 | Kiro   | 完成阶段六：左侧菜单配置                                         |
| 2025-11-12 | Kiro   | 完成阶段二、三：司法风险与经营风险模块配置                       |
| 2025-11-12 | Kiro   | 新增风控链接配置工具（packages/gel-util/src/link/out/risk.ts）   |
| 2025-11-12 | Kiro   | 完成阶段四：蒙版组件开发（Card + Mask，参考 HKCorp 实现）        |
| 2025-11-12 | Kiro   | 完成阶段二：司法风险模块配置                                     |
| 2025-11-12 | Kiro   | 完成阶段三：经营风险模块配置                                     |
| 2025-11-12 | Kiro   | 新增风控链接配置工具（packages/gel-util/src/link/out/risk.ts）   |
| 2025-11-12 | Kiro   | 完成阶段四：蒙版组件开发（MaskRedirectModal + MaskRedirectCard） |
| 2025-11-12 | Kiro   | 集成蒙版组件到 useRenderTableDom，支持自定义渲染                 |
