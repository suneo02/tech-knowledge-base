# DOM 属性直接调用 Constants 问题

## 问题概览

| 字段         | 内容                                                     |
| ------------ | -------------------------------------------------------- |
| 问题         | 代码中直接使用 constants 而非统一的 domAttributes helper |
| 状态         | 🚧 进行中                                                |
| 优先级       | 🟡 P1                                                    |
| 责任人       | -                                                        |
| 发现时间     | 2025-10-22                                               |
| 预期解决时间 | 2025-10-29                                               |

## 背景与预期

项目已建立 `domAttributes.ts` 提供统一的 DOM 属性操作接口，目的是封装底层 constants 细节，提供类型安全和一致性。

## 问题陈述

### 现象

多个模块直接引用 `constants.ts` 中的常量进行 DOM 操作，绕过了统一接口。

### 根因

`domAttributes.ts` 是后期引入的抽象层，早期代码直接使用 constants，且接口未覆盖所有场景。

### 影响

- 维护成本高：修改属性名需全局搜索替换
- 类型安全弱：直接拼接字符串易出错
- 代码不一致：同一操作有多种写法
- 重构困难：无法通过 helper 统一调整行为

## 关键参考

| 文档/代码路径                 | 作用                  | 备注                |
| ----------------------------- | --------------------- | ------------------- |
| `foundation/constants.ts`     | 定义所有 DOM 属性常量 | 应作为内部实现      |
| `foundation/domAttributes.ts` | 提供统一操作接口      | 当前接口不完整      |
| `chapter/render.ts:49-71`     | 直接使用 constants    | 应改用 setAttribute |
| `chapterId/ops.ts:111-146`    | 大量直接属性操作      | 核心重构目标        |

## 解决方案

### 方案要点

1. 扩展 `domAttributes.ts` 接口，补充缺失方法（预计 2 天）
2. 迁移高频使用场景：`chapterId/ops.ts` > `chapter/render.ts` > `chapterOrdinal/ops.ts`（预计 3 天）
3. 添加 ESLint 规则禁止直接导入 `constants.ts`（预计 1 天）

### 备选方案

保持现状仅在新代码中使用 helper - 放弃理由：技术债持续累积

### 待办事项

- [ ] 补充 `domAttributes.ts` 缺失接口
- [ ] 迁移 `chapterId/ops.ts`
- [ ] 迁移 `chapter/render.ts`
- [ ] 添加 ESLint 规则
- [ ] 更新开发文档

## 验证与风险

### 验证步骤

1. 运行单元测试确保 DOM 操作逻辑无变化
2. 手动测试章节创建、拆分、序号更新
3. 验证 ESLint 规则能正确拦截直接引用

### 剩余风险

- 可能存在未被搜索到的间接引用
- helper 增加抽象层，需关注高频操作性能

## 更新日志

| 日期       | 事件 | 描述                             |
| ---------- | ---- | -------------------------------- |
| 2025-10-22 | 创建 | 初始创建，识别问题并制定重构方案 |

## 附录

受影响文件统计：约 40+ 处需要重构

- `chapter/render.ts`: 6 处
- `chapterId/ops.ts`: 12 处
- `chapterOrdinal/ops.ts`: 4 处
- 其他文件: 约 18 处
