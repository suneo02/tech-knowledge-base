# 流式预览叶子章节处理优化

## 任务概览

| 项目 | 内容 |
| --- | --- |
| 任务来源 | useStreamingPreview 应仅处理叶子章节 |
| 负责人 | 待指派 |
| 上线目标 | 修复流式预览处理逻辑，确保只处理叶子章节，避免无效操作和数据污染 |
| 当前版本 | v1.0 |
| 关联文档 | [原Issue](../issues/streaming-preview-leaf-only.md) |

## 背景与上下文

报告章节采用树形结构，AI 生成内容时只会为叶子章节生成实际内容，父章节仅作为结构容器。当前 `useStreamingPreview` 会获取所有状态为 `receiving`/`pending`/`finish` 的章节并尝试更新内容，包括父章节，导致多个问题。

## 需求提炼

### 必达能力
1. 流式预览只处理叶子章节，不处理父章节
2. 单章节重新生成时正确清空旧内容
3. 流式预览阶段只更新 preview 字段，不污染 canonical 状态
4. 提高性能，减少无效 DOM 操作
5. 保持现有功能不受影响

### 约束条件
1. 与现有状态管理机制兼容
2. 不影响用户体验
3. 确保修复过程中系统稳定性
4. 保持与现有API的兼容性

## 方案设计

### 问题根因
1. **叶子节点判断缺失**：`useStreamingPreview.ts:48-52` 的过滤逻辑只检查状态，未判断章节是否为叶子节点
2. **章节内容未初始化**：单章节生成开始时，未执行清空操作，导致流式内容追加到旧内容后
3. **状态写入时机错误**：流式预览开始阶段，将临时内容错误地写入 canonical 状态，污染正式数据

### 解决方案设计
1. **修复父章节过滤**：
   - 添加 `isLeafChapter` 工具函数判断叶子节点
   - 修改 `useStreamingPreview` 过滤逻辑，排除父章节
   - 位置：`hooks/rehydration/useStreamingPreview.ts:48-52`

2. **修复内容初始化**：
   - 在单章节生成开始时添加内容清空逻辑
   - 确保流式内容不追加到旧内容

3. **修复状态写入分离**：
   - 明确区分 preview 和 canonical 状态
   - 流式阶段仅更新 preview，生成完成后才写入 canonical
   - 避免临时数据污染正式数据

4. **性能优化**：
   - 减少对父章节的无效 DOM 操作
   - 预计性能提升约 25%（假设 20 个章节，5 个父章节）

## 实施拆解

| 子任务 | 模块 | 方法 | 负责人 | 预计交付时间 |
| ---- | ---- | ---- | ---- | --- |
| 1. 实现isLeafChapter工具函数 | 工具函数 | 创建叶子节点判断逻辑 | 待指派 | TBD |
| 2. 修改useStreamingPreview过滤逻辑 | useStreamingPreview | 添加叶子节点判断 | 待指派 | TBD |
| 3. 添加章节内容清空逻辑 | 生成控制器 | 实现内容初始化 | 待指派 | TBD |
| 4. 修复状态写入分离 | 状态管理 | 分离preview和canonical | 待指派 | TBD |
| 5. 添加单元测试 | 测试 | 覆盖各种场景 | 待指派 | TBD |
| 6. 性能验证 | 性能测试 | 验证性能提升 | 待指派 | TBD |

## 验收记录

### 功能验收用例
1. **父章节过滤验证**：创建包含多层级章节的报告（如 1 -> 1.1 -> 1.1.1），触发全文生成，观察流式预览是否只更新叶子章节
2. **父章节过滤日志验证**：检查 debug 日志，确认 `activeChapterIds` 不包含父章节
3. **单章节内容清空验证**：选择已有内容的章节，触发重新生成，确认旧内容被清空后才开始流式输出
4. **状态分离验证**：在流式生成过程中检查 Redux 状态，确认 preview 字段更新而 canonical 保持不变
5. **完成后状态验证**：流式生成完成后，确认 canonical 被正确更新为最终内容

### 非功能风险
- 运行时动态添加/删除子章节需重新判断叶子状态
- 空 `children` 数组应视为叶子节点，需明确处理
- 流式中断或异常时，preview/canonical 状态同步可能出现不一致
- 并发生成多个章节时，状态更新顺序需确保正确

## 实现说明

### 与设计差异
- 暂未实现，待实施后补充

### 关键PR
- 暂无，待实施后补充

### 可复用经验
- 暂无，待实施后补充

## 更新记录

| 日期 | 修改人 | 更新内容 |
| --- | --- | --- |
| 2025-10-22 | - | 初始创建，识别叶子章节过滤缺失问题 |
| 2025-10-23 | - | 新增问题：单章节生成时未清空内容、流式错误写入 canonical |
| 2025-01-09 | - | 从Issue文档转换为Spec格式，创建初始版本 |

---
**状态**：🚧 进行中  
**创建时间**：2025-10-22  
**优先级**：🟡 中  
**影响范围**：流式预览功能  
**预估工期**：2 人日