# AI 对话文件引用功能 - 验收文档

[← 返回任务概览](./README.md)

## 1. 功能验收

| 用例                   | 验收标准                                           | 测试步骤                                                    | 状态 |
| ---------------------- | -------------------------------------------------- | ----------------------------------------------------------- | ---- |
| @ 触发文件选择         | 输入 @ 后弹出文件列表                              | 1. 在输入框输入 @<br>2. 验证文件列表弹出                    | ⏳   |
| 选择文件后显示         | 文件名显示在输入框,不显示 fileId                   | 1. 选择文件<br>2. 验证显示文件名<br>3. 验证不显示 ID        | ⏳   |
| 占位符插入             | 选择文件后在 content 中插入 `<file:id name='xxx'>` | 1. 选择文件<br>2. 检查 content 包含正确格式的占位符         | ⏳   |
| 删除文件引用           | 删除文本后,占位符从 content 中移除                 | 1. 删除占位符文本<br>2. 验证 content 更新                   | ⏳   |
| 发送包含文件引用的消息 | content 包含占位符,后端解析 fileId 查询文件信息    | 1. 发送消息<br>2. 验证请求包含占位符<br>3. 验证后端正确解析 | ⏳   |
| 后端解析占位符         | 正确提取 fileId 和引用位置                         | 1. 发送包含占位符的消息<br>2. 验证后端提取正确的 fileId     | ⏳   |
| 多文件引用             | 支持一次对话引用多个文件                           | 1. 引用多个文件<br>2. 验证所有占位符正确插入和解析          | ⏳   |

## 2. 数据约束验收

| 约束项           | 验收标准                                           | 状态 |
| ---------------- | -------------------------------------------------- | ---- |
| fileId 不展示    | 前端 UI 中不显示 fileId,仅显示 fileName            | ⏳   |
| 占位符格式       | 符合 `<file:fileId name='fileName'>` 规范          | ⏳   |
| 消息发送数据     | 包含 content(含占位符) 和 files(上传文件)          | ⏳   |
| 后端解析         | 后端通过解析 content 中的占位符获取引用的 fileId   | ⏳   |
| 无 refFiles 字段 | 前端不传递 refFiles,文件引用信息完全通过占位符传递 | ⏳   |

## 3. 非功能验收

| 项目     | 验收标准                       | 状态 |
| -------- | ------------------------------ | ---- |
| 性能     | 占位符解析耗时 <100ms          | ⏳   |
| 兼容性   | 兼容现有文件上传功能           | ⏳   |
| 测试覆盖 | 单元测试覆盖率 ≥80%            | ⏳   |
| 代码质量 | 通过 ESLint 和 TypeScript 检查 | ⏳   |

## 4. 用户路径验收

### 4.1 基础引用流程

1. 用户在输入框输入 @
2. 系统展示文件列表
3. 用户选择文件 "报告.pdf"
4. 输入框显示 "报告.pdf",content 包含 `<file:abc123 name='报告.pdf'>`
5. 用户继续输入 "请分析这个文件"
6. 用户点击发送
7. 后端接收到 content: "请分析 <file:abc123 name='报告.pdf'> 这个文件"
8. 后端解析出 fileId: "abc123"
9. 后端查询文件信息并构建上下文
10. AI 基于文件内容生成回复

### 4.2 多文件引用流程

1. 用户输入 "对比 @ 和 @"
2. 选择第一个文件 "报告A.pdf"
3. 继续输入,选择第二个文件 "报告B.pdf"
4. content 包含两个占位符
5. 发送后后端正确解析两个 fileId
6. AI 基于两个文件内容生成对比分析

## 5. 边界情况验收

| 场景                   | 预期行为                        | 状态 |
| ---------------------- | ------------------------------- | ---- |
| 占位符格式错误         | 后端忽略错误格式,不影响正常处理 | ⏳   |
| fileId 不存在          | 后端返回友好错误提示            | ⏳   |
| 空 content             | 正常发送,不包含文件引用         | ⏳   |
| 仅包含占位符的 content | 正常解析和处理                  | ⏳   |

## 更新记录

| 日期       | 修改人 | 更新内容   |
| ---------- | ------ | ---------- |
| 2025-11-18 | Kiro   | 初始化验收 |

## 相关

- [实施计划](./spec-implementation-plan-v1.md)
- [测试规范](../../rule/testing-rule.md)
