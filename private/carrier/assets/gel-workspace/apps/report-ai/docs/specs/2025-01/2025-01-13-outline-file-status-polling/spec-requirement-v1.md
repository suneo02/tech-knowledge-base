# 大纲文件解析状态轮询 - 需求分析 v1

> 回链：[任务概览](./README.md)  
> 状态：🚧 设计中

## 背景

用户在大纲会话中可以上传文件和引用文件，这些文件需要后端解析处理。解析过程需要时间，用户需要实时了解文件处理状态。

当前问题：

- 文件上传后状态不更新
- 用户不知道文件是否解析完成
- 无法判断文件解析失败

## 用户场景

| 场景编号 | 用户操作             | 期望结果                       | 优先级 |
| -------- | -------------------- | ------------------------------ | ------ |
| S1       | 上传文件到大纲会话   | 自动开始轮询，显示"解析中"     | P0     |
| S2       | 文件正在解析         | 实时更新解析进度               | P0     |
| S3       | 文件解析完成         | 显示"已完成"，停止轮询         | P0     |
| S4       | 文件解析失败         | 显示错误信息，停止轮询         | P0     |
| S5       | 同时上传多个文件     | 分别显示每个文件的解析状态     | P0     |
| S6       | 切换到其他页面后返回 | 显示最新的文件状态             | P1     |
| S7       | 刷新页面             | 恢复轮询，继续更新未完成的文件 | P1     |

## 功能需求

### 核心功能

1. **自动轮询**

   - 文件上传后自动开始轮询
   - 轮询间隔 3 秒
   - 只轮询未完成的文件

2. **状态更新**

   - 实时更新文件状态到消息中
   - 支持 `files` 和 `refFiles` 两种类型
   - 状态包括：待处理、处理中、已完成、失败

3. **停止条件**
   - 所有文件解析完成
   - 所有文件解析失败
   - 用户离开页面（可选）

### 非功能需求

- 性能：只轮询必要的文件，减少 API 请求
- 可靠性：支持错误重试（3 次）
- 用户体验：防抖处理，避免频繁更新

## 约束条件

- 复用现有 `useFileStatusPolling` Hook
- 不修改现有文件状态 API
- 保持与报告详情文件轮询的一致性

## 相关文档

- [大纲会话设计](../../RPOutline/design.md)
- [文件状态轮询设计](../../shared/file-status-polling.md)

## 更新记录

| 日期       | 修改人 | 更新内容        |
| ---------- | ------ | --------------- |
| 2025-01-13 | Kiro   | 创建需求分析 v1 |
