# 方案设计 - 文本 AI 重写

> 📖 回链：[任务概览](./README.md) | 阶段：方案设计

## 设计概览

- 通过选区快照与状态机控制改写流程，避免 TinyMCE 编辑器内的直接注水。
- 新增的悬浮预览组件仅作为外部呈现层，确认后一次性替换正文内容。
- 与章节级生成共享消息通道与全局状态，减少新增状态的复杂度。

## 模块拆分

### 1. 选区采集与快照

- 在 `ReportEditor` 的触发回调内读取 TinyMCE 选区、上下文与 DOM 矩形，整理为 `SelectionSnapshot` 并回传给外部流程。
- `useReportEditorRef` 保持只读引用，不再扩展额外能力；所有选区操作在编辑器回调闭包内完成。
- 快照结构包含选区范围、文本内容、上下文摘要与定位信息，用于预览定位与失败恢复。
- 验证规则：正文区域内的 10-2000 字符，需包含前后各 100 字符的上下文摘要；若不满足则直接在回调内终止流程。

### 2. 改写会话调度

- 复用 `globalOperation` 状态机，新增 `text_rewrite` kind，确保与其他 AIGC 操作互斥。
- Hook `useTextRewrite` 负责发起请求、监听消息与状态收敛，统一提供 `startRewrite`、`abortRewrite`、`rejectRewrite`、`confirmRewrite`、`reset`。
- 失败或拒绝时需要清理状态、还原快照，并返回可见的错误信息。

### 3. 流式消息解析

- 基于 `sendRPContentMessage` 与现有解析器处理流式返回。
- 维护当前会话的消息缓冲与完成信号，完成时触发一次性替换。
- 避免在消息解析阶段操作 DOM，只更新预览数据。
- 在开始生成前主动清空 `setMessages([])`，避免上一轮消息残留；结束或拒绝时同步清理缓存。
- 与 `useStreamingPreview` 保持隔离：通过 correlationId 与消息类型判定，禁止将改写流式消息注入 TinyMCE。

### 4. 预览对接

- 改写主流程仅传递“预览内容 + 快照引用”，渲染与定位细节迁移至 [悬浮预览组件方案](../text-ai-rewrite-preview-floating/spec-preview-floating-v1.md)。
- 预览组件向主流程回调“应用 / 取消”动作，保证双向解耦。
- 若预览组件不可用或定位失败，主流程降级为常规文本对话窗提示。

### 5. 会话清理策略

- 将“中止流式请求”“用户拒绝”“用户确认”拆分为独立动作，并在 Hook 中暴露对应入口。
- 中止（abort）：终止后端流式请求、清理订阅与预览占位，不触发 DOM 替换。
- 拒绝（reject）：在生成完成后用户拒绝应用，需还原快照、撤销脏标记、释放状态。
- 确认（confirm）：执行替换后再统一清理预览、消息缓存与状态锁。
- 在任意入口开始改写前先执行一次 `reset()`，确保上一轮残留（消息、预览、锁）被完全清除。

## 关键流程

### 改写启动

1. 调用 `reset()`，清理上一轮消息、预览与状态锁。
2. 用户触发改写 → `ReportEditor` 回调采集选区与上下文并回传。
3. 校验选区范围与章节归属，不符合条件时提示重新选择。
4. 生成唯一的 `correlationId` 并写入 `globalOperation`，锁定全局状态。
5. 发送改写请求，同时将快照与初始占位数据推送给预览组件。

### 预览与确认

1. 流式消息推进时，仅更新预览数据；首条消息用于提醒用户保持等待。
2. 预览组件在生成完成后展示“应用 / 取消”，并透传用户决策。
3. 用户点击“应用” → 主流程替换选区内容、触发 `hasDirty`、释放状态。
4. 用户点击“取消” → 终止消息监听、恢复快照、释放状态。

### 快照恢复

- 快照在 60 秒内有效，过期后需提示用户重新选区。
- 恢复流程为：还原 bookmark → 回写原始文本 → 重置光标。

## 决策与取舍

- **外部预览而非编辑器注水**：避免 TinyMCE 内容在生成中被频繁修改，降低脏数据风险。
- **共用全局状态机**：减少新的 store 结构，直接沿用章节级生成的状态切面。
- **一次性替换策略**：保持 DOM 操作简单，可回退。
- **严格隔离流式注水**：通过消息路由隔绝 `useStreamingPreview`，避免误写 TinyMCE。

## 风险与降级

1. **选区失效**：若用户手动修改内容或超时，提醒重新发起改写，并清理当前会话。
2. **消息解析异常**：捕获异常后回退快照，保留已生成内容供手动复制。
3. **预览不可用**：降级展示 Toast + 对话窗，提示用户复制改写结果；详见预览 Spec。
4. **流式误注入**：若检测到 `useStreamingPreview` 仍在写入 TinyMCE，立即停止预览并记录警告日志，要求前端确认依赖配置。

## 相关文档

- [文本 AI 重写场景](../../RPDetail/ContentManagement/text-ai-rewrite-flow.md)
- [AIGC 核心流程](../../RPDetail/ContentManagement/aigc-core-flow.md)
- [悬浮预览组件方案](../text-ai-rewrite-preview-floating/spec-preview-floating-v1.md)

## 更新记录

| 日期       | 修改人 | 更新内容                                    |
| ---------- | ------ | ------------------------------------------- |
| 2025-11-04 | Codex  | 增补会话清理/消息隔离设计，明确选区回调职责 |
| 2025-11-03 | Kiro   | 添加预览组件按钮设计（取消/应用）           |
| 2025-10-30 | Kiro   | 修改预览方式为悬浮组件                      |
| 2025-10-29 | Kiro   | 精简至 150 行                               |
