# 章节编号节点被 TinyMCE 过滤问题修复

## 任务概览

| 项目 | 内容 |
| --- | --- |
| 任务来源 | 章节编号节点在 setContent 时被 TinyMCE 过滤 |
| 负责人 | 待指派 |
| 上线目标 | 修复章节编号节点被过滤问题，确保章节编号正常显示 |
| 当前版本 | v1.0 |
| 关联文档 | [原Issue](../issues/archived/chapter-number-node-filtered-fix.md) |
| 状态 | ✅ 已完成 |

## 背景与上下文

`createTitleHtml` 生成的章节编号节点应该在通过 `editor.setContent()` 注入到 TinyMCE 时正常显示，保存时由 `contentSanitizer` 移除。但实际使用中发现，编号节点（`<span data-gel-external="chapter-number">1.2.3 </span>`）在 `setContent` 时被过滤掉，页面中看不到编号。

## 需求提炼

### 必达能力
1. 章节编号节点在 setContent 时不被过滤
2. 章节编号在编辑器中正常显示
3. 保存时由 contentSanitizer 正确移除编号节点
4. 保持现有功能不受影响

### 约束条件
1. 不影响现有功能
2. 保持用户体验一致
3. 确保修复过程中系统稳定性
4. 与现有状态管理机制兼容

## 方案设计

### 问题根因
编号节点包含 `data-mce-bogus="1"` 属性，TinyMCE 在 `setContent` 时会自动过滤带此属性的节点。这是因为 `data-mce-bogus` 是 TinyMCE 的内部属性，用于标记应该被忽略的内容。

### 解决方案设计
1. **移除编号节点的 `data-mce-bogus` 属性**：从章节编号节点的属性定义中移除该属性
2. **保持 `data-gel-external` 属性**：继续使用该属性标记为外部渲染节点，确保保存时能被正确识别和移除
3. **保存时由 `contentSanitizer` 移除编号节点**：确保保存时外部渲染节点被正确清理

## 实施拆解

| 子任务 | 模块 | 方法 | 负责人 | 预计交付时间 |
| ---- | ---- | ---- | ---- | --- |
| 1. 移除data-mce-bogus属性 | chapterNumberNode.ts | 修改编号节点属性定义 | 已完成 | 2025-02-14 |
| 2. 验证编号显示 | 测试 | 验证编号正常显示 | 已完成 | 2025-02-14 |
| 3. 验证保存时移除 | 测试 | 验证保存时正确移除 | 已完成 | 2025-02-14 |

## 验收记录

### 功能验收用例
1. **编号显示验证**：调用 createTitleHtml 生成 HTML，通过 setContent 注入编辑器，验证编号显示正常
2. **保存时移除验证**：调用 getCleanContentForExport，验证编号被正确移除
3. **多级编号验证**：验证多级章节编号（如 1.2.3）显示正常
4. **编辑保存验证**：验证编辑后保存，编号节点被正确移除

### 非功能风险
- 无明显风险，修复方案简单可靠

## 实现说明

### 与设计差异
- 完全按照设计方案实现，无差异

### 关键PR
- 暂无，待补充

### 可复用经验
1. 不要滥用 TinyMCE 的内部属性（如 data-mce-bogus）
2. 外部渲染节点应该在业务层清洗，而不是依赖编辑器自动过滤
3. 充分理解工具的行为再使用，避免隐式依赖

## 更新记录

| 日期 | 修改人 | 更新内容 |
| --- | --- | --- |
| 2025-02-14 | - | 发现并解决章节编号节点被过滤问题 |
| 2025-01-09 | - | 从Issue文档转换为Spec格式，创建初始版本 |

---
**状态**：✅ 已完成  
**创建时间**：2025-02-14  
**优先级**：🔴 高  
**影响范围**：章节编号显示  
**预估工期**：0.5 人日  
**实际工期**：0.5 人日