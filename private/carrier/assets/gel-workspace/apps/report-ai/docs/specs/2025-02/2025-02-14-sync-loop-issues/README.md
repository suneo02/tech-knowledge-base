# 章节同步死循环问题修复

## 任务概览

| 项目 | 内容 |
| --- | --- |
| 任务来源 | 章节ID维护和编号更新的死循环，导致浏览器卡死 |
| 负责人 | AIGC前端组 |
| 上线目标 | 修复章节ID维护和编号更新的死循环问题，确保浏览器正常运行 |
| 当前版本 | v1.0 |
| 关联文档 | [原Issue](../issues/archived/sync-loop-issues.md) |
| 状态 | ✅ 已完成 |

## 背景与上下文

报告编辑器需要自动维护章节 ID（`data-section-id`）和章节编号（如 1.1, 1.2.1），使用两个 Class 通过 MutationObserver 监听 DOM 变化并自动同步。

然而，当前实现中 `findChapterNumberNode` 使用 `querySelector` 查找所有后代节点，导致编号节点嵌套；同时 `SectionIdMaintainer` 修改 DOM 触发 `ChapterNumberCoordinator` 的 MutationObserver，形成死循环，导致章节标题内部出现嵌套的编号节点，章节 ID 和编号的更新逻辑不断触发，导致浏览器卡死。

## 需求提炼

### 必达能力
1. 修复章节ID维护和编号更新的死循环问题
2. 解决编号节点嵌套问题
3. 确保章节标题编号正常显示
4. 保证浏览器不卡死，用户能正常编辑
5. 维护现有功能不受影响

### 约束条件
1. 不影响现有功能
2. 保持用户体验一致
3. 确保修复过程中系统稳定性
4. 与现有状态管理机制兼容
5. 不引入新的性能问题

## 方案设计

### 问题根因
1. **编号节点嵌套问题**：`findChapterNumberNode` 使用 `querySelector` 查找所有后代节点，导致编号节点嵌套
2. **死循环问题**：`SectionIdMaintainer` 修改 DOM 触发 `ChapterNumberCoordinator` 的 MutationObserver，形成死循环
3. **缺乏防重入机制**：两个 Class 都没有防重入标记，导致循环触发
4. **MutationObserver性能问题**：两个 MutationObserver 性能开销较大

### 解决方案设计
**核心思路**：修改查找逻辑和添加防重入标记，避免死循环和编号嵌套。

1. **修改查找逻辑**：
   - 修改 `findChapterNumberNode`，只查找直接子节点
   - 避免查找所有后代节点导致的编号节点嵌套

2. **添加防重入标记**：
   - 为 `SectionIdMaintainer` 添加 `syncing` 防重入标记
   - 为 `ChapterNumberCoordinator` 添加 `syncing` 防重入标记
   - 在处理DOM变化时检查标记，避免循环触发

3. **优化性能**：
   - 减少不必要的DOM操作
   - 优化MutationObserver的使用

## 实施拆解

| 子任务 | 模块 | 方法 | 负责人 | 预计交付时间 |
| ---- | ---- | ---- | --- | --- |
| 1. 修改查找逻辑 | domain/reportEditor/shared | findChapterNumberNode | 已完成 | 2025-02-14 |
| 2. 添加防重入标记 | domain/reportEditor/domOperations | SectionIdMaintainer | 已完成 | 2025-02-14 |
| 3. 添加防重入标记 | domain/reportEditor/editor | ChapterNumberCoordinator | 已完成 | 2025-02-14 |
| 4. 测试验证 | test | 死循环测试 | 已完成 | 2025-02-14 |
| 5. 性能优化 | performance | DOM操作优化 | 已完成 | 2025-02-14 |

## 验收记录

### 功能验收用例
1. **章节创建验证**：创建多个章节，验证编号正常显示
2. **章节编辑验证**：编辑章节，验证浏览器不卡死
3. **控制台日志验证**：检查控制台日志，确认无循环触发
4. **复杂结构验证**：创建复杂的章节结构，验证编号正确
5. **性能测试**：测试大量章节场景，确认性能可接受

### 非功能风险
- 当前方案复杂度高，建议函数式重构
- 两个 MutationObserver 性能开销较大
- 防重入标记可能影响某些正常操作

## 实现说明

### 与设计差异
- 完全按照设计方案实现，无差异

### 关键PR
- 暂无，待补充

### 可复用经验
1. 防重入标记是解决循环触发问题的有效方法
2. 精确的DOM查询可以避免意外的节点嵌套
3. 复杂的DOM操作需要特别注意性能问题
4. 函数式重构可以简化复杂的状态管理

## 更新记录

| 日期 | 修改人 | 更新内容 |
| --- | --- | --- |
| 2025-02-14 | AIGC前端组 | 修复编号嵌套和死循环问题 |
| 2025-02-14 | AIGC前端组 | 添加防重入标记，优化查找逻辑 |
| 2025-01-09 | - | 从Issue文档转换为Spec格式，创建初始版本 |

## 后续建议

### 函数式重构
- 用纯函数替代两个 Class
- 用一个 Hook 统一管理 DOM 监听
- 只创建一个 MutationObserver
- 性能提升约 50%，代码量减少约 40%

---
**状态**：✅ 已完成  
**创建时间**：2025-02-14  
**优先级**：🔴 高  
**影响范围**：章节ID维护、章节编号、DOM同步功能  
**预估工期**：1 人日  
**实际工期**：1 人日