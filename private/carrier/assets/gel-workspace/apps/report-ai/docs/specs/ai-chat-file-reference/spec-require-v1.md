# AI 对话文件引用功能 - 需求文档

[← 返回任务概览](./README.md)

## 1. 背景与上下文

在 AI 对话场景中,用户需要引用特定文件作为上下文,以便 AI 能够基于文件内容进行回答。当前缺少一种用户友好的方式来在对话中引用文件,同时保持文件 ID 与显示名称的分离。

### 业务目标

- 提升用户体验:通过 @ 文件的方式快速引用文件
- 保持数据完整性:文件 ID 不暴露给用户,但需要传递给后端
- 支持多文件引用:一次对话可以引用多个文件

### 既有能力

- 已支持文件上传功能 @see apps/report-ai/src/components/ChatCommon/Sender
- 已实现 @ 触发建议菜单 @see apps/report-ai/src/components/ChatCommon/Sender/hooks/useFileSuggestion.ts
- 已有文件管理机制 @see apps/report-ai/src/components/ChatCommon/Sender/hooks/useChatFileManager.ts

## 2. 核心功能需求

| 场景     | 用户操作               | 系统行为                         | 优先级 |
| -------- | ---------------------- | -------------------------------- | ------ |
| 引用文件 | 输入 @ 触发文件选择    | 展示文件列表供选择               | P0     |
| 显示文件 | 选择文件后             | 输入框显示文件名,内部存储占位符  | P0     |
| 编辑问句 | 修改文本或删除文件引用 | 同步更新占位符                   | P0     |
| 发送消息 | 点击发送按钮           | 提取占位符位置,发送给后端        | P0     |
| 后端解析 | 接收消息               | 解析占位符获取文件 ID 和引用位置 | P0     |
| 多文件   | 引用多个文件           | 支持在同一消息中引用多个不同文件 | P0     |

## 3. 数据约束

- 文件 ID 不在 UI 中展示,仅在内部数据结构中维护
- 占位符格式:`<file:fileId name='fileName'>`,其中 fileId 为文件唯一标识,fileName 为显示名称
- 文件引用信息完全通过占位符传递,无需单独的 refFiles 数组

## 4. 非功能需求

- 性能:占位符解析不应影响消息发送速度
- 兼容性:需兼容现有的文件上传功能
- 可维护性:占位符格式应易于扩展

## 更新记录

| 日期       | 修改人 | 更新内容   |
| ---------- | ------ | ---------- |
| 2025-11-18 | Kiro   | 初始化需求 |

## 相关

- [设计文档](./spec-design-v1.md)
- [需求规范](../../rule/require-doc.md)
