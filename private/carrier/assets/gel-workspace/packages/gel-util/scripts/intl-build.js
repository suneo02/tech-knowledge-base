const { spawnSync } = require('child_process')
const fs = require('fs')
const path = require('path')

const projectRoot = path.resolve(__dirname, '..')
const localesDir = path.join(projectRoot, 'src/intl/locales')

/**
 * Executes a command with the given arguments.
 * @param {string} command
 * @param {string[]} args
 */
function runCommand(command, args) {
  console.log(`\n> ${command} ${args.join(' ')}`)
  const result = spawnSync(command, args, {
    cwd: projectRoot,
    stdio: 'inherit',
    encoding: 'utf-8',
    // shell: true is removed to avoid issues with spaces in executable paths on Windows
  })

  if (result.status !== 0) {
    console.error(`\nCommand failed with exit code ${result.status}`)
    process.exit(result.status)
  }
}

// Use current node executable to run sub-scripts
const nodePath = process.execPath

console.log('Starting intl build workflow...')

const sources = [
  { js: 'iml_cn.js', json: 'iml_cn.json' },
  { js: 'iml_en.js', json: 'iml_en.json' },
]

// 1. intl:migrate-locale
// Converts .js locale files to .json files.
// Note: This script WILL DELETE the source JS files after conversion, as requested.
console.log('\n[Step 1/3] Migrating locale files...')
const migrateArgs = ['scripts/migrate-locale-to-json.js', ...sources.map((s) => `src/intl/locales/${s.js}`)]
runCommand(nodePath, migrateArgs)

// 2. intl:entry2json
// Adds/Updates entries in the .json files.
console.log('\n[Step 2/3] Processing entry2json...')
runCommand(nodePath, ['scripts/intlTools/entry2Json.js'])

// 3. intl:split
// Splits the large .json files into smaller chunks.
console.log('\n[Step 3/3] Splitting locale json...')
runCommand(nodePath, ['scripts/jsonTools/split-locale-json.js'])

// 4. Cleanup
// Deletes the intermediate .json artifacts generated by the previous steps.
// The source JS files were already deleted by Step 1.
console.log('\n[Cleanup] Removing intermediate artifacts...')
sources.forEach((src) => {
  const filePath = path.join(localesDir, src.json)
  if (fs.existsSync(filePath)) {
    try {
      fs.unlinkSync(filePath)
      console.log(`Deleted: ${src.json}`)
    } catch (error) {
      console.error(`Failed to delete ${src.json}:`, error)
    }
  }
})

console.log('\nWorkflow completed successfully.')
