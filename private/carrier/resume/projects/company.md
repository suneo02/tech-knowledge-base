# 项目档案：企业详情页重构 (Company Detail Page Refactor)

> **文档定位**：本项目档案包含 **[白皮书 (Dossier)]** 与 **[口述脚本 (Script)]** 两部分。
> - **白皮书**：全景技术方案、决策权衡、量化成果与事故复盘（作为事实来源）。
> - **口述脚本**：针对面试场景的 1 分钟 Hook、STAR 深度叙事与防御性问答策略。

---

# 第一部分：深度白皮书 (Dossier)

## 0. 受众与用途

- **受众**：我自己，面试复盘与深挖准备
- **用途**：复盘企业详情页重构的决策、实现与结果，便于面试时按问题快速回忆证据链
- **叙述人称**：第一人称（我）

## 1. 全景（Situation & Task）

- **业务背景**：企业详情页是分析师的核心工作台，汇聚工商、财务、司法、舆情等 50+ 业务维度；旧版代码耦合高，特殊企业类型（IPO、基金、海外）需要大量分支判断，新增或改动一个维度会波及全页。
- **架构描述**（文字，包含组件关系与数据流）：我把页面拆成配置引擎、滚动状态管理、渲染层三段式流程；数据源提供企业基础信息、企业类型/地区、模块统计数据；配置引擎按类型合成菜单与模块清单，再交给渲染层按滚动状态分段加载，滚动状态由状态管理统一驱动菜单高亮与模块请求。
- **技术选型对比**（文字）：我选择配置化驱动替代硬编码分支，代价是需要维护配置元数据与合成规则，但换来跨企业类型的复用；我选择滚动按需加载替代一次性加载，牺牲了首屏完整性但换来首屏接口数可控；我用集中式状态管理配合帧级节流替代原本的被动监听，换来更稳定的滚动联动，代价是实现复杂度上升。
- **边界与非目标**：我不改动上游数据源与接口协议，不改变业务模块的业务逻辑，只处理展示层的可配置化与性能。
- **证据锚点**：《company.md》/private/carrier/resume/projects/company.md/1.1 业务背景；《company.md》/private/carrier/resume/projects/company.md/1.3 技术选型决策表

## 2. 设计文档引用与要点（必须）

- **设计文档名称/版本**：《company.md》/2023.06 - 至今
- **设计文档路径**（关键条目即可）：private/carrier/resume/projects/company.md
- **关键章节引用**（章节标题 + 关联要点）：
  - 1.2 架构视图：核心引擎、输入源、渲染层的关系与滚动同步
  - 2. 核心功能实现：配置驱动与长列表性能策略
  - 3. 核心难点攻坚：配置合成与滚动性能的具体问题与结果

## 3. 核心功能与实现（Action - Construction）

- **功能 1：配置驱动 UI**
  - 我定义统一的模块元数据（包含数据依赖、展示方式、可见条件），以企业类型与地区为策略入口合成菜单与模块清单，再基于模块统计数据过滤无数据项，减少人工分支。
- **功能 2：长列表滚动性能优化**
  - 我把非可视区模块以固定高度占位，滚动进入视口再请求和渲染；同时以滚动方向与速度计算预加载阈值，控制首屏接口数量。
- **功能 3（可选）：菜单与内容联动**
  - 我将滚动位置信息统一为数值映射，避免在高频滚动中重复读 DOM，保证菜单高亮与内容定位一致。
- **实现流程**（文字步骤）：
  - 读取企业基础信息与类型，生成配置合成策略
  - 合成模块清单并过滤无数据模块
  - 渲染层按滚动阈值分段加载模块
  - 滚动状态更新菜单高亮与模块请求
- **数据结构**（文字字段说明）：
  - 模块元数据包含：模块标识、数据依赖字段、展示策略、权限条件、默认占位高度
  - 企业信息包含：企业类型、地区、基础信息与模块统计数据
- **复杂度说明**：
  - 配置化带来策略与元数据维护成本，滚动按需加载引入更多状态与边界处理，但把长列表 DOM 规模与首屏请求量控制在可预测范围。
- **证据锚点**：《company.md》/private/carrier/resume/projects/company.md/2. 核心功能实现

## 4. 个人执行与成果（Action & Result）

- **执行范围与边界**：我主导展示层的配置化改造与滚动性能改造，边界是不触碰上游接口协议与业务计算逻辑。
- **关键决策与执行**：
  - 我选择配置合成策略替代大量分支判断，降低多类型企业的维护成本，代价是需要建设配置元数据与校验。
  - 我选择滚动按需加载替代一次性全量请求，把首屏接口数控制在 5 个以内。
  - 我选择帧级节流同步滚动状态，避免高频滚动导致掉帧。
- **量化结果与证据锚点**：
  - 首屏接口数从 50+ 降至 5 个以内；证据锚点：《company.md》/private/carrier/resume/projects/company.md/1.3 技术选型决策表
  - 滚动脚本执行时间从 30ms/帧降至 2ms/帧，FPS 稳定 58-60；证据锚点：《company.md》/private/carrier/resume/projects/company.md/3. 核心难点攻坚
  - TODO：补充首屏 TTI 基线、灰度窗口与监控来源（如前端监控面板）

## 5. 深挖案例（Action - Optimization & Result）

- **现象**：用户快速拖拽滚动条时，菜单高亮延迟，页面掉帧。
- **排查过程**：我分析高频滚动回调，发现回调内存在 DOM 位置读取导致同步布局；滚动频率达到每秒 100+ 次，性能不稳定。
- **方案 V1（失败）**：直接降低滚动事件触发频率，缓解掉帧但导致菜单高亮滞后，用户体验变差。
- **方案 V2（最终）**：
  - 初始化阶段一次性读取模块位置并建立数值映射
  - 滚动时只做数值计算，不读 DOM
  - 状态更新对齐到帧级节流
- **关键机制说明**（不贴代码，1-3 条）：
  - 读写分离，避免高频滚动触发布局抖动
  - 帧对齐更新，避免无效的状态更新
- **量化结果**：脚本执行时间从 30ms/帧降至 2ms/帧，FPS 稳定在 58-60
- **回滚条件**：若菜单高亮与内容位置出现持续 200ms 以上错位，则回退到低频滚动监听并放宽高亮阈值
- **证据锚点**：《company.md》/private/carrier/resume/projects/company.md/3. 核心难点攻坚

## 6. 过程记录（可选）

- **关键里程碑**：
  - 完成配置元数据与合成规则设计
  - 上线滚动按需加载与帧级节流
- **重要权衡与取舍**：
  - 配置化需要额外校验与测试，但减少了多类型企业的分支爆炸
  - 按需加载牺牲“首屏全量展示”，换来首屏稳定与滚动性能
- **交付节奏或流程改进**：
  - 引入配置完整性校验，减少遗漏导致的空白页
- **证据锚点**：《company.md》/private/carrier/resume/projects/company.md/4. 事故与反思

## 7. 事故复盘（可选）

- **时间线**：上线后出现特定企业页面空白
- **根因**：某特殊企业标识触发白名单过滤，但该类型在配置表中缺失模块项，过滤后为空
- **行动项**：
  - 增加配置完整性校验，保证所有特殊类型均有非空配置
  - 增加降级逻辑：过滤结果为空时自动展示基础工商信息，避免白屏
- **证据锚点**：《company.md》/private/carrier/resume/projects/company.md/4. 事故与反思

## 8. 知识库（Legacy）

- **片段 1**（文字说明）：高频滚动场景应预先建立位置映射，滚动时避免任何 DOM 读取
- **片段 2**（文字说明）：配置化系统必须配套完整性校验与降级兜底，避免极端企业类型导致空白页
- **注意事项**：需要补充监控来源与灰度窗口，确保后续优化可量化复盘
- **证据锚点**：《company.md》/private/carrier/resume/projects/company.md/4. 事故与反思

## 9. 质量协议清单

- [x] 证据锚点检查（已更新路径）
- [x] 文字化检查（无代码块）
- [x] 逻辑检查（技术选择与业务关联）
- [x] 第一人称叙述检查（我...）

---

# 第二部分：面试口述脚本 (Script)

- **定位**：面试口述脚本 & 答辩思维导图
- **基线版本**：2023.06 - 至今 | 核心开发

## 1. 叙事构建逻辑 (Narrative Construction)

### 模块一：电梯演讲 (The Hook / 1 min)

**[业务背景]** 这是一个聚合了工商、财务、司法等 50 多个维度的企业数据详情页，是投资分析师的核心工作台。
**[核心职责]** 我主导了**配置化驱动架构**的重构和**长列表性能优化**。
**[最大痛点]** 随着业务发展，我们要支持 IPO、基金、海外等多种特殊企业类型，旧代码里存在大量硬编码判断（如 `if-else`），导致维护成本极高；同时 50 多个模块一次性加载导致首屏压力巨大。
**[解决方案]** 我设计了一套**配置合成策略**实现 UI 与逻辑解耦，并引入了**基于滚动视口的按需加载**与**帧级节流同步**机制。
**[最终收益]** 实现了首屏接口数从 50+ 到 5 个的量化下降，滚动脚本执行耗时从 30ms 降至 2ms，FPS 稳定在 58-60。

### 模块二：STAR 深度复盘 (The Deep Dive)

#### S (Background / 场景痛点)
*   **复杂度高**：单页面包含 50+ 业务模块，每个模块有独立的交互逻辑。
*   **差异化大**：不同企业类型（如 IPO、基金）展示维度完全不同，导致老代码中条件分支爆炸。
*   **性能瓶颈**：全量加载导致 DOM 节点过多且并发请求过载。

#### T (Task / 限制条件)
*   **可维护性**：需要一套架构兼容所有企业类型，消除冗余分支。
*   **性能体验**：保证长列表在快速滚动下的流畅度，首屏加载需保持在可控范围内。

#### A (Action / 关键决策与行动)

**1. 配置驱动重构**
*   **策略合成**：我定义了模块元数据 Schema，采用“基础配置 + 类型/地区特有配置”的合成策略，替代了原本的硬编码判断。
*   **动态过滤**：根据后端返回的统计数据（`basicNum`）自动隐藏无数据模块，进一步减少冗余渲染。

**2. 滚动性能攻坚**
*   **模块级懒加载**：非可视区模块使用 Skeleton 占位，进入视口再挂载并触发请求。
*   **读写分离与帧对齐**：针对菜单联动导致的掉帧，我将模块 OffsetTop 一次性缓存，滚动中仅进行数值比对，并使用 `requestAnimationFrame` 确保高亮更新对齐浏览器渲染帧。

#### R (Result / 结果与收益)
*   **研发效能**：[占位：例如新增类型开发周期缩短 %]
*   **性能指标**：首屏接口数降低了约 90%（由 50+ 降至 5），滚动 FPS 稳定在 60 帧附近。
*   **代码质量**：彻底消除了业务代码中的类型判断陷阱。

## 2. 防御性推演 (Defensive Strategy)

### 策略 A：技术选型质疑 (Trade-off)
*   **Trigger**：为什么不直接按组件开发？配置化是否增加了复杂度？
*   **A (脚本)**：虽然配置化在初期增加了元数据定义的成本，但对于需要支持 IPO、基金、海外等持续增加的企业类型的业务来说，它将维护成本从 O(N) 降低到了 O(1)。

### 策略 B：深度原理挖掘 (Under the Hood)
*   **Trigger**：这里的懒加载和成熟的虚拟列表库（如 react-window）有什么区别？
*   **A (脚本)**：常规虚拟列表库通常处理等高或有规律的列表项。由于我们的业务模块高度差异巨大且内部逻辑复杂，我采用了**模块级按需加载**，侧重于减少并发请求和降低初始渲染开销，而非单纯的 DOM 复用。

### 策略 C：不足与反思 (Deficiency & Pivot)
*   **Trigger**：这个系统上线后遇到过什么问题？
*   **A (脚本)**：遇到过特定企业页面空白。**Root Cause** 是配置表中漏配了该类型。**改进**：我引入了 Build 阶段的配置扫描脚本，并在运行时增加了自动降级显示基础工商信息的兜底逻辑。

## 3. 模拟对练 (Simulation)

*   **Round 1**：如何应对滚动时由于图片加载导致的模块高度变化？（答：使用 ResizeObserver 实时更新位置映射缓存。）
*   **Round 2**：如何处理锚点跳转？（答：初始化时根据 URL Hash 优先渲染目标模块，利用 `scrollIntoView` 联动。）
